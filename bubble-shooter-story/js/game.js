BUBBLE={},BUBBLE.Background=function(t,e,i,s,o){Phaser.BitmapData.call(this,game,"",game.width,game.height),this.bgImg=game.make.image(0,0,"main_menu_backgr"),this.bgImg.anchor.setTo(.5,0),this.middleImg=game.make.image(0,0,"bg_middle"),this.middleImg.anchor.setTo(0,0),this.middleImg.alpha=.5,this.drawMiddleImg=!0},BUBBLE.Background.prototype=Object.create(Phaser.BitmapData.prototype),BUBBLE.Background.constructor=BUBBLE.Background,BUBBLE.Background.prototype.refreshBitmapData=function(){this.resize(game.width,game.height),this.bgImg.height=game.height,this.bgImg.scale.x=2,this.bgImg.width=this.bgImg.width<game.width?game.width:this.bgImg.width,this.draw(this.bgImg,.5*this.width,0),this.middleImg.height=game.height,this.drawMiddleImg&&this.draw(this.middleImg,-game.world.bounds.x,0)},BUBBLE.Background.prototype.addImgToWorld=function(t,e){t&&this.bgImg.loadTexture(t),this.drawMiddleImg=!e,this.refreshBitmapData();var i=this.addToWorld(0,0);return i.fixedToCamera=!0,BUBBLE.events.onScreenResize.add(this.refreshBitmapData,this),i},BUBBLE.Boot=function(t){},BUBBLE.Boot.prototype={init:function(){var t,e,i=!!(e=(t=(t||navigator.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/))&&e[1];game.ie10=navigator.userAgent.indexOf("MSIE 10.0")>-1,game.device.iPad||game.device.desktop?BUBBLE.config.setConfig("hd"):i&&parseFloat(i)<4.4?BUBBLE.config.setConfig("ssd"):BUBBLE.config.setConfig("sd"),this.input.maxPointers=1,this.stage.backgroundColor=16777215,game.time.advancedTiming=!0,game.tweens.frameBased=!0,this.stage.disableVisibilityChange=!1,this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0,this.scaleGameSizeUpdate=function(){var t=window.innerWidth/window.innerHeight,e=game.state.getCurrentState(),i=BUBBLE.l(640),s=BUBBLE.l(960),o=BUBBLE.l(3e3);if(!e.NOTRESIZABLE){if(e.GAMESTATE)if(t>1.18){BUBBLE.horizontal=!0;var a=BUBBLE.l(1135),n=Math.max(a,Math.floor(s*t));game.scale.setGameSize(n,s);var h=Math.min(BUBBLE.l(-310),Math.floor(-.5*(n-i)));game.world.setBounds(h,0,n,1e4)}else{BUBBLE.horizontal=!1;var r=BUBBLE.l(1050),l=Math.max(r,Math.floor(i*(window.innerHeight/window.innerWidth))),B=(n=Math.max(i,Math.floor(r*t)),r-game.height-BUBBLE.l(90));game.scale.setGameSize(n,l),game.world.setBounds(Math.floor(-.5*(n-i)),B,n,1e4)}else t<.66?(game.scale.setGameSize(i,Math.floor(window.innerHeight/window.innerWidth*i)),game.world.setBounds(0,0,i,Math.floor(window.innerHeight/window.innerWidth*i))):(game.scale.setGameSize(game.math.clamp(Math.floor(s*t),i,o),s),game.world.setBounds(Math.floor(-.5*(game.width-i)),0,game.width,s));BUBBLE.events&&BUBBLE.events.onScreenResize.dispatch(game.width,game.height)}},game.incentivise=!0,game.resizeGame=this.scaleGameSizeUpdate,this.scale.onSizeChange.add(this.scaleGameSizeUpdate),this.scale.setResizeCallback((function(){BUBBLE.old_w==window.innerWidth&&BUBBLE.old_h==window.innerHeight||(BUBBLE.old_w=window.innerWidth,BUBBLE.old_h=window.innerHeight,game.resizeGame())}))},preload:function(){var t=BUBBLE.config.current,e=navigator.userAgent.indexOf("iPad")>-1||"hd"===t?"-HD":"";game.load.text("assets","assets/json/assets.json"),game.load.text("levels","assets/json/levels.json"),game.load.text("settings","assets/json/settings.json"),game.load.text("languages","assets/json/languages.json"),game.load.image("logo","assets/"+t+"/images/logo"+e+("ja"===window.sgSettings.config.env.locale?"_ja.png":".png")),game.load.image("teddy","assets/"+t+"/images/teddy.png")},create:function(){BUBBLE.settings=JSON.parse(game.cache.getText("settings")),BUBBLE.assets=JSON.parse(game.cache.getText("assets")),BUBBLE.levels=JSON.parse(game.cache.getText("levels")).levels,BUBBLE.worlds=JSON.parse(game.cache.getText("levels")).worlds,BUBBLE.langdata=JSON.parse(game.cache.getText("languages")),BUBBLE.langdata.current=window.sgSettings.config.env.locale,BUBBLE.txt=function(t){return this.langdata[this.langdata.current][t]},BUBBLE.saveState.load(),this.state.start("Preloader")}},BUBBLE.utils={},BUBBLE.utils.lengthdir_x=function(t,e,i){return(i=i||!1)?Math.cos(t)*e:Math.cos(game.math.degToRad(t))*e},BUBBLE.utils.lengthdir_y=function(t,e,i){return(i=i||!1)?Math.sin(t)*e:Math.sin(game.math.degToRad(t))*e},BUBBLE.utils.lerp=function(t,e,i){return t+i*(e-t)},BUBBLE.utils.formatTime=function(t){var e=Math.floor(t/60);return e+":"+("0"+(t-60*e)).slice(-2)},BUBBLE.pause=!1,BUBBLE.events={onBubbleShoot:new Phaser.Signal,onBubblePutToGrid:new Phaser.Signal,onBubblePopOut:new Phaser.Signal,outOfBubbles:new Phaser.Signal,onBubbleDestroyed:new Phaser.Signal,onBubbleOutOfGrid:new Phaser.Signal,onBubblesMatch:new Phaser.Signal,onBubblesPopOut:new Phaser.Signal,onPopOutDestroyed:new Phaser.Signal,onGoalAchieved:new Phaser.Signal,onWindowOpened:new Phaser.Signal,onWindowClosed:new Phaser.Signal,onCoinsChange:new Phaser.Signal,onLivesChange:new Phaser.Signal,onMoveDone:new Phaser.Signal,onScreenResize:new Phaser.Signal,requestDestroy:new Phaser.Signal,onShieldDefeated:new Phaser.Signal,onGhostFree:new Phaser.Signal,onAnimalFree:new Phaser.Signal,onCellingChange:new Phaser.Signal,onBubbleStartBounce:new Phaser.Signal,onBubbleFinishBounce:new Phaser.Signal,onChangeLevel:new Phaser.Signal,onBoosterBought:new Phaser.Signal,onOpenBoosterStrip:new Phaser.Signal,onCloseBoosterStrip:new Phaser.Signal,useOfbomb:new Phaser.Signal,useOfmulticolor:new Phaser.Signal,useOfaim:new Phaser.Signal,useOfextraMoves:new Phaser.Signal,onShooterMovesCountUp:new Phaser.Signal,fxCircleParticle:new Phaser.Signal,fxBlastCircleParticle:new Phaser.Signal,fxMatchParticle:new Phaser.Signal,fxCloudParticle:new Phaser.Signal,fxChameleonColorChange:new Phaser.Signal,clear:function(){Object.keys(this).forEach((function(t){this[t].removeAll&&this[t].removeAll()}),this)}},BUBBLE.config={configs:{hd:1,sd:.6,ssd:.4},current:0,multiplier:1,setConfig:function(t){this.multiplier=this.configs[t],this.current=t}},BUBBLE.l=function(t){return Math.floor(t*BUBBLE.config.multiplier)},BUBBLE.lnf=function(t){return t*BUBBLE.config.multiplier},BUBBLE.saveState={makeNewDataObject:function(){return{coins:BUBBLE.settings.coinsOnStart,levels:[],bomb:BUBBLE.settings.boostersOnStart,multicolor:BUBBLE.settings.boostersOnStart,aim:BUBBLE.settings.boostersOnStart,extraMoves:BUBBLE.settings.boostersOnStart,mute:!1}},getStars:function(t){return this.data.levels[t]?this.data.levels[t]:0},passLevel:function(t,e){var i;return this.data.levels[t]?this.data.levels[t]<e&&(i=(e-this.data.levels[t])*BUBBLE.settings.coinsForStar,this.data.coins+=i,this.data.levels[t]=e,this.save()):(this.data.levels[t]=e,i=e*BUBBLE.settings.coinsForStar,this.data.coins+=i,this.save()),i},getCoins:function(){return this.data.coins},getBooster:function(t){return this.data[t]},getLives:function(){return this.data.lives},isUnlocked:function(t){return t<=this.data.levels.length},isEnoughToBuy:function(t){return t<=this.data.coins},isEnoughToBuyBooster:function(t){return BUBBLE.settings["costOf"+t]<=this.data.coins},buyBooster:function(t){this.changeCoins(-BUBBLE.settings["costOf"+t]),this.data[t]++,this.save()},getLastLevel:function(){return Math.min(this.data.levels.length,BUBBLE.levels.length-1)},changeCoins:function(t){this.data.coins+=t,this.data.coins=Math.max(0,this.data.coins),BUBBLE.events.onCoinsChange.dispatch(this.data.coins),this.save()},decreaseBooster:function(t){this.data[t]--,this.save()},save:function(){sgSdk.trigger("save",{key:"bubble-shooter-story1",value:JSON.stringify(this.data)})},load:function(){sgSdk.trigger("restore",{key:"bubble-shooter-story1",callback:function(t,e){this.data=e?JSON.parse(e):this.makeNewDataObject()}},this)}},BUBBLE.checkSheet=function(t){return game.cache.getFrameData("ssheet").getFrameByName(t)?"ssheet":game.cache.getFrameData("explosionsheet").getFrameByName(t)?"explosionsheet":game.cache.getFrameData("shieldsheet").getFrameByName(t)?"shieldsheet":game.cache.getFrameData("bubblesheet").getFrameByName(t)?"bubblesheet":game.cache.getFrameData("tutsheet").getFrameByName(t)?"tutsheet":""},Phaser.GameObjectCreator.prototype.imageL=function(t,e,i){var s=BUBBLE.checkSheet(i);return""==s?game.make.image(BUBBLE.l(t),BUBBLE.l(e),i):game.make.image(BUBBLE.l(t),BUBBLE.l(e),s,i)},Phaser.GameObjectCreator.prototype.spriteL=function(t,e,i){var s=BUBBLE.checkSheet(i);return""==s?game.make.sprite(BUBBLE.l(t),BUBBLE.l(e),i):game.make.sprite(BUBBLE.l(t),BUBBLE.l(e),s,i)},Phaser.GameObjectCreator.prototype.bitmapTextL=function(t,e,i,s,o,a){return game.make.bitmapText(BUBBLE.l(t),BUBBLE.l(e+5),i,s,BUBBLE.l(o),a)},Phaser.GameObjectCreator.prototype.buttonL=function(t,e,i,s,o,a,n,h,r){var l=game.make.button(BUBBLE.l(t),BUBBLE.l(e),null,s,o,a,n,h,r);return l.loadTexture("ssheet",i),l},Phaser.GameObjectFactory.prototype.imageL=function(t,e,i){var s=BUBBLE.checkSheet(i);return""==s?game.add.image(BUBBLE.l(t),BUBBLE.l(e),i):game.add.image(BUBBLE.l(t),BUBBLE.l(e),s,i)},Phaser.GameObjectFactory.prototype.spriteL=function(t,e,i){var s=BUBBLE.checkSheet(i);return""==s?game.add.sprite(BUBBLE.l(t),BUBBLE.l(e),i):game.add.sprite(BUBBLE.l(t),BUBBLE.l(e),s,i)},Phaser.GameObjectFactory.prototype.bitmapTextL=function(t,e,i,s,o,a){return game.add.bitmapText(BUBBLE.l(t),BUBBLE.l(e+5),i,s,BUBBLE.l(o),a)},Phaser.GameObjectFactory.prototype.buttonL=function(t,e,i,s,o,a,n,h,r){var l=game.add.button(BUBBLE.l(t),BUBBLE.l(e),null,s,o,a,n,h,r);return l.loadTexture("ssheet",i),l},Phaser.RectangleL=function(t,e,i,s){return new Phaser.Rectangle(BUBBLE.l(t),BUBBLE.l(e),BUBBLE.l(i),BUBBLE.l(s))},BUBBLE.BottomFx=function(){Phaser.Image.call(this,game,0,0,null),this.anchor.setTo(.5),this.kill(),this.updateFunction=function(){}},BUBBLE.BottomFx.prototype=Object.create(Phaser.Image.prototype),BUBBLE.BottomFx.constructor=BUBBLE.BottomFx,BUBBLE.BottomFx.prototype.update=function(){this.alive&&this.updateFunction()},BUBBLE.BottomFx.prototype.updateEmpty=function(){},BUBBLE.BottomFx.prototype.init=function(t){this.x=t.x,this.y=t.y,this.alpha=1,this.scale.setTo(1),this.updateFunction=this.updateEmpty,this.revive()},BUBBLE.BottomFx.prototype.initCircleParticle=function(t){this.init(t),this.scale.setTo(0),this.loadTexture("bubblesheet","bubble_hit_particle"),this.updateFunction=this.updateCircleParticle},BUBBLE.BottomFx.prototype.updateCircleParticle=function(){this.scale.setTo(this.scale.x+.06),this.scale.x>.75&&(this.alpha=1-2*(this.scale.x-.75),this.alpha<=0&&this.kill())},BUBBLE.BottomFxLayer=function(){Phaser.Group.call(this,game),BUBBLE.events.fxCircleParticle.add(this.initCircleParticle,this),BUBBLE.events.fxBlastCircleParticle.add(this.initBlastCircleParticle,this)},BUBBLE.BottomFxLayer.prototype=Object.create(Phaser.Group.prototype),BUBBLE.BottomFxLayer.constructor=BUBBLE.BottomFxLayer,BUBBLE.BottomFxLayer.prototype.initCircleParticle=function(t){var e=this.getFirstDead();null!=e&&e.initCircleParticle(t)},BUBBLE.BottomFxLayer.prototype.initBlastCircleParticle=function(t){var e=this.getFirstDead();null!=e&&e.initBlastCircleParticle(t)},BUBBLE.BottomFxLayer.prototype.init=function(t){this.grid=t,t.ghostMode&&(this.update=function(){this.x=this.grid.x,this.y=this.grid.y,this.rotation=this.grid.rotation,this.forEachAlive((function(t){t.update()}))});for(var e=0;e<20;e++)this.add(new BUBBLE.BubbleFx)},BUBBLE.Bubble=function(t,e,i,s,o){Phaser.Sprite.call(this,game,i,s,null),this.anchor.setTo(.5),this.cell=new Phaser.Point(t,e),this.cellX=t,this.cellY=e,this.orgX=i,this.orgY=s,this.type=o,this.checked=!1,this.bounceable=!0,this.bombResistant=!1,this.special=!1,this.animated=!1,this.collCircle=new Phaser.Circle(i,s,BUBBLE.l(58)),this.duringBounce=!1,this.velX=0,this.velY=0,this.pullX=0,this.pullY=0,this.gridPosition=new Phaser.Point(i,s),this.outsidePosition=new Phaser.Point(i,s)},BUBBLE.Bubble.prototype=Object.create(Phaser.Sprite.prototype),BUBBLE.Bubble.constructor=BUBBLE.Bubble,BUBBLE.Bubble.prototype.isMatchingType=function(t){return this.type==t},BUBBLE.Bubble.prototype.clearCheck=function(){this.checked=!1},BUBBLE.Bubble.prototype.checkType=function(t){return!this.checked&&(this.checked=!0,this.isMatchingType(t))},BUBBLE.Bubble.prototype.onPreciseHit=function(t){},BUBBLE.Bubble.prototype.onHit=function(){},BUBBLE.Bubble.prototype.onMatchHit=function(){},BUBBLE.Bubble.prototype.getWorldPosition=function(){return this.grid.cellToOutsidePx(this.cellX,this.cellY)},BUBBLE.Bubble.prototype.getWorldAngle=function(){return null===this.parent?0:this.parent.angle+this.angle},BUBBLE.Bubble.prototype.startBounce=function(t,e){this.bounceable&&(BUBBLE.events.onBubbleStartBounce.dispatch(this),this.duringBounce=!0,this.velX=.2*t,this.velY=.2*e)},BUBBLE.Bubble.prototype.update=function(){this.alive&&this.bounceUpdate()},BUBBLE.Bubble.prototype.bounceUpdate=function(){this.duringBounce&&this.alive&&(this.x+=this.velX,this.y+=this.velY,this.velX*=.9,this.velY*=.9,this.pullX=-.2*(this.x-this.orgX),this.pullY=-.2*(this.y-this.orgY),this.x+=this.pullX,this.y+=this.pullY,Math.abs(this.velX)<.1&&Math.abs(this.velY)<.1&&Math.abs(this.x-this.orgX)<1&&Math.abs(this.y-this.orgY)<1&&(this.x=this.orgX,this.y=this.orgY,this.duringBounce=!1,BUBBLE.events.onBubbleFinishBounce.dispatch(this)))},BUBBLE.Bubble.prototype.onMatch=function(){this.update=this.onMatchUpdate,this.grid.moveToMatchGroup(this),BUBBLE.events.fxMatchParticle.dispatch(this),BUBBLE.events.fxCircleParticle.dispatch(this)},BUBBLE.Bubble.prototype.onMatchUpdate=function(){this.scale.setTo(this.scale.x+.02),this.alpha-=.05,this.alpha<0&&this.destroy()},BUBBLE.Bubble.prototype.onPopOut=function(){this.update=this.popOutUpdate,this.gravity=BUBBLE.lnf(.25),this.initVelX=BUBBLE.lnf(4),this.initVelY=BUBBLE.lnf(-5),this.minX=BUBBLE.l(40),this.maxX=BUBBLE.l(600),this.velX=-.5*this.initVelX+Math.random()*this.initVelX,this.velY=Math.random()*this.initVelY,this.grid.moveToPopOutGroup(this)},BUBBLE.Bubble.prototype.popOutUpdate=function(){if(this.alive){if(this.x+=this.velX,this.y+=this.velY,this.velY+=this.gravity,this.angle+=this.velX,this.x<this.minX||this.x>this.maxX){game.sfx["hit_"+game.rnd.between(1,3)].play();var t=this.x<this.minX?this.minX-this.x:this.maxX-this.x;this.x=game.math.clamp(this.x,this.minX,this.maxX)+t,this.velX*=-1}this.collCircle.x=this.x,this.collCircle.y=this.y,this.y>game.camera.y+game.height+this.collCircle.radius&&(BUBBLE.events.onPopOutDestroyed.dispatch(this),this.destroy())}},BUBBLE.BubbleRegular=function(t,e,i,s,o){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","bubble_"+o)},BUBBLE.BubbleRegular.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleBomb=function(t,e,i,s){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","bubble_bomb"),this.type="bomb"},BUBBLE.BubbleBomb.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleBomb.prototype.onPopOut=function(){game.sfx.explosion_2.play(),this.grid.moveToMatchGroup(this),BUBBLE.events.fxBlastCircleParticle.dispatch(this);var t=this.getWorldPosition(),e=game.add.sprite(t[0],t[1],"explosionsheet","explosion_0");e.animations.add("explode",["explosion_0","explosion_1","explosion_2","explosion_3","explosion_4","explosion_5","explosion_6","explosion_7","explosion_8","explosion_9","explosion_10","explosion_11"],40).onComplete.add((function(){e.destroy()})),e.anchor.setTo(.5),e.play("explode"),e.scale.setTo(1.5),this.destroy()},BUBBLE.BubbleBomb.prototype.getToPopOut=function(){var t=[];return Array.prototype.concat(this,this.grid.getNeighbours(this.cellX,this.cellY),this.grid.getOuterRing(this.cellX,this.cellY)).forEach((function(e){e.bombResistant||t.push(e)})),t},BUBBLE.BubbleGhost=function(t,e,i,s,o){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","ghost_01"),this.animations.add("idle",["ghost_01","ghost_02","ghost_03","ghost_04","ghost_03","ghost_02","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01","ghost_01"],30,!0),this.play("idle"),this.bombResistant=!0,this.bounceable=!1,this.special=!0,this.animated=!0,this.type="GHOST"},BUBBLE.BubbleGhost.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleGhost.prototype.checkType=function(){return!1},BUBBLE.BubbleGhost.prototype.onPopOut=function(){},BUBBLE.BubbleAnimal=function(t,e,i,s){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","bubble_animal_"+game.rnd.between(0,2)),this.special=!0,this.animated=!1,this.bombResistant=!0,this.type="ANIMAL"},BUBBLE.BubbleAnimal.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleAnimal.prototype.checkType=function(){return!1},BUBBLE.BubbleAnimal.prototype.onPopOut=function(){this.update=this.popOutUpdate,BUBBLE.events.onAnimalFree.dispatch(),this.grid.moveToPopOutGroup(this)},BUBBLE.BubbleAnimal.prototype.popOutUpdate=function(){this.scale.setTo(this.scale.x+.05),this.alpha-=.03,this.alpha<=0&&this.destroy()},BUBBLE.BubbleCloud=function(t,e,i,s,o){"r"==o&&(o=game.rnd.between(0,5).toString()),BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","cloud_0"),this.angle=360*Math.random(),this.special=!0,this.animated=!1,this.type=o,this.covered=!0},BUBBLE.BubbleCloud.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleCloud.prototype.onPopOut=function(){this.grid.ghostMode||this.onHit(),this.update=this.popOutUpdate,this.gravity=BUBBLE.lnf(.25),this.initVelX=BUBBLE.lnf(4),this.initVelY=BUBBLE.lnf(-5),this.minX=BUBBLE.l(40),this.maxX=BUBBLE.l(600),this.velX=-.5*this.initVelX+Math.random()*this.initVelX,this.velY=Math.random()*this.initVelY,this.grid.moveToPopOutGroup(this)},BUBBLE.BubbleCloud.prototype.onHit=function(){this.covered&&(this.loadTexture("bubblesheet","bubble_"+this.type),this.covered=!1,BUBBLE.events.fxCloudParticle.dispatch(this),this.parent==this.grid&&(this.grid.orderCacheAfterUpdate=!0))},BUBBLE.BubbleCloud.prototype.onMatch=function(){this.update=this.onMatchUpdate,this.grid.moveToMatchGroup(this),this.onHit(),BUBBLE.events.fxMatchParticle.dispatch(this),BUBBLE.events.fxCircleParticle.dispatch(this)},BUBBLE.BubbleCloud.prototype.onMatchHit=function(){this.onHit()},BUBBLE.BubbleBlocker=function(t,e,i,s){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","bubble_blocker"),this.special=!0,this.type="black",this.angle=360*Math.random()},BUBBLE.BubbleBlocker.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleBlocker.prototype.checkType=function(){return!1},BUBBLE.BubbleMonster=function(t,e,i,s,o){BUBBLE.Bubble.apply(this,arguments),this.loadTexture("bubblesheet","bubble_monster"),this.special=!0,this.type="monster",this.animated=!0,this.eyes=[],this.makeEye(-15,2,0),this.makeEye(15,2,1),this.makeEye(0,-20,2),this.grid=o,this.eyesOpen=0,this.ghostMode="Ghost"==this.grid.lvl.mode,this.bubbleWorldPosition=this.getWorldPosition(),this.closeEyesIn=-1,this.bombResistant=!0,this.active=!0,BUBBLE.events.onMoveDone.add((function(t){this.alive&&this.active&&(this.possibleColors=t,this.bubbleWorldPosition=this.getWorldPosition(),(this.y>game.camera.y-game.world.bounds.y||this.grid.ghostMode)&&this.onMoveDone())}),this)},BUBBLE.BubbleMonster.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleMonster.prototype.checkType=function(){return!1},BUBBLE.BubbleMonster.prototype.onMoveDone=function(){this.eyesOpen++,this["eye"+(this.eyesOpen-1)+"open"].play(),3==this.eyesOpen&&(this.eyesOpen=0,this.closeEyesIn=30,this.putThreeBubbles())},BUBBLE.BubbleMonster.prototype.update=function(){this.bounceUpdate(),this.closeEyesIn>0&&0==--this.closeEyesIn&&(this.eye0close.play(),this.eye1close.play(),this.eye2close.play())},BUBBLE.BubbleMonster.prototype.makeEye=function(t,e,i){var s=game.make.spriteL(t,e,"monster_eyelid_2");s.anchor.setTo(.5),this["eye"+i+"open"]=s.animations.add("open",["monster_eyelid_2","monster_eyelid_1","monster_eyelid_0","empty"],20),this["eye"+i+"close"]=s.animations.add("close",["monster_eyelid_1","monster_eyelid_2","monster_eyelid_3"],20),this.eyes[i]=s,this.addChild(s)},BUBBLE.BubbleMonster.prototype.putThreeBubbles=function(){var t=this.getSpacesToPut(),e=this.possibleColors;if(0!=e.length){var i=[];t.forEach((function(t){var s=Math.floor(Math.random()*e.length),o=this.grid.makeBubble(t[0],t[1],e[s]);i.push(o)}),this),i.forEach((function(t){t.grid.moveToNonCacheGroup(t),t.alpha=0,t.update=function(){this.alpha+=.04,this.alpha>=1&&(this.alpha=1,this.grid.moveToCacheGroup(this),this.update=BUBBLE.Bubble.prototype.update)};var e=t.getWorldPosition();BUBBLE.events.fxCircleParticle.dispatch({x:e[0],y:e[1]})}))}},BUBBLE.BubbleMonster.prototype.getSpacesToPut=function(){var t,e,i,s,o,a,n=[];if(this.ghostMode){e=(t=this.grid.children).length;for(var h=0;h<20&&(i=t[Math.floor(Math.random()*e)],!((s=this.grid.getFreeSpacesAround(i.cellX,i.cellY)).length>0&&(o=Math.floor(Math.random()*s.length),(a=this.grid.cellToOutsidePx(s[o][0],s[o][1]))[0]>this.grid.closeToEdgeBorder&&a[0]<BUBBLE.l(640)-this.grid.closeToEdgeBorder&&a[1]>this.grid.closeToEdgeBorder&&a[1]<this.grid.maxY-this.grid.closeToEdgeBorder&&this.checkIfSpaceNotRepeat(n,s[o])&&(n.push(s[o]),3==n.length))));h++);}else{var r=Math.floor(this.bubbleWorldPosition[0]/this.grid.cellH);if(0==(e=(t=this.grid.getBubblesInRange(this.cellY-r,this.cellY+10)).length))return;for(h=0;h<20&&(i=t[Math.floor(Math.random()*e)],!((s=this.grid.getFreeSpacesAround(i.cellX,i.cellY)).length>0&&(o=Math.floor(Math.random()*s.length),this.checkIfSpaceNotRepeat(n,s[o])&&(n.push(s[o]),3==n.length))));h++);}return n},BUBBLE.BubbleMonster.prototype.checkIfSpaceNotRepeat=function(t,e){var i=!0;return t.forEach((function(t){t[0]==e[0]&&t[1]==e[1]&&(i=!1)})),i},BUBBLE.BubbleMonster.prototype.popOutUpdate=function(){this.scale.setTo(this.scale.x+.05),this.alpha-=.03,this.alpha<=0&&this.destroy()},BUBBLE.BubbleMonster.prototype.onHit=function(t){"bomb"==t.type&&this.onPopOut()},BUBBLE.BubbleMonster.prototype.onPopOut=function(){this.update=this.popOutUpdate,this.active=!1,this.grid.moveToPopOutGroup(this)},BUBBLE.BubbleBlackHole=function(t,e,i,s,o){BUBBLE.Bubble.apply(this,arguments),this.blackholeImg=game.add.image(0,0,"bubblesheet","bubble_blackhole"),this.blackholeImg.anchor.setTo(.5),this.blackholeImg.angle=360*Math.random(),this.addChild(this.blackholeImg),this.special=!0,this.animated=!0,this.destructable=!1,this.bombResistant=!0,this.type="blackhole",this.hp=3,this.dying=!1,this.bubbles=[],this.scaleVel=0},BUBBLE.BubbleBlackHole.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleBlackHole.prototype.checkType=function(){return!1},BUBBLE.BubbleBlackHole.prototype.update=function(){this.blackholeImg.angle+=.5,this.dying?(this.scale.setTo(this.scale.x-.04),this.scale.x<=0&&this.destroy()):(this.blackholeImg.scale.setTo(Math.max(1,this.blackholeImg.scale.x+this.scaleVel)),this.scaleVel=game.math.clamp(this.scaleVel-.08,-.01,.01)),this.bubbles.forEach(this.processBubbleImposter,this)},BUBBLE.BubbleBlackHole.prototype.onPreciseHit=function(t){if("bomb"==t.type)return this.dying=!0,void this.grid.moveToPopOutGroup(this);this.makeBubbleImposter(t),this.hp--,t.kill(),0==this.hp&&this.onPopOut()},BUBBLE.BubbleBlackHole.prototype.processBubbleImposter=function(t){t.alive&&(t.velX*=.9,t.velY*=.9,t.velX+=-.15*t.x,t.velY+=-.15*t.y,t.x+=t.velX,t.y+=t.velY,t.scale.setTo(t.scale.x-.01),t.scale.x<.002&&(t.kill(),this.hp),this.scaleVel+=.001)},BUBBLE.BubbleBlackHole.prototype.makeBubbleImposter=function(t){var e=t.worldPosition.x-this.worldPosition.x,i=t.worldPosition.y-this.worldPosition.y,s=new Phaser.Point(e,i);s.rotate(0,0,-1*this.parent.rotation);var o=new Phaser.Point(t.velX,t.velY);o.rotate(0,0,-1*this.parent.rotation);var a=game.make.image(s.x,s.y,"bubblesheet","bubble_"+t.type);a.anchor.setTo(.5),a.velX=o.x,a.velY=o.y,this.bubbles.push(a),this.addChild(a)},BUBBLE.BubbleBlackHole.prototype.trueDestroy=BUBBLE.BubbleBlackHole.prototype.destroy,BUBBLE.BubbleBlackHole.prototype.onHit=function(t){if("bomb"==t.type)return this.dying=!0,void this.grid.moveToPopOutGroup(this)},BUBBLE.BubbleBlackHole.prototype.onPopOut=function(){this.dying=!0,this.grid.moveToPopOutGroup(this)},BUBBLE.BubbleChameleon=function(t,e,i,s){BUBBLE.Bubble.apply(this,arguments),this.special="cham",this.type=game.rnd.between(0,4).toString(),this.loadTexture("bubblesheet","cham_"+this.type),this.animated=!1,BUBBLE.events.onMoveDone.add(this.onMoveDone,this)},BUBBLE.BubbleChameleon.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleChameleon.prototype.onMoveDone=function(t){if(this.alive&&0!=t.length&&this.parent!=this.grid.matchGroup&&this.parent!=this.grid.popOutGroup){BUBBLE.events.fxChameleonColorChange.dispatch(this);var e=Math.floor(Math.random()*t.length);t[e]==this.type&&t.length>1&&(e=(e+1)%t.length),this.type=t[e].toString(),this.loadTexture("bubblesheet","cham_"+this.type),this.grid.orderCacheAfterUpdate=!0}},BUBBLE.BubbleCenterOfShield=function(t,e,i,s,o,a){this.color=o.slice(7),BUBBLE.Bubble.apply(this,arguments),this.loadTexture("shieldsheet",o.toLowerCase()+"_4"),this.topLayer=game.make.image(0,0,null),this.topLayer.color=o.slice(7),this.topLayer.anchor.setTo(.5),this.topLayer.alpha=0,this.addChild(this.topLayer),this.grid=a,this.possibleColors=this.grid.getAllColorsOnBoard(),BUBBLE.events.onMoveDone.add((function(t){this.possibleColors=t}),this),this.bombResistant=!0,this.bounceable=!1,this.special=!0,this.framesArray=["3","2","1","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","2","3","4","4"],this.frameIndex=0,this.framesNumber=this.framesArray.length,this.animationTimer=2,this.requestedColorTransition=!1,this.active=!1,this.dying=!1,this.sides,this.hitChecked=!1,BUBBLE.events.onMoveDone.add((function(){this.hitChecked=!1}),this)},BUBBLE.BubbleCenterOfShield.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleCenterOfShield.prototype.update=function(){this.active&&(this.updateAnimation(),this.dying&&(this.scale.setTo(this.scale.x+.02),this.alpha-=.03,this.alpha<=0&&this.destroy()))},BUBBLE.BubbleCenterOfShield.prototype.updateAnimation=function(){0==--this.animationTimer&&(this.loadTexture("shieldsheet","shield_"+this.color+"_"+this.framesArray[this.frameIndex]),this.topLayer.loadTexture("shieldsheet","shield_"+this.topLayer.color+"_"+this.framesArray[this.frameIndex]),this.animationTimer=3,this.frameIndex++,this.frameIndex==this.framesNumber&&(this.frameIndex=0)),this.topLayer.alpha=Math.max(0,this.topLayer.alpha-.03)},BUBBLE.BubbleCenterOfShield.prototype.setSides=function(t){this.sides=t,t.forEach((function(t){t.center=this}),this)},BUBBLE.BubbleCenterOfShield.prototype.activateShield=function(){this.active=!0,this.grid.moveToNonCacheGroup(this)},BUBBLE.BubbleCenterOfShield.prototype.onHit=function(t){!this.hitChecked&&this.active&&(this.hitChecked=!0,this.color==t.type||"bomb"==t.type||"multicolor"==t.type?(this.grid.moveToPopOutGroup(this),this.dying=!0,BUBBLE.events.onShieldDefeated.dispatch(this),game.sfx.monster_ugh.play()):this.changeColorToRandom())},BUBBLE.BubbleCenterOfShield.prototype.onPopOut=function(){},BUBBLE.BubbleCenterOfShield.prototype.changeColorToRandom=function(){this.topLayer.alpha=1,this.topLayer.color=this.color,this.topLayer.loadTexture("shieldsheet",this.frameName);var t=this.color,e=Math.floor(Math.random()*this.possibleColors.length);this.color=this.possibleColors[e],this.color==t&&this.possibleColors.length>1&&(this.color=this.possibleColors[(e+1)%this.possibleColors.length]),this.type="SHIELD_"+this.color},BUBBLE.BubbleShield=function(t,e,i,s){BUBBLE.Bubble.call(this,t,e,i,s,"SHIELD"),this.powerUpResistant=!0,this.bounceable=!1,this.center=null,this.bombResistant=!0},BUBBLE.BubbleShield.prototype=Object.create(BUBBLE.Bubble.prototype),BUBBLE.BubbleShield.prototype.onHit=function(t){this.center.onHit(t)},BUBBLE.BubbleFactory=function(t){this.grid=t,this.gridArray=t.gridArray,this.neighboursCoordinations=t.neighboursCoordinations,this.colorGroups=["0","1","2","3","4","5"],Phaser.ArrayUtils.shuffle(this.colorGroups)},BUBBLE.BubbleFactory.prototype.makeBubble=function(t,e,i){var s=0,o=this.grid.cellToInsidePx(t,e);return"SHIELD"==i.slice(0,6)?this.makeShield(t,e,i):("bomb"==i?s=new BUBBLE.BubbleBomb(t,e,o[0],o[1]):"multicolor"==i?(s=new BUBBLE.BubbleRegular(t,e,o[0],o[1],"multicolor")).loadTexture("bubblesheet","bubble_multicolor"):"GHOST"==i?s=new BUBBLE.BubbleGhost(t,e,o[0],o[1]):"ANIMAL"==i?s=new BUBBLE.BubbleAnimal(t,e,o[0],o[1]):"bk"==i?s=new BUBBLE.BubbleBlocker(t,e,o[0],o[1]):"cham"==i?s=new BUBBLE.BubbleChameleon(t,e,o[0],o[1]):"monster"==i?s=new BUBBLE.BubbleMonster(t,e,o[0],o[1],this.grid):2!=i.length&&3!=i.length||"C"!=i[0]?"blackhole"==i?s=new BUBBLE.BubbleBlackHole(t,e,o[0],o[1]):"r"==i?s=new BUBBLE.BubbleRegular(t,e,o[0],o[1],this.colorGroups[game.rnd.between(0,4)]):"r5"==i?s=new BUBBLE.BubbleRegular(t,e,o[0],o[1],game.rnd.between(0,5).toString()):("g"===i[0]&&(i=this.colorGroups[parseInt(i[1])-1]),s=new BUBBLE.BubbleRegular(t,e,o[0],o[1],i)):("g"===i[1]&&(i="C"+this.colorGroups[parseInt(i[2])-1]),"r"===i[1]&&(i="C"+this.colorGroups[game.rnd.between(0,4)]),s=new BUBBLE.BubbleCloud(t,e,o[0],o[1],i[1])),s.grid=this.grid,this.gridArray.set(t,e,s),s.animated?this.grid.nonCacheGroup.add(s):this.grid.add(s),s)},BUBBLE.BubbleFactory.prototype.makeRegularBubble=function(t,e,i){},BUBBLE.BubbleFactory.prototype.makeShield=function(t,e,i){i="SHIELD_"+this.colorGroups[game.rnd.between(0,4)];var s=this.grid.cellToInsidePx(t,e),o=new BUBBLE.BubbleCenterOfShield(t,e,s[0],s[1],i,this.grid),a=[];return this.grid.neighboursCoordinations[Math.abs(e%2)].forEach((function(i){s=this.grid.cellToInsidePx(t+i[0],e+i[1]),a.push(new BUBBLE.BubbleShield(t+i[0],e+i[1],s[0],s[1]))}),this),a.forEach((function(t){t.grid=this.grid,this.gridArray.set(t.cellX,t.cellY,t),this.grid.add(t)}),this),o.setSides(a),this.gridArray.set(t,e,o),this.grid.add(o),o},BUBBLE.BubbleFlying=function(t){Phaser.Sprite.call(this,game,0,0,null),this.anchor.setTo(.5),this.grid=t,this.collCircle=new Phaser.Circle(0,0,BUBBLE.l(20)),this.spd=BUBBLE.l(33),this.cellX=0,this.cellY=0,this.prevCellX=0,this.prevCellY=0,this.neighbours=[],this.ghostMode="Ghost"==t.lvl.mode,this.bossMode="Boss"==t.lvl.mode,this.kill()},BUBBLE.BubbleFlying.prototype=Object.create(Phaser.Sprite.prototype),BUBBLE.BubbleFlying.constructor=BUBBLE.BubbleFlying,BUBBLE.BubbleFlying.prototype.update=function(){this.alive&&(this.updatePosition(),this.updateColl(),this.alive||BUBBLE.events.onMoveDone.dispatch(this.grid.getAllColorsOnBoard()))},BUBBLE.BubbleFlying.prototype.init=function(t,e,i,s){this.revive(),this.x=t,this.y=e,this.collCircle.diameter=BUBBLE.l(20),this.cellX=-99999,this.cellY=-99999,this.alpha=1,this.type=s.toString(),this.velX=BUBBLE.utils.lengthdir_x(i,this.spd,!0),this.velY=BUBBLE.utils.lengthdir_y(i,this.spd,!0),this.loadTexture("bubblesheet","bubble_"+s),this.minX=BUBBLE.l(40),this.maxX=BUBBLE.l(600),this.minY=BUBBLE.l(30),this.maxY=e},BUBBLE.BubbleFlying.prototype.updateColl=function(){if(this.alive&&this.grid.checkCollisionAgainst(this,this.neighbours).length>0){if(this.grid.processPreciseHits(this),!this.alive)return;this.grid.getBubble(this.cellX,this.cellY)&&(this.cellX=this.prevCellX,this.cellY=this.prevCellY),this.grid.putBubble(this),this.kill()}},BUBBLE.BubbleFlying.prototype.updatePosition=function(){if(this.alive){if(this.x+=this.velX,this.y+=this.velY,this.x<this.minX||this.x>this.maxX){var t=this.x<this.minX?this.minX-this.x:this.maxX-this.x;this.x=game.math.clamp(this.x,this.minX,this.maxX)+t,this.velX*=-1,game.sfx["hit_"+game.rnd.between(1,3)].play()}this.ghostMode&&this.y<this.minY&&(this.y=this.minY-(this.y-this.minY),this.velY*=-1,game.sfx["hit_"+game.rnd.between(1,3)].play()),this.bossMode&&this.y<this.grid.y+this.minY&&(this.y=this.grid.y+this.minY,this.velY*=-1,game.sfx["hit_"+game.rnd.between(1,3)].play()),this.y>this.maxY&&(this.alpha-=.07,this.alpha<0&&this.kill());var e=this.grid.outsidePxToCell(this.x,this.y);this.cellX==e[0]&&this.cellY==e[1]||(this.prevCellX=this.cellX,this.prevCellY=this.cellY,this.cellX=e[0],this.cellY=e[1],this.neighbours=this.grid.getNeighbours(e[0],e[1]))}},BUBBLE.BubbleFlying.prototype.getInsideGridPx=function(){return this.grid.cellToInsidePx(this.cellX,this.cellY)},BUBBLE.BubbleFx=function(){Phaser.Image.call(this,game,0,0,null),this.anchor.setTo(.5),this.kill(),this.updateFunction=function(){}},BUBBLE.BubbleFx.prototype=Object.create(Phaser.Image.prototype),BUBBLE.BubbleFx.constructor=BUBBLE.BubbleFx,BUBBLE.BubbleFx.prototype.update=function(){this.alive&&this.updateFunction()},BUBBLE.BubbleFx.prototype.updateEmpty=function(){},BUBBLE.BubbleFx.prototype.init=function(t){this.x=t.x,this.y=t.y,this.alpha=1,this.scale.setTo(1),this.bubble=t,this.updateFunction=this.updateEmpty,this.revive()},BUBBLE.BubbleFx.prototype.initCircleParticle=function(t){this.init(t),this.scale.setTo(0),this.loadTexture("bubblesheet","bubble_hit_particle"),this.updateFunction=this.updateCircleParticle},BUBBLE.BubbleFx.prototype.updateCircleParticle=function(){this.scale.setTo(this.scale.x+.06),this.scale.x>.75&&(this.alpha=1-2*(this.scale.x-.75),this.alpha<=0&&this.kill())},BUBBLE.BubbleFx.prototype.initBlastCircleParticle=function(t){this.init(t),this.scale.setTo(0),this.loadTexture("bubblesheet","bubble_hit_particle"),this.updateFunction=this.updateBlastCircleParticle},BUBBLE.BubbleFx.prototype.updateBlastCircleParticle=function(){this.scale.setTo(this.scale.x+.15),this.scale.x>2&&(this.alpha=1-2*(this.scale.x-2),this.alpha<=0&&this.kill())},BUBBLE.BubbleFx.prototype.initMatchParticle=function(t){this.init(t),this.matchIndex=1,this.matchTimer=0,this.loadTexture(null),this.updateFunction=this.updateMatchParticle},BUBBLE.BubbleFx.prototype.updateMatchParticle=function(){this.x=this.bubble.x,this.y=this.bubble.y,this.scale.setTo(this.bubble.scale.x),0==this.matchTimer&&(this.loadTexture("bubblesheet","bubble_match_"+this.matchIndex),this.matchTimer=2,this.matchIndex++,12==this.matchIndex&&this.kill()),this.matchTimer--},BUBBLE.BubbleFx.prototype.initCloudParticle=function(t){this.init(t),this.rotation=this.bubble.rotation,this.animIndex=0,this.animTimer=0,this.loadTexture("bubblesheet","cloud_0"),this.updateFunction=this.updateCloudParticle},BUBBLE.BubbleFx.prototype.updateCloudParticle=function(){this.x=this.bubble.x,this.y=this.bubble.y,this.rotation=this.bubble.rotation,0==this.animTimer&&(this.loadTexture("bubblesheet","cloud_"+this.animIndex),this.animTimer=3,this.animIndex++,5==this.animIndex&&this.kill()),this.animTimer--},BUBBLE.BubbleFx.prototype.initChameleonColorChange=function(t){this.init(t),this.rotation=this.bubble.rotation,this.animIndex=0,this.animTimer=0,this.loadTexture("bubblesheet",t.frameName),this.updateFunction=this.updateChameleonColorChange},BUBBLE.BubbleFx.prototype.updateChameleonColorChange=function(){this.x=this.bubble.x,this.y=this.bubble.y,this.rotation=this.bubble.rotation,this.alpha-=.03,this.alpha<0&&this.kill()},BUBBLE.Button=function(t,e,i,s,o){Phaser.Button.call(this,game,BUBBLE.l(t),BUBBLE.l(e),null,this.click,this),this.state=game.state.getCurrentState(),this.loadTexture("ssheet",i),this.anchor.setTo(.5),this.sfx=game.sfx.pop,this.active=!0,this.onClick=new Phaser.Signal,s&&this.onClick.add(s,o||this),this.terms=[]},BUBBLE.Button.prototype=Object.create(Phaser.Button.prototype),BUBBLE.Button.constructor=BUBBLE.Button,BUBBLE.Button.prototype.click=function(){if(this.active){for(var t=0;t<this.terms.length;t++)if(!this.terms[t][0].call(this.terms[t][1]))return;this.active=!1,this.onClick.dispatch(),this.sfx.play(),game.add.tween(this.scale).to({x:1.2,y:1.2},200,Phaser.Easing.Quadratic.Out,!0).onComplete.add((function(){game.add.tween(this.scale).to({x:1,y:1},200,Phaser.Easing.Quadratic.Out,!0).onComplete.add((function(){this.active=!0}),this)}),this)}},BUBBLE.Button.prototype.addTerm=function(t,e){this.terms.push([t,e])},BUBBLE.Button.prototype.addImageLabel=function(t){this.label=game.make.image(0,0,"ssheet",t),this.label.anchor.setTo(.5),this.addChild(this.label)},BUBBLE.Button.prototype.addTextLabel=function(t,e){this.label=game.make.bitmapText(0,0,t,e,Math.floor(.7*this.height)),this.label.width=Math.min(this.label.width,.9*this.width),this.label.anchor.setTo(.5),this.addChild(this.label)},BUBBLE.CellingBubbles=function(t){Phaser.Image.call(this,game,0,BUBBLE.l(6),"bubblesheet","celling0"),this.grid=t;for(var e=0,i=0;i<11;i++)this.grid.isSpaceFree(i,0)&&e++;BUBBLE.events.onCellingChange.dispatch(e),BUBBLE.events.onBubblePutToGrid.add((function(t){0==t.cellY&&this.putBubble(t.cellX)}),this),BUBBLE.events.onBubbleOutOfGrid.add((function(t){0==t.cellY&&this.destroyBubble(t.cellX)}),this),this.animTimer=3,this.animIndex=0},BUBBLE.CellingBubbles.prototype=Object.create(Phaser.Image.prototype),BUBBLE.CellingBubbles.constructor=BUBBLE.CellingBubbles,BUBBLE.CellingBubbles.prototype.update=function(){this.animTimer--,0==this.animTimer&&(this.animTimer=3,this.animIndex=(this.animIndex+1)%10,this.loadTexture("bubblesheet",this.animationArray[this.animIndex]))},BUBBLE.CellingBubbles.prototype.animationArray=["celling0","celling1","celling2","celling3","celling4","celling5","celling6","celling7","celling8","celling9"],BUBBLE.CellingBubbles.prototype.putBubble=function(t){BUBBLE.events.onCellingChange.dispatch(-1)},BUBBLE.CellingBubbles.prototype.destroyBubble=function(t){BUBBLE.events.onCellingChange.dispatch(1)},BUBBLE.Editor=function(t){this.game,this.add,this.camera,this.cache,this.input,this.load,this.math,this.sound,this.stage,this.time,this.tweens,this.state,this.world,this.particles,this.physics,this.rnd},BUBBLE.Editor.prototype={init:function(t){this.NOTRESIZABLE=!0,BUBBLE.events.onToolChange||(BUBBLE.events.onToolChange=new Phaser.Signal,BUBBLE.events.onModeChange=new Phaser.Signal,BUBBLE.events.onDeleteAllElements=new Phaser.Signal),BUBBLE.events.clear(),this.lvl=t},preload:function(){game.load.text("e_elements","assets/editor/json/e_elements.json"),game.load.atlasJSONHash("esheet","assets/editor/spritesheets/esheet.png","assets/editor/spritesheets/esheet.json"),game.load.bitmapFont("font_dbg","assets/editor/font/font-dbg.png","assets/editor/font/font-dbg.fnt")},create:function(){BUBBLE.e_elements=JSON.parse(game.cache.getText("e_elements")),game.scale.setGameSize(1800,960),game.world.setBounds(-600,0,1800,960),this.grid=new BUBBLE.GameGridEditor(this.lvl),this.gridOverlay=game.add.tileSprite(0,0,640,960,"esheet","grid"),g=this.grid,this.editorUI=new BUBBLE.EditorUI(this.lvl),this.gridNumbers=game.add.group();for(var t=0;t<30;t++){var e=game.make.bitmapText(10,15+510*t,"font_dbg",(10*t).toString(),20);e.alpha=.5,this.gridNumbers.add(e)}this.lvlNrTxt=game.add.bitmapText(-590,900,"font_dbg","Level nr "+(BUBBLE.levels.indexOf(this.lvl)+1),40),this.lvlNrTxt.alpha=.5,this.playtest=game.add.button(800,900,null),this.playtest.loadTexture("esheet","playtest"),this.playtest.onInputDown.add((function(){var t=this.grid.exportLevel();t&&(this.lvl.level=t,game.state.start("Game",!0,!1,BUBBLE.levels.indexOf(this.lvl),null,!0))}),this),this.saveandback=game.add.button(1e3,900,null),this.saveandback.loadTexture("esheet","saveandback"),this.saveandback.onInputDown.add((function(){var t=this.grid.exportLevel();t&&(this.lvl.level=t,game.state.start("EditorWorld"))}),this),BUBBLE.events.onModeChange.add((function(t){this.lvl.mode=t}),this)},update:function(){this.gridOverlay.tilePosition.y=this.grid.y-6,this.gridNumbers.y=this.grid.y},render:function(){game.debug.text(this.grid.length,2,28,"#ff0000")}},BUBBLE.EditorMapCircle=function(t){Phaser.Group.call(this,game),this.onMoveSelectedLevelHere=new Phaser.Signal,this.circle=game.make.image(0,0,"esheet","map_circle"),this.circle.anchor.setTo(.5),this.add(this.circle),this.lvlSelected=null,BUBBLE.events.onLevelSelected.add((function(t){this.lvlSelected=t,this.moveSelectedLevelHere.alpha=1,this.hide()}),this),this.makeNewLevel=game.make.bitmapText(60,-40,"font_dbg","Make new level",30),this.makeNewLevel.inputEnabled=!0,this.makeNewLevel.input.useHandCursor=!0,this.makeNewLevel.hitArea=new Phaser.Rectangle(0,0,200,30),this.makeNewLevel.events.onInputDown.add((function(){BUBBLE.events.makeLevel.dispatch(this.x,this.y),this.hide()}),this),this.addChild(this.makeNewLevel),this.moveSelectedLevelHere=game.make.bitmapText(60,30,"font_dbg","Move selected lvl here",30),this.moveSelectedLevelHere.inputEnabled=!0,this.moveSelectedLevelHere.input.useHandCursor=!0,this.moveSelectedLevelHere.hitArea=new Phaser.Rectangle(0,0,300,30),this.moveSelectedLevelHere.events.onInputDown.add((function(){null!==this.lvlSelected&&(BUBBLE.events.moveLevelTo.dispatch(this.lvlSelected,this.x,this.y),this.hide())}),this),this.addChild(this.moveSelectedLevelHere),this.moveSelectedLevelHere.alpha=.5,this.x=-9999,this.y=-9999},BUBBLE.EditorMapCircle.prototype=Object.create(Phaser.Group.prototype),BUBBLE.EditorMapCircle.constructor=BUBBLE.EditorMapCircle,BUBBLE.EditorMapCircle.prototype.moveTo=function(t,e){Math.abs(this.y-e)<70&&t>this.x+50&&t<this.x+400||(this.x=t,this.y=e)},BUBBLE.EditorMapCircle.prototype.hide=function(t,e){this.x=-9999,this.y=-9999},BUBBLE.EditorShooterWindow=function(t){Phaser.Group.call(this,game),this.lvl=t,this.modeButton=game.make.button(30,20,null),this.modeButton.bitmapText=game.make.bitmapText(0,0,"font_dbg","Shooter mode: "+this.lvl.shooter.mode,30),this.modeButton.addChild(this.modeButton.bitmapText),this.modeButton.lvl=t,this.modeButton.onInputDown.add((function(){"pattern"==this.lvl.shooter.mode?this.lvl.shooter.mode="random":this.lvl.shooter.mode="pattern",this.bitmapText.setText("Shooter mode: "+this.lvl.shooter.mode),this.parent.refreshPattern()}),this.modeButton),this.modeButton.hitArea=new Phaser.Rectangle(0,0,350,30),this.numberButton=game.make.button(30,70,null),this.numberButton.bitmapText=game.make.bitmapText(0,0,"font_dbg","Bubbles number: "+this.lvl.shooter.bubblesNumber,30),this.numberButton.addChild(this.numberButton.bitmapText),this.numberButton.lvl=t,this.numberButton.onInputDown.add((function(){var t=parseInt(prompt("How many bubbles should shooter have?"));t&&(this.lvl.shooter.bubblesNumber=t,this.bitmapText.setText("Bubbles number: "+this.lvl.shooter.bubblesNumber),this.parent.refreshPattern())}),this.numberButton),this.numberButton.hitArea=new Phaser.Rectangle(0,0,350,30),this.patternGroup=game.add.group(),this.refreshPattern(),this.addMultiple([this.modeButton,this.numberButton,this.patternGroup]),this.x=-600},BUBBLE.EditorShooterWindow.prototype=Object.create(Phaser.Group.prototype),BUBBLE.EditorShooterWindow.constructor=BUBBLE.EditorUI,BUBBLE.EditorShooterWindow.prototype.show=function(){BUBBLE.events.onWindowOpen.dispatch(),this.x=0},BUBBLE.EditorShooterWindow.prototype.hide=function(){BUBBLE.events.onWindowClose.dispatch(),this.x=-640},BUBBLE.EditorShooterWindow.prototype.refreshPattern=function(){"random"==this.lvl.shooter.mode?this.patternGroup.alpha=.5:this.patternGroup.alpha=1,this.refillPatternGroup()},BUBBLE.EditorShooterWindow.prototype.refillPatternGroup=function(){for(var t=0,e=0,i=null,s=0;s<this.lvl.shooter.bubblesNumber;s++)this.patternGroup.children[s]||(this.lvl.shooter.pattern[s]||(this.lvl.shooter.pattern[s]=game.rnd.between(0,4)),i=this.makePatternBubbleButton(80+50*e,150+50*t,this.lvl.shooter.pattern[s],this.lvl,s,.8),this.patternGroup.add(i)),10==++e&&(t++,e=0);if(this.lvl.shooter.bubblesNumber<this.patternGroup.length){var o=[];this.patternGroup.forEach((function(t){t.indexNr>=s&&o.push(t)})),o.forEach((function(t){t.destroy()}))}},BUBBLE.EditorShooterWindow.prototype.makePatternBubbleButton=function(t,e,i,s,o,a){var n=game.make.button(t,e,null);return n.loadTexture("bubblesheet","bubble_"+i),n.scale.setTo(a||1),n.anchor.setTo(.5),n.lvl=s,n.type=i,n.indexNr=o,n.onInputDown.add((function(){this.type++,this.type=this.type%5,this.loadTexture("bubblesheet","bubble_"+this.type),this.lvl.shooter.pattern[this.indexNr]=this.type}),n),n},BUBBLE.EditorUI=function(t){Phaser.Group.call(this,game),this.x=660,this.lvl=t,this.selectToolButtonGroup=game.add.group(),this.add(this.selectToolButtonGroup),this.modeButtonGroup=game.add.group(),this.add(this.modeButtonGroup),this.makeTrashButton(460,40),this.makeModeButtons(10),this.makeElementsButtons(120),this.makeStarPointsField(750),this.makeTutField(850),this.shooterWindow=new BUBBLE.EditorShooterWindow(this.lvl),BUBBLE.events.onModeChange.add((function(t){BUBBLE.events.onToolChange.dispatch(""),this.selectToolButtonGroup.forEach((function(e){e.type.length>3&&(e.type[3]==t?(e.onInputDown.active=!0,e.alpha=1):(e.onInputDown.active=!1,e.alpha=.5)),e.loadTexture("esheet","button")}),this)}),this),this.keyboardInput=game.input.keyboard.addKeys({one:Phaser.Keyboard.ONE,two:Phaser.Keyboard.TWO,three:Phaser.Keyboard.THREE,four:Phaser.Keyboard.FOUR,five:Phaser.Keyboard.FIVE,six:Phaser.Keyboard.SIX,tilde:Phaser.Keyboard.TILDE,q:Phaser.Keyboard.Q,w:Phaser.Keyboard.W,e:Phaser.Keyboard.E,r:Phaser.Keyboard.R,t:Phaser.Keyboard.T,y:Phaser.Keyboard.Y,a:Phaser.Keyboard.A,s:Phaser.Keyboard.S,d:Phaser.Keyboard.D,f:Phaser.Keyboard.F,g:Phaser.Keyboard.G,h:Phaser.Keyboard.H}),this.keyboardInput.one.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[0])})),this.keyboardInput.two.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[1])})),this.keyboardInput.three.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[2])})),this.keyboardInput.four.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[3])})),this.keyboardInput.five.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[4])})),this.keyboardInput.six.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[5])})),this.keyboardInput.q.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[6])})),this.keyboardInput.w.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[7])})),this.keyboardInput.e.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[8])})),this.keyboardInput.r.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[9])})),this.keyboardInput.t.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[10])})),this.keyboardInput.y.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[11])})),this.keyboardInput.a.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[19])})),this.keyboardInput.s.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[20])})),this.keyboardInput.d.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[21])})),this.keyboardInput.f.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[22])})),this.keyboardInput.g.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[23])})),this.keyboardInput.h.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[24])})),this.keyboardInput.tilde.onDown.add((function(){BUBBLE.events.onToolChange.dispatch(BUBBLE.e_elements.common_elements[30])})),BUBBLE.e_elements,BUBBLE.events.onModeChange.dispatch(this.lvl.mode)},BUBBLE.EditorUI.prototype=Object.create(Phaser.Group.prototype),BUBBLE.EditorUI.constructor=BUBBLE.EditorUI,BUBBLE.EditorUI.prototype.makeElementsButtons=function(t){this.elementsButtonsLabel=game.add.bitmapText(10,t,"font_dbg","Elements:",20),this.add(this.elementsButtonsLabel);for(var e=BUBBLE.e_elements.common_elements,i=0,s=0,o=0;o<e.length;o++)this.makeSelectToolButton(20+70*i,t+30+70*s,e[o]),6==++i&&(i=0,s++);s++,this.spElementsButtonsLabel=game.add.bitmapText(10,t+40+70*s,"font_dbg","Special elements:",20),this.add(this.spElementsButtonsLabel);var a=BUBBLE.e_elements.special_elements;i=0;for(o=0;o<a.length;o++)this.makeSelectToolButton(20+70*i,t+70+70*s,a[o]),6==++i&&(i=0,s++)},BUBBLE.EditorUI.prototype.makeModeButtons=function(t){this.modeLabel=game.add.bitmapText(10,t,"font_dbg","MODE: "+this.lvl.mode,20),this.add(this.modeLabel),BUBBLE.events.onModeChange.add((function(t){this.setText("MODE: "+t)}),this.modeLabel);for(var e=BUBBLE.e_elements.modes,i=0;i<4;i++){var s=this.makeModeButton(20+70*i,t+30,e[i]);e[i][0]==this.lvl.mode&&s.loadTexture("esheet","button_select")}},BUBBLE.EditorUI.prototype.makeSelectToolButton=function(t,e,i){var s=game.add.button(t,e,null);return s.loadTexture("esheet","button"),s.type=i,s.label=game.make.image(33,33,i[1],i[2]),s.label.anchor.setTo(.5),s.label.scale.setTo(.7),s.label.width>60&&(s.label.width=60,s.label.height=60),s.addChild(s.label),s.onInputDown.add((function(){this.parent.forEach((function(t){t.loadTexture("esheet","button")})),this.loadTexture("esheet","button_select"),BUBBLE.events.onToolChange.dispatch(this.type)}),s),this.selectToolButtonGroup.add(s),s},BUBBLE.EditorUI.prototype.makeModeButton=function(t,e,i){var s=game.add.button(t,e,null);return s.loadTexture("esheet","button"),s.type=i,s.label=game.make.image(33,33,i[1],i[2]),s.label.anchor.setTo(.5),s.label.scale.setTo(.7),s.addChild(s.label),s.onInputDown.add((function(){confirm("Changing mode can destroy your current level! Are you sure?")&&(this.parent.forEach((function(t){t.loadTexture("esheet","button")})),this.loadTexture("esheet","button_select"),BUBBLE.events.onModeChange.dispatch(this.type[0]))}),s),this.modeButtonGroup.add(s),s},BUBBLE.EditorUI.prototype.makeStarPointsField=function(t){this.starsRequirements=game.add.bitmapText(40,t,"font_dbg","Stars requirements:",20),this.add(this.starsRequirements);for(var e=0;e<3;e++){var i=game.make.image(20+180*e,t+40,"esheet","star_"+(e+1));i.scale.setTo(.5);var s=game.make.button(70+180*e,t+40,null);s.bitmapText=game.make.bitmapText(0,0,"font_dbg",this.lvl.starsRequirements[e].toString(),30),s.reqIndex=e,s.lvl=this.lvl,s.addChild(s.bitmapText),s.onInputDown.add((function(){var t=parseInt(prompt("Put point requirement for star:"));t&&(this.lvl.starsRequirements[this.reqIndex]=t,this.bitmapText.setText(this.lvl.starsRequirements[this.reqIndex].toString()))}),s),this.addMultiple([i,s])}},BUBBLE.EditorUI.prototype.makeTrashButton=function(t,e){var i=game.add.button(t,e,null);i.loadTexture("esheet","button"),i.label=game.make.image(30,30,"esheet","trash"),i.label.anchor.setTo(.5),i.label.scale.setTo(.7),i.addChild(i.label),i.onInputDown.add((function(){confirm("Are you sure you want to clear all elements?")&&BUBBLE.events.onDeleteAllElements.dispatch()}),this),this.add(i)},BUBBLE.EditorUI.prototype.makeTutField=function(t){this.tutLabel=game.add.bitmapText(40,t,"font_dbg","Tutorial:",20),this.tut0=game.make.bitmapText(150,t,"font_dbg",this.lvl.tut0||"null",20),this.tut1=game.make.bitmapText(210,t,"font_dbg",this.lvl.tut1||"null",20),this.tut0.inputEnabled=!0,this.tut0.events.onInputDown.add((function(){var t=prompt("Tutorial 1 nr");""==t?(this.lvl.tut0=null,this.tut0.setText("null")):(this.lvl.tut0=t,this.tut0.setText(t))}),this),this.tut1.inputEnabled=!0,this.tut1.events.onInputDown.add((function(){var t=prompt("Tutorial 1 nr");""==t?(this.lvl.tut1=null,this.tut1.setText("null")):(this.lvl.tut1=t,this.tut1.setText(t))}),this),this.timerLabel=game.add.bitmapText(250,t,"font_dbg","Timer:",20),this.timer0=game.make.bitmapText(350,t,"font_dbg",this.lvl.time||"0",20),this.timer0.inputEnabled=!0,this.timer0.events.onInputDown.add((function(){var t=prompt("Time in sec:");""==t?(this.lvl.time=0,this.timer0.setText("0")):(this.lvl.time=t,this.timer0.setText(t))}),this),this.addMultiple([this.tutLabel,this.tut0,this.tut1,this.timer0,this.timerLabel])},BUBBLE.EditorWorld=function(t){this.game,this.add,this.camera,this.cache,this.input,this.load,this.math,this.sound,this.stage,this.time,this.tweens,this.state,this.world,this.particles,this.physics,this.rnd},BUBBLE.EditorWorld.prototype={init:function(){game.renderer.clearBeforeRender=!0,this.NOTRESIZABLE=!0,BUBBLE.events.onLevelSelected||(BUBBLE.events.onLevelSelected=new Phaser.Signal,BUBBLE.events.makeLevel=new Phaser.Signal,BUBBLE.events.moveLevelTo=new Phaser.Signal,BUBBLE.events.requestRefresh=new Phaser.Signal),BUBBLE.events.clear()},preload:function(){game.load.text("e_elements","assets/editor/json/e_elements.json"),game.load.atlasJSONHash("esheet","assets/editor/spritesheets/esheet.png","assets/editor/spritesheets/esheet.json"),game.load.bitmapFont("font_dbg","assets/editor/font/font-dbg.png","assets/editor/font/font-dbg.fnt")},create:function(){BUBBLE.e_elements=JSON.parse(game.cache.getText("e_elements")),game.scale.setGameSize(2e3,960),game.world.setBounds(0,0,2e3,960),this.map=new BUBBLE.WorldMap,wm=this.map,this.map.teddy.visible=!1,this.map.mapPointHl.visible=!1,this.map.editorMode=!0,this.map.update=function(){this.bg.y=this.positionBounds.yMin+(this.y-this.positionBounds.yMin)/this.positionBounds.yMax*(this.bg.height-this.positionBounds.yMin)},this.map.refreshMap=function(){this.lvlButtonGroup.removeAll(!0,!0),this.initLvlButtons(),this.lvlButtonGroup.forEach((function(t){t.onInputUp.removeAll(),t.onInputDown.removeAll(),t.onInputDown.add((function(){BUBBLE.events.onLevelSelected.dispatch(t.nr)})),t.alpha=1}))},this.map.refreshMap(),BUBBLE.events.requestRefresh.add(this.map.refreshMap,this.map),wm=this.map,this.circleEditor=new BUBBLE.EditorMapCircle,this.sidePanel=new BUBBLE.EditorWorldSidePanel,this.centralLine=game.add.image(0,0,"esheet","line"),BUBBLE.events.makeLevel.add(this.makeNewLevel,this),BUBBLE.events.moveLevelTo.add(this.moveLevel,this),this.selectTile=null,this.selectTileButton=new BUBBLE.Button(50,50,null),this.selectTileButton.loadTexture("esheet","button"),this.selectTileButton.label=game.make.image(0,0,null),this.selectTileButton.label.anchor.setTo(.5),this.selectTileButton.addChild(this.selectTileButton.label),game.add.existing(this.selectTileButton),this.selectTileButton.onClick.add((function(){null==this.selectTile?this.selectTile=0:(this.selectTile++,this.selectTile==this.map.maptilesGroup.length&&(this.selectTile=null)),null!==this.selectTile?(this.selectTileButton.label.loadTexture(this.map.maptilesGroup.children[this.selectTile].key),this.selectTileButton.label.width=60,this.selectTileButton.label.height=60):this.selectTileButton.label.loadTexture(null),this.map.maptilesGroup.children.forEach((function(t,e){t.tint=16777215,e===this.selectTile&&(t.tint=65280)}),this)}),this),game.input.onDown.add((function(t){t.worldX<this.map.width&&this.circleEditor.moveTo(t.worldX,t.worldY)}),this),this.cursors=game.input.keyboard.createCursorKeys()},update:function(){null===this.selectTile?(this.cursors.down.isDown&&(this.map.y-=10),this.cursors.up.isDown&&(this.map.y+=10),this.cursors.right.isDown&&(this.map.x-=10),this.cursors.left.isDown&&(this.map.x+=10)):(this.cursors.down.isDown&&(this.map.maptilesGroup.children[this.selectTile].y+=2),this.cursors.up.isDown&&(this.map.maptilesGroup.children[this.selectTile].y-=2),this.cursors.right.isDown&&(this.map.maptilesGroup.children[this.selectTile].x+=2),this.cursors.left.isDown&&(this.map.maptilesGroup.children[this.selectTile].x-=2)),this.map.y=Math.max(980,this.map.y),this.centralLine.x=this.map.x},makeNewLevel:function(t,e){var i=this.map.getPositionForLevel(t,e),s={mode:"Classic",starsRequirements:[10,20,30],worldMapPosition:[i[0],i[1]],background:"",shooter:{mode:"random",bubblesNumber:20,pattern:[]},level:[]};BUBBLE.levels.push(s),this.map.refreshMap()},moveLevel:function(t,e,i){var s=this.map.getPositionForLevel(e,i);BUBBLE.levels[t].worldMapPosition=[s[0],s[1]],this.map.refreshMap()},render:function(){game.debug.text(wm.getPositionForLevel(game.input.activePointer.worldX,game.input.activePointer.worldY),2,150,"#ff0000")}},BUBBLE.EditorWorldSidePanel=function(){Phaser.Group.call(this,game),this.x=1500,this.lvl=null,this.lvlNr=null,this.levelNrTxt=game.make.bitmapText(10,10,"font_dbg","Level nr: --",40),this.modeTxt=game.make.bitmapText(10,60,"font_dbg","Mode: --",30),this.shooterTxt=game.make.bitmapText(10,90,"font_dbg","Shooter: --",30),this.starsReqTxt=game.make.bitmapText(10,120,"font_dbg","Stars: --",30),this.bgPreview=game.make.image(-9999,-9999,null),this.lvlPreview=game.make.bitmapData(500,550),this.lvlPreviewBitmapImg=this.lvlPreview.addToWorld(10,170,0,0),this.lvlPreviewImg=game.make.image(-9999,-9999,null),this.lvlPreviewImg.anchor.setTo(.5),this.makeButtons(30,850),this.addMultiple([this.levelNrTxt,this.modeTxt,this.shooterTxt,this.starsReqTxt,this.lvlPreviewBitmapImg]),this.lookUpObject={},Array.prototype.concat(BUBBLE.e_elements.common_elements,BUBBLE.e_elements.special_elements).forEach((function(t){this.lookUpObject[t[0]]=t}),this),BUBBLE.events.onLevelSelected.add(this.loadLevelNr,this)},BUBBLE.EditorWorldSidePanel.prototype=Object.create(Phaser.Group.prototype),BUBBLE.EditorWorldSidePanel.constructor=BUBBLE.EditorWorldSidePanel,BUBBLE.EditorWorldSidePanel.prototype.loadLevelNr=function(t){null!==t?(this.lvl=BUBBLE.levels[t],this.lvlNr=t,this.updateTexts(),this.updatePreview()):this.deselectLevel()},BUBBLE.EditorWorldSidePanel.prototype.deselectLevel=function(){this.lvl=null,this.lvlNr=null,this.levelNrTxt.setText("Level nr: --"),this.modeTxt.setText("Mode: --"),this.shooterTxt.setText("Shooter: --"),this.starsReqTxt.setText("Stars: --"),this.lvlPreview.clear()},BUBBLE.EditorWorldSidePanel.prototype.updateTexts=function(){this.levelNrTxt.setText("Level nr: "+(this.lvlNr+1)),this.modeTxt.setText("Mode: "+this.lvl.mode),this.shooterTxt.setText("Shooter: "+this.lvl.shooter.bubblesNumber+" bubbles, "+this.lvl.shooter.mode),this.starsReqTxt.setText("Stars: "+this.lvl.starsRequirements.join(", "))},BUBBLE.EditorWorldSidePanel.prototype.updatePreview=function(){this.lvlPreview.clear(),""!=this.lvl.background&&(this.bgPreview.loadTexture(this.lvl.background),this.bgPreview.height=600,this.bgPreview.scale.x=this.bgPreview.scale.y,this.lvlPreview.draw(this.bgPreview,0,0));var t=this.lvlPreview.width/960;this.lvl.level.forEach((function(e){var i=this.lookUpObject[e[2]];this.lvlPreviewImg.loadTexture(i[1],i[2]);var s=e[0]*(58*t),o=e[1]*(51*t)+51*t*.5;e[1]%2==1&&(s+=58*t*.5);var a=game.cache.getFrameByName(i[1],i[2]),n=a.width*t,h=a.height*t;this.lvlPreview.draw(this.lvlPreviewImg,s,o,n,h)}),this)},BUBBLE.EditorWorldSidePanel.prototype.makeButtons=function(t,e){this.moveBackButton=game.make.button(t,e),this.moveBackButton.loadTexture("esheet","lvl_moveBack"),this.moveBackButton.onInputDown.add((function(){null!==this.lvlNr&&0!=this.lvlNr&&(BUBBLE.levels[this.lvlNr]=BUBBLE.levels[this.lvlNr-1],BUBBLE.levels[this.lvlNr-1]=this.lvl,BUBBLE.events.onLevelSelected.dispatch(this.lvlNr-1),BUBBLE.events.requestRefresh.dispatch())}),this),this.moveForwardButton=game.make.button(t+90,e),this.moveForwardButton.loadTexture("esheet","lvl_moveForward"),this.moveForwardButton.onInputDown.add((function(){null!==this.lvlNr&&this.lvlNr<BUBBLE.levels.length-1&&(BUBBLE.levels[this.lvlNr]=BUBBLE.levels[this.lvlNr+1],BUBBLE.levels[this.lvlNr+1]=this.lvl,BUBBLE.events.onLevelSelected.dispatch(this.lvlNr+1),BUBBLE.events.requestRefresh.dispatch())}),this),this.deleteLevelButton=game.make.button(t+90+90,e),this.deleteLevelButton.loadTexture("esheet","lvl_deleteLevel"),this.deleteLevelButton.onInputDown.add((function(){null!==this.lvlNr&&confirm("Are you sure you want to delete level?")&&(BUBBLE.levels.splice(this.lvlNr,1),BUBBLE.events.onLevelSelected.dispatch(null),BUBBLE.events.requestRefresh.dispatch())}),this),this.editLevelButton=game.make.button(t+180,e-90),this.editLevelButton.loadTexture("esheet","lvl_edit"),this.editLevelButton.onInputDown.add((function(){null!==this.lvlNr&&game.state.start("Editor",!0,!1,this.lvl)}),this),this.changeBgButton=game.make.button(t,e-90),this.changeBgButton.loadTexture("esheet","lvl_changeBackground"),this.changeBgButton.onInputDown.add((function(){if(null!==this.lvlNr){if(""==this.lvl.background)this.lvl.background=BUBBLE.assets.backgrounds[0];else{var t=BUBBLE.assets.backgrounds.indexOf(this.lvl.background);t=(t+1)%BUBBLE.assets.backgrounds.length,this.lvl.background=BUBBLE.assets.backgrounds[t]}this.updatePreview()}}),this),this.exportButton=game.make.button(t+180+90,e),this.exportButton.loadTexture("esheet","lvl_export"),this.exportButton.onInputDown.add((function(){var t=game.state.getCurrentState().map,e=[];t.maptilesGroup.children.forEach((function(t,i){e[i]=[t.x,t.y]}));var i={levels:BUBBLE.levels,worlds:e},s=new Blob([JSON.stringify(i)],{type:"text/plain;charset=utf-8"});saveAs(s,"levels.json")})),this.addMultiple([this.changeBgButton,this.moveBackButton,this.moveForwardButton,this.deleteLevelButton,this.editLevelButton,this.exportButton])},BUBBLE.FadeLayer=function(){Phaser.Image.call(this,game,0,0,"ssheet","fade"),this.fixedToCamera=!0,BUBBLE.events.onScreenResize.add(this.onScreenResize,this),BUBBLE.events.onChangeLevel.add(this.setupChange,this),this.changeLevel=null,this.arg1=null,this.arg2=null,this.arg3=null,this.onScreenResize(),this.game.add.existing(this)},BUBBLE.FadeLayer.prototype=Object.create(Phaser.Image.prototype),BUBBLE.FadeLayer.constructor=BUBBLE.FadeLayer,BUBBLE.FadeLayer.prototype.update=function(){null===this.changeLevel?this.alpha=Math.max(0,this.alpha-.05):(this.alpha=Math.min(1,this.alpha+.05),1==this.alpha&&game.state.start(this.changeLevel,!0,!1,this.arg1,this.arg2,this.arg3))},BUBBLE.FadeLayer.prototype.onScreenResize=function(){this.width=game.width,this.height=game.height},BUBBLE.FadeLayer.prototype.setupChange=function(t,e,i,s){sgSdk.trigger("interstitialAd",{callback:function(){null===this.changeLevel&&(this.changeLevel=t,this.arg1=e,this.arg2=i,this.arg3=s,game.sfx.transition.play())}},this)};
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(t){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var e=t.document,i=function(){return t.URL||t.webkitURL||t},s=e.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in s,a=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),n=t.webkitRequestFileSystem,h=t.requestFileSystem||n||t.mozRequestFileSystem,r=function(e){(t.setImmediate||t.setTimeout)((function(){throw e}),0)},l="application/octet-stream",B=0,d=function(e){var s=function(){"string"==typeof e?i().revokeObjectURL(e):e.remove()};t.chrome?s():setTimeout(s,500)},u=function(t,e,i){for(var s=(e=[].concat(e)).length;s--;){var o=t["on"+e[s]];if("function"==typeof o)try{o.call(t,i||t)}catch(t){r(t)}}},c=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t},p=function(e,r,p){p||(e=c(e));var m,g,b,f=this,L=e.type,E=!1,U=function(){u(f,"writestart progress write writeend".split(" "))},v=function(){if(g&&a&&"undefined"!=typeof FileReader){var s=new FileReader;return s.onloadend=function(){var t=s.result;g.location.href="data:attachment/file"+t.slice(t.search(/[,;]/)),f.readyState=f.DONE,U()},s.readAsDataURL(e),void(f.readyState=f.INIT)}(!E&&m||(m=i().createObjectURL(e)),g)?g.location.href=m:null==t.open(m,"_blank")&&a&&(t.location.href=m);f.readyState=f.DONE,U(),d(m)},y=function(t){return function(){if(f.readyState!==f.DONE)return t.apply(this,arguments)}},x={create:!0,exclusive:!1};if(f.readyState=f.INIT,r||(r="download"),o)return m=i().createObjectURL(e),s.href=m,s.download=r,void setTimeout((function(){!function(t){var e=new MouseEvent("click");t.dispatchEvent(e)}(s),U(),d(m),f.readyState=f.DONE}));t.chrome&&L&&L!==l&&(b=e.slice||e.webkitSlice,e=b.call(e,0,e.size,l),E=!0),n&&"download"!==r&&(r+=".download"),(L===l||n)&&(g=t),h?(B+=e.size,h(t.TEMPORARY,B,y((function(t){t.root.getDirectory("saved",x,y((function(t){var i=function(){t.getFile(r,x,y((function(t){t.createWriter(y((function(i){i.onwriteend=function(e){g.location.href=t.toURL(),f.readyState=f.DONE,u(f,"writeend",e),d(t)},i.onerror=function(){var t=i.error;t.code!==t.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach((function(t){i["on"+t]=f["on"+t]})),i.write(e),f.abort=function(){i.abort(),f.readyState=f.DONE},f.readyState=f.WRITING})),v)})),v)};t.getFile(r,{create:!1},y((function(t){t.remove(),i()})),y((function(t){t.code===t.NOT_FOUND_ERR?i():v()})))})),v)})),v)):v()},m=p.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,i){return i||(t=c(t)),navigator.msSaveOrOpenBlob(t,e||"download")}:(m.abort=function(){var t=this;t.readyState=t.DONE,u(t,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,function(t,e,i){return new p(t,e,i)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],(function(){return saveAs})),BUBBLE.Game=function(t){this.GAMESTATE=!0,this.game,this.add,this.camera,this.cache,this.input,this.load,this.math,this.sound,this.stage,this.time,this.tweens,this.state,this.world,this.particles,this.physics,this.rnd},BUBBLE.Game.prototype={init:function(t,e,i){BUBBLE.events.clear(),BUBBLE.currentLvlNr=t,this.lvl=BUBBLE.levels[t],this.lvlNr=t,sgSdk.trigger("levelStarted",{level:t+1}),game.resizeGame(),this.editorMode=i,this.topGrid=!0},create:function(){this.bg=BUBBLE.bg.addImgToWorld(this.lvl.background),this.bottomFxLayer=new BUBBLE.BottomFxLayer,"Ghost"==this.lvl.mode?this.grid=new BUBBLE.GameGridGhost(this.lvl):this.grid=new BUBBLE.GameGrid(this.lvl),this.bottomFxLayer.init(this.grid),this.flyingBubbles=game.add.group();for(var t=0;t<10;t++)this.flyingBubbles.add(new BUBBLE.BubbleFlying(this.grid));this.shooter=new BUBBLE.Shooter(this.grid),this.pots=new BUBBLE.PotsGroup,this.grid.popOutGroup=this.pots.bubbles,this.makeTutHand(),this.makeGoalTxt(),this.topFxLayer=new BUBBLE.TopFxLayer(this.grid),this.lvl.time&&this.makeTimer(),this.goalController=new BUBBLE.UI_GoalController(this.lvl),this.levelLabel=new BUBBLE.UI_LevelLabel(this.lvl),this.pointsController=new BUBBLE.UI_PointsController(this.pots),this.starController=new BUBBLE.UI_StarController(this.lvl,this.pointsController),this.money=new BUBBLE.UI_Money,this.pauseButton=new BUBBLE.UI_PauseButtons,"Classic"==this.lvl.mode&&this.initClassic(),this.windowLayer=new BUBBLE.WindowLayer,this.fadeLayer=new BUBBLE.FadeLayer,this.timer&&(this.timer.wl=this.windowLayer),this.tuthand.wL=this.windowLayer,this.goalTxt.wl=this.windowLayer,s=game.state.getCurrentState(),g=s.grid,this.lvl.tut0?new BUBBLE.Window("tutorial",this.lvl.tut0,this.lvl.tut1):BUBBLE.pause=!1,BUBBLE.events.onMoveDone.add((function(){0==this.flyingBubbles.countLiving()&&0==this.shooter.moves&&this.goalController.goalState!=this.goalController.goalTarget&&(game.incentivise||BUBBLE.saveState.getCoins()>=BUBBLE.settings.priceOfContinue?new BUBBLE.Window("continueFor"):new BUBBLE.Window("gameOver"))}),this),BUBBLE.events.onBubbleShoot.add((function(t,e,i,s,o){var a;if(o){var n=t+BUBBLE.utils.lengthdir_x(this.shooter.cannon.angle-90,BUBBLE.l(170)),h=e+BUBBLE.utils.lengthdir_y(this.shooter.cannon.angle-90,BUBBLE.l(170));(a=new BUBBLE.BubbleRegular(0,0,n,h,"0")).grid=this.grid,a.onPopOut(),a.loadTexture("bubblesheet","bubble_"+(s||"0")),a.x=n,a.y=h,a.velX=BUBBLE.utils.lengthdir_x(this.shooter.cannon.angle-90,BUBBLE.l(15)),a.velY=BUBBLE.utils.lengthdir_y(this.shooter.cannon.angle-90,BUBBLE.l(15))}else(a=this.flyingBubbles.getFirstDead())&&a.init(t,e,i,s)}),this),BUBBLE.events.onGoalAchieved.add(this.onGoalAchieved,this),this.editorMode&&(this.ebtn=game.add.buttonL(-150,50,"btn_menu",(function(){game.state.start("Editor",!0,!1,this.lvl)}),this),this.ebtn.fixedToCamera=!0,this.ebtn.cameraOffset.x=80,this.ebtn.cameraOffset.y=80,this.ebtn.scale.setTo(.5)),this.cursors=game.input.keyboard.createCursorKeys(),game.onPause.add(this.onBlur,this)},onBlur:function(){BUBBLE.pause||new BUBBLE.Window("pause")},update:function(){this.cursors.down.isDown&&(game.camera.y+=10),this.cursors.up.isDown&&(game.camera.y-=10)},initClassic:function(){this.cellingBubbles=new BUBBLE.CellingBubbles(this.grid),game.add.existing(this.cellingBubbles),game.world.sendToBack(this.cellingBubbles),game.world.moveUp(this.cellingBubbles)},getLevel:function(){return this.lvl},getLevelNr:function(){return this.lvlNr},getScore:function(){return this.pointsController.pointsTarget},onGoalAchieved:function(){this.timer&&(this.timer.update=function(){}),game.time.events.add(100,(function(){if(this.grid.popOutAll(),this.shooter.shootAllRestInit(),this.levelCleared=new BUBBLE.OneLineText(320,300,"font-outline",BUBBLE.txt("Stage clear!"),80),this.levelCleared.width>BUBBLE.l(640)){var t=.5*(this.levelCleared.width-BUBBLE.l(640));this.levelCleared.width=BUBBLE.l(640),this.levelCleared.x+=t}game.add.existing(this.levelCleared),game.world.moveDown(this.levelCleared),game.world.moveDown(this.levelCleared),game.world.moveDown(this.levelCleared),game.world.moveDown(this.levelCleared),this.levelCleared.popUpAnimation();var e=game.add.image(0,0,null);e.grid=this.grid,e.shooter=this.shooter,e.wl=this.windowLayer;var i=this.getScore(),s=0;BUBBLE.levels[BUBBLE.currentLvlNr].starsRequirements.forEach((function(t,e){(i>t||0==e)&&s++})),e.prereward=BUBBLE.saveState.passLevel(BUBBLE.currentLvlNr,s),e.update=function(){if(0==this.grid.popOutGroup.length&&0==this.shooter.moves&&0==this.wl.length){var t=this.prereward;game.time.events.add(500,(function(){new BUBBLE.Window("levelEnd",t)})),this.destroy()}}}),this)},makeGoalTxt:function(){this.barImg=game.add.imageL(320,250,"goalbar"),this.barImg.anchor.setTo(.5,0);var t={Ghost:BUBBLE.txt("Free the ghost!"),Classic:BUBBLE.txt("Clear the top!"),Animals:BUBBLE.txt("Free all animals!"),Boss:BUBBLE.txt("Defeat the monster!")}[this.lvl.mode];if(this.goalTxt=new BUBBLE.OneLineText(320,300,"font-outline",t,60),this.goalTxt.width>BUBBLE.l(640)){var e=.5*(this.goalTxt.width-BUBBLE.l(640));this.goalTxt.width=BUBBLE.l(640),this.goalTxt.x+=e}this.lvl.time&&(this.timeLimitTxt=new BUBBLE.OneLineText(320,370,"font-outline",BUBBLE.txt("Time limit!"),30),this.goalTxt.timeLimitTxt=this.timeLimitTxt,this.timeLimitTxt.visible=!1,game.add.existing(this.timeLimitTxt)),"Ghost"!=this.lvl.mode&&(this.goalSubTxt=new BUBBLE.OneLineText(320,370,"font-outline",BUBBLE.txt("Goal")+": "+this.lvl.goalTarget,30),this.goalSubTxt.visible=!1,this.goalTxt.subTxt=this.goalSubTxt,game.add.existing(this.goalSubTxt)),this.goalTxt.active=10,this.goalTxt.timer=180,this.goalTxt.visible=!1,this.goalTxt.barImg=this.barImg,this.goalTxt.update=function(){this.y=game.camera.y+BUBBLE.l(370),this.barImg.y=game.camera.y+BUBBLE.l(350),this.timeLimitTxt&&this.subTxt?(this.y-=BUBBLE.l(30),this.subTxt.y=this.y+BUBBLE.l(100),this.timeLimitTxt.y=this.y+BUBBLE.l(70)):this.timeLimitTxt?(this.y-=BUBBLE.l(10),this.timeLimitTxt.y=this.y+BUBBLE.l(80)):this.subTxt&&(this.y-=BUBBLE.l(10),this.subTxt.y=this.y+BUBBLE.l(80)),0==this.wl.length&&(this.active>0?(this.active--,0==this.active&&(this.visible=!0,this.popUpAnimation(),this.timeLimitTxt&&(this.timeLimitTxt.visible=!0,this.timeLimitTxt.popUpAnimation()),this.subTxt&&(this.subTxt.visible=!0,this.subTxt.popUpAnimation()))):(this.timer--,0==this.timer&&(this.update=function(){},game.add.tween(this).to({alpha:0},1e3,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.destroy()}),this),game.add.tween(this.barImg).to({alpha:0},1e3,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.destroy()}),this.barImg),this.subTxt&&game.add.tween(this.subTxt).to({alpha:0},1e3,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.destroy()}),this.subTxt),this.timeLimitTxt&&game.add.tween(this.timeLimitTxt).to({alpha:0},1e3,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.destroy()}),this.timeLimitTxt))))},game.add.existing(this.goalTxt)},makeTimer:function(){this.timer=game.add.bitmapTextL(320,80,"font-outline",BUBBLE.utils.formatTime(this.lvl.time),60),this.timer.fixedToCamera=!0,this.timer.cameraOffset.x=.5*game.width,this.timer.cameraOffset.y=BUBBLE.horizontal?BUBBLE.l(-5):BUBBLE.l(80),this.timer.alpha=.5,this.timer.anchor.setTo(.5,0),this.timer.time=this.lvl.time,this.timer.timeInterval=60,this.timer.active=!0,this.timer.update=function(){BUBBLE.pause||this.wl.length>0||(this.timeInterval--,0==this.timeInterval&&this.time>0&&(this.timeInterval=60,this.time--,this.setText(BUBBLE.utils.formatTime(this.time)),0==this.time&&(game.incentivise||BUBBLE.saveState.getCoins()>=BUBBLE.settings.priceOfContinue?new BUBBLE.Window("continueFor"):new BUBBLE.Window("gameOver"))))},BUBBLE.events.onScreenResize.add((function(){this.timer.cameraOffset.x=.5*game.width,this.timer.cameraOffset.y=BUBBLE.horizontal?BUBBLE.l(-5):BUBBLE.l(80)}),this)},makeTutHand:function(){this.tuthand=game.add.image(this.shooter.x,this.shooter.y,"tuthand"),this.touchNumber,this.tuthand.active=!0,this.tuthand.shooter=this.shooter,this.tuthand.wL=this.windowLayer,this.tuthand.oX=0,this.tuthand.oY=0,this.tuthand.update=function(){this.x=this.shooter.x+this.oX,this.y=this.shooter.y+this.oY,this.active&&0==this.wL.length&&game.input.activePointer.isDown?(this.touchNumber++,5==this.touchNumber&&(this.active=!1,game.add.tween(this).to({alpha:0},500,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.destroy()}),this))):this.touchNumber=0},this.tuthand.pointCannon=function(){this.oYtween&&this.oYtween.stop(),this.oX=0,this.oY=0,game.add.tween(this).to({oX:BUBBLE.l(20),oY:BUBBLE.l(20)},250,Phaser.Easing.Sinusoidal.InOut,!0,0,3,!0).onComplete.add(this.pointSpace,this)},this.tuthand.pointSpace=function(){this.oY=BUBBLE.l(-200),this.oX=BUBBLE.l(-150),game.add.tween(this).to({oX:BUBBLE.l(150)},600,Phaser.Easing.Sinusoidal.InOut,!0,0,2,!0).onComplete.add(this.pointCannon,this),this.oYtween=game.add.tween(this).to({oY:BUBBLE.l(-270)},300,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0)},this.tuthand.pointCannon()},render:function(){}},BUBBLE.GameGrid=function(t){Phaser.Group.call(this,game),this.topGrid=game.add.imageL(0,3,"grid_top"),this.topGrid.anchor.setTo(0,1),this.offsetX=0,this.offsetY=0,this.gridArray=new BUBBLE.GridArray,this.nonCacheGroup=game.add.group(),this.nonCacheGroup.grid=this,this.matchGroup=game.add.group(),this.popOutGroup=null,this.bubbleFactory=new BUBBLE.BubbleFactory(this),this.cellW=BUBBLE.l(58),this.cellH=BUBBLE.l(51),this.holds=[],this.cachingCelling=!0,this.lvl=t,this.parseLevel(t),this.maxY=BUBBLE.l(400),this.targetY=this.getTargetY(),this.moveDelay=0,this.oldHeight=this.height,this.caching=!0,this.orderCacheAfterUpdate=!1,this.recacheBitmap(),BUBBLE.events.onBubblePutToGrid.add((function(){this.height!=this.oldHeight&&(this.targetY=this.getTargetY(),this.oldHeight=this.height)}),this),BUBBLE.events.onBubbleDestroyed.add((function(){this.height!=this.oldHeight&&(this.targetY=this.getTargetY(),this.oldHeight=this.height,this.moveDelay=30)}),this),BUBBLE.events.onShieldDefeated.add((function(t){var e=t.sides;this.destroyBubbles(e),this.checkAndProcessHold(),this.activeTheLowestShield(),this.recacheBitmap()}),this),BUBBLE.events.onBubbleStartBounce.add((function(t){t.animated||this.nonCacheGroup.add(t)}),this),BUBBLE.events.onBubbleFinishBounce.add((function(t){t.animated||this.add(t),this.orderCacheAfterUpdate=!0}),this),BUBBLE.events.requestDestroy.add((function(t){this.destroyBubbles([t]),this.checkAndProcessHold()}),this)},BUBBLE.GameGrid.prototype=Object.create(Phaser.Group.prototype),BUBBLE.GameGrid.constructor=BUBBLE.GameGrid,BUBBLE.GameGrid.prototype.getTargetY=function(){return Math.min(0,this.maxY-this.height)},BUBBLE.GameGrid.prototype.update=function(){this.orderCacheAfterUpdate&&this.recacheBitmap()},BUBBLE.GameGrid.prototype.updateChildren=function(){for(var t=this.length,e=0;e<t;e++)this.children[e].update()},BUBBLE.GameGrid.prototype.makeBubble=function(t,e,i){return this.orderCacheAfterUpdate=!0,this.bubbleFactory.makeBubble(t,e,i)},BUBBLE.GameGrid.prototype.isSpaceFreePx=function(t,e){var i=this.outsidePxToCell(t,e);return this.isSpaceFree(i[0],i[1])},BUBBLE.GameGrid.prototype.isSpaceFree=function(t,e){return!this.getBubble(t,e)},BUBBLE.GameGrid.prototype.outsidePxToCell=function(t,e){return this.insidePxToCell(t-this.x,e-this.y)},BUBBLE.GameGrid.prototype.insidePxToCell=function(t,e){var i,s,o,a;return i=(e+=BUBBLE.l(6))<0?e%this.cellH>BUBBLE.l(-34):e%this.cellH>BUBBLE.l(17),s=Math.floor(e/this.cellH),i||((o=(o=s%2==0?t%this.cellW:(t-.5*this.cellW)%this.cellW)<0?this.cellW+o:o)+(a=e>0?e%this.cellH:this.cellH-Math.abs(e%this.cellH))<BUBBLE.l(23)||o+a>BUBBLE.l(52))&&s--,[s%2==0?Math.floor(t/this.cellW):Math.floor((t-.5*this.cellW)/this.cellW),s]},BUBBLE.GameGrid.prototype.cellToInsidePx=function(t,e){return e%2==0?[Math.floor(t*this.cellW+.5*this.cellW-this.offsetX),Math.floor(e*this.cellH+.5*this.cellW-this.offsetY)]:[Math.floor(t*this.cellW+this.cellW-this.offsetX),Math.floor(e*this.cellH+.5*this.cellW-this.offsetY)]},BUBBLE.GameGrid.prototype.cellToOutsidePx=function(t,e){var i=this.cellToInsidePx(t,e);return i[1]+=this.y,i},BUBBLE.GameGrid.prototype.putBubble=function(t){var e=t.cellX,i=t.cellY;this.prepareBubbleToBePut(t);var s=this.makeBubble(e,i,t.type);if(s.x=t.x,s.y=t.y,s.velX=t.velX+100,s.velY=t.velY+100,"bomb"==t.type){var o=s.getToPopOut();BUBBLE.events.onBubblesPopOut.dispatch(o),o.forEach((function(t){t.onPopOut()})),this.checkAndProcessHold(),this.hitNeighboursOf(s)}else{var a=this.getMatching(e,i,t.type);a.length>2||"multicolor"==t.type?(game.sfx.l_pop.play(),this.processMatching(a),this.checkAndProcessHold()):(game.sfx["hit_"+game.rnd.between(1,3)].play(),BUBBLE.events.onBubblePutToGrid.dispatch(s),this.bounceBubbles(s)),this.hitNeighboursOf(s)}this.orderCacheAfterUpdate=!0},BUBBLE.GameGrid.prototype.prepareBubbleToBePut=function(t){},BUBBLE.GameGrid.prototype.outsidePxToInsidePx=function(t,e){return[t,e-this.y]},BUBBLE.GameGrid.prototype.checkCollisionAgainst=function(t,e){var i=this.prepareBubbleCollCircleToCollCheck(t);e.push(this.getBubble(t.cellX,t.cellY));if(this.cachingCelling&&0==t.cellY)return[t.cellX,t.cellY];for(var s=0;s<e.length;s++)if(e[s]&&Phaser.Circle.intersects(i,e[s].collCircle))return[e[s].cellX,e[s].cellY];return[]},BUBBLE.GameGrid.prototype.prepareBubbleCollCircleToCollCheck=function(t){var e=t.collCircle;return e.x=t.x,e.y=t.y-this.y,e},BUBBLE.GameGrid.prototype.processPreciseHits=function(t){var e=this.getNeighbours(t.cellX,t.cellY);e.push(this.getBubble(t.cellX,t.cellY));var i=this.prepareBubbleCollCircleToCollCheck(t),s=t.collCircle.diameter;t.collCircle.diameter=BUBBLE.l(50);for(var o=0;o<e.length;o++)e[o]&&Phaser.Circle.intersects(i,e[o].collCircle)&&e[o].onPreciseHit(t);t.collCircle.diameter=s},BUBBLE.GameGrid.prototype.hitNeighboursOf=function(t){this.getNeighbours(t.cellX,t.cellY).forEach((function(e){e.onHit(t)}))},BUBBLE.GameGrid.prototype.getBubble=function(t,e){return this.gridArray.get(t,e)},BUBBLE.GameGrid.prototype.neighboursCoordinations=[[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,0]],[[0,-1],[-1,0],[0,1],[1,-1],[1,1],[1,0]]],BUBBLE.GameGrid.prototype.outerRingCoordinations=[[[0,-2],[1,-2],[1,-1],[2,0],[1,1],[1,2],[0,2],[-1,2],[-2,1],[-2,0],[-2,1],[-1,-2]],[[0,-2],[1,-2],[2,-1],[2,0],[2,1],[1,2],[0,2],[-1,2],[-1,1],[-2,0],[-1,1],[-1,-2]]],BUBBLE.GameGrid.prototype.getNeighbours=function(t,e){var i=[];return this.neighboursCoordinations[Math.abs(e%2)].forEach((function(s){var o=this.getBubble(t+s[0],e+s[1]);o&&i.push(o)}),this),i},BUBBLE.GameGrid.prototype.getOuterRing=function(t,e){var i=[];return this.outerRingCoordinations[Math.abs(e%2)].forEach((function(s){var o=this.getBubble(t+s[0],e+s[1]);o&&i.push(o)}),this),i},BUBBLE.GameGrid.prototype.getFreeSpacesAround=function(t,e){var i=[];return this.neighboursCoordinations[Math.abs(e%2)].forEach((function(s){if(!this.getBubble(t+s[0],e+s[1])){var o=t+s[0],a=e+s[1];if(!this.ghostMode&&a<0)return;a%2==0?o>=0&&o<11&&i.push([o,a]):o>=0&&o<10&&i.push([o,a])}}),this),i},BUBBLE.GameGrid.prototype.getMatching=function(t,e,i){if("multicolor"==i)return this.getMatchingMulticolor(t,e);this.clearCheck();var s=[[t,e]],o=0;if(!this.getBubble(t,e))return!1;var a=[this.getBubble(t,e)];for(this.getBubble(t,e).checked=!0;o<s.length;){var n=this.getBubble(s[o][0],s[o][1]);o++;for(var h=this.getNeighbours(n.cellX,n.cellY),r=0;r<h.length;r++)h[r]&&h[r].checkType(i)&&(a.push(h[r]),s.push([h[r].cellX,h[r].cellY]))}return a},BUBBLE.GameGrid.prototype.getMatchingMulticolor=function(t,e){var i=[],s=this.getNeighbours(t,e),o=[];return s.forEach((function(t){1==t.type.length&&-1==o.indexOf(t.type)&&o.push(t.type)})),o.forEach((function(s,o){var a=this.getMatching(t,e,s);a.splice(0,1),i=Array.prototype.concat(i,a)}),this),i.push(this.getBubble(t,e)),i},BUBBLE.GameGrid.prototype.clearCheck=function(){this.forEach((function(t){t.clearCheck()})),this.nonCacheGroup.forEach((function(t){t.clearCheck()}))},BUBBLE.GameGrid.prototype.processMatching=function(t){BUBBLE.events.onBubblesMatch.dispatch(t),t.forEach((function(t){t.onMatch()})),this.hitMatchNeighbours(t)},BUBBLE.GameGrid.prototype.hitMatchNeighbours=function(t){var e=[];t.forEach((function(i){var s=e,o=t;this.getNeighbours(i.cellX,i.cellY).forEach((function(t){-1==o.indexOf(t)&&-1==s.indexOf(t)&&s.push(t)}))}),this),e.forEach((function(t){t.onMatchHit()}))},BUBBLE.GameGrid.prototype.destroyBubbles=function(t){t.forEach((function(t){this.gridArray.set(t.cellX,t.cellY,null),t.destroy(),BUBBLE.events.onBubbleDestroyed.dispatch(t)}),this),this.orderCacheAfterUpdate=!0},BUBBLE.GameGrid.prototype.outOfGrid=function(t){array.forEach((function(t){this.gridArray.set(t.cellX,t.cellY,null),BUBBLE.events.onBubbleDestroyed.dispatch(t)}),this),this.orderCacheAfterUpdate=!0},BUBBLE.GameGrid.prototype.checkAndProcessHold=function(){this.checkHold();var t=this.getAllNotChecked();0!=t.length&&(game.sfx.pop.play(),BUBBLE.events.onBubblesPopOut.dispatch(t),t.forEach((function(t){t.onPopOut()})))},BUBBLE.GameGrid.prototype.checkHold=function(){this.clearCheck(),this.holds.forEach((function(t){this.holdCheckFrom(t[0],t[1])}),this)},BUBBLE.GameGrid.prototype.holdCheckFrom=function(t,e){if(this.getBubble(t,e)&&!this.getBubble(t,e).checked){var i=[[t,e]],s=0;for(this.getBubble(t,e).checked=!0;s<i.length;){var o=this.getBubble(i[s][0],i[s][1]);s++;for(var a=this.getNeighbours(o.cellX,o.cellY),n=0;n<6;n++)a[n]&&!a[n].checked&&(a[n].checked=!0,i.push([a[n].cellX,a[n].cellY]))}}},BUBBLE.GameGrid.prototype.getAllNotChecked=function(){var t=[];return this.forEach((function(e){e.checked||t.push(e)})),this.nonCacheGroup.forEach((function(e){e.checked||t.push(e)})),t},BUBBLE.GameGrid.prototype.bounceBubbles=function(t){var e=this.getNeighbours(t.cellX,t.cellY),i=.5*game.math.distance(0,0,t.velX,t.velY);t.startBounce(t.velX,t.velY),e.forEach((function(e){var s=game.math.angleBetween(t.x,t.y,e.x,e.y),o=e.collCircle.diameter-game.math.distance(t.x,t.y,e.x,e.y)<0?.5:1,a=BUBBLE.utils.lengthdir_x(s,i*o,!0),n=BUBBLE.utils.lengthdir_y(s,i*o,!0);e.startBounce(a,n)}))},BUBBLE.GameGrid.prototype.parseLevel=function(t){var e=t.level,i=0,s=0;"Ghost"==t.mode&&(e.forEach((function(t){"GHOST"===t[2]&&(i=-1*t[0],s=-1*t[1])})),this.cachingCelling=!1,this.x=i*this.cellW*-1+this.offsetX,this.y=s*this.cellH*-1+this.offsetY,this.holds.push([0,0])),e.forEach((function(t){"SHIELD"==t[2].slice(0,6)&&(this.holds.push([t[0],t[1]]),this.cachingCelling=!1),this.makeBubble(t[0]+i,t[1]+s,t[2])}),this),"Classic"==t.mode||"Animals"==t.mode?this.holds=[[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0]]:"Boss"==t.mode&&this.activeTheLowestShield()},BUBBLE.GameGrid.prototype.getAllColorsOnBoard=function(){var t=[];return this.forEach((function(e){if(0==e.type||1==e.type||2==e.type||3==e.type||4==e.type||5==e.type){if("cham"==e.special)return;-1==t.indexOf(e.type)&&t.push(e.type)}else"SHIELD_"==e.type.slice(0,7)&&-1==t.indexOf(e.color)&&t.push(e.color)})),this.nonCacheGroup.forEach((function(e){if(0==e.type||1==e.type||2==e.type||3==e.type||4==e.type||5==e.type){if("cham"==e.special)return;-1==t.indexOf(e.type)&&t.push(e.type)}else"SHIELD_"==e.type.slice(0,7)&&-1==t.indexOf(e.color)&&t.push(e.color)})),t},BUBBLE.GameGrid.prototype.activeTheLowestShield=function(){var t=null;this.nonCacheGroup.forEach((function(e){"SHIELD_"==e.type.slice(0,7)&&(t=null===t||e.cellY>t.cellY?e:t)})),this.forEach((function(e){"SHIELD_"==e.type.slice(0,7)&&(t=null===t||e.cellY>t.cellY?e:t)})),t&&t.activateShield()},BUBBLE.GameGrid.prototype.recacheBitmap=function(){this.caching&&(this.orderCacheAfterUpdate=!1,this.updateCache())},BUBBLE.GameGrid.prototype.moveToPopOutGroup=function(t){this.gridArray.set(t.cellX,t.cellY,null),t.rotation=this.rotation,this.popOutGroup.add(t),BUBBLE.events.onBubbleOutOfGrid.dispatch(t)},BUBBLE.GameGrid.prototype.moveToMatchGroup=function(t){this.gridArray.set(t.cellX,t.cellY,null),t.rotation=this.rotation,this.matchGroup.add(t),BUBBLE.events.onBubbleOutOfGrid.dispatch(t)},BUBBLE.GameGrid.prototype.moveToNonCacheGroup=function(t){this.nonCacheGroup.add(t),this.orderCacheAfterUpdate=!0},BUBBLE.GameGrid.prototype.moveToCacheGroup=function(t){this.add(t),this.orderCacheAfterUpdate=!0},BUBBLE.GameGrid.prototype.getLowestBubble=function(){var t=0;return this.forEach((function(e){e.cellY>t&&(t=e.cellY)})),this.nonCacheGroup.forEach((function(e){e.cellY>t&&(t=e.cellY)})),t},BUBBLE.GameGrid.prototype.getBubblesInRange=function(t,e){var i=[];return this.forEach((function(s){s.cellY>=t&&s.cellY<=e&&i.push(s)})),this.nonCacheGroup.forEach((function(s){s.cellY>=t&&s.cellY<=e&&i.push(s)})),i},BUBBLE.GameGridBounceGroup=function(t){Phaser.Group.call(this,game),this.grid=t,this.x=this.grid.x;for(var e=0;e<10;e++){var i=game.make.image(0,0,null);i.anchor.setTo(.5),i.kill(),this.add(i)}this.activeBounces=[]},BUBBLE.GameGridBounceGroup.prototype=Object.create(Phaser.Group.prototype),BUBBLE.GameGridBounceGroup.constructor=BUBBLE.GameGridBounceGroup,BUBBLE.GameGridBounceGroup.prototype.update=function(){this.y=this.grid.y,this.angle=this.grid.angle,this.activeBounces.length>0&&this.activeBounces.forEach(this.updateBounceObject,this)},BUBBLE.GameGridBounceGroup.prototype.initBubble=function(t){var e=this.getFirstDead();return null==e?null:(e.revive(),e.x=t.orgX,e.y=t.orgY,e.loadTexture("ssheet",t.frameName),e)},BUBBLE.GameGridBounceGroup.prototype.updateBounceObject=function(t){if(0==t.duringAnimation){t.realBubbles.forEach((function(t){t.alive&&(t.visible=!0)}));var e=this.activeBounces.indexOf(t);this.activeBounces.splice(e,1),this.grid.recacheBitmap(),t.fakeBubbles.forEach((function(t){t.kill()}))}},BUBBLE.GameGridBounceGroup.prototype.bounceCircular=function(t){if(0!=t.length){var e,i={duringAnimation:0,realBubbles:t,fakeBubbles:[]},s=t[0];if(t[0].visible=!1,(e=this.initBubble(t[0])).x=s.x,e.y=s.y,t[0].x=t[0].orgX,t[0].y=t[0].orgY,null!=e){i.fakeBubbles.push(e),i.duringAnimation++,game.add.tween(e).to({x:t[0].orgX,y:t[0].orgY},400,Phaser.Easing.Sinusoidal.Out,!0).onComplete.add((function(){i.duringAnimation--}),e);for(var o=1;o<t.length;o++)if(t[o].bounceable&&!t[o].animated&&t[o].alive){if(t[o].visible=!1,null==(e=this.initBubble(t[o])))break;var a=game.math.angleBetweenPoints(s.position,e.position),n=BUBBLE.utils.lengthdir_x(a,10,!0),h=BUBBLE.utils.lengthdir_y(a,10,!0);i.fakeBubbles.push(e),i.duringAnimation++,game.add.tween(e).to({x:e.x+n,y:e.y+h},200,Phaser.Easing.Sinusoidal.Out,!0,0,0,!0).onComplete.add((function(){i.duringAnimation--}),e)}i.duringAnimation>0&&this.activeBounces.push(i)}}},BUBBLE.GameGridEditor=function(t){Phaser.Group.call(this,game),this.offsetX=0,this.offsetY=0,this.lvl=t,this.initGrid(11,1),this.cursors=game.input.keyboard.createCursorKeys(),this.element=!1,this.mode="Classic",this.lockInput=!1,this.previewImage=game.add.image(0,0,null),this.previewImage.anchor.setTo(.5,.5),this.previewImage.alpha=.8,this.shooterLine=game.add.image(0,700,"esheet","warning_line"),this.shooterLine.visible=!1,BUBBLE.events.onToolChange.add((function(t){this.element=t,this.previewImage.loadTexture(t[1],t[2])}),this),BUBBLE.events.onDeleteAllElements.add((function(){var t=[];this.forEach((function(e){t.push(e)})),this.destroyBubbles(t)}),this),BUBBLE.events.onModeChange.add((function(t){this["changeFrom"+this.mode]&&this["changeFrom"+this.mode](),this.mode=t,this["changeTo"+t]&&this["changeTo"+t]()}),this),game.input.onDown.add((function(t){this.lockInput||t.worldX>0&&t.worldX<640&&this.processClick(t.worldX,t.worldY)}),this),this.importLevel(this.lvl.level)},BUBBLE.GameGridEditor.prototype=Object.create(Phaser.Group.prototype),BUBBLE.GameGridEditor.constructor=BUBBLE.GameGridEditor,BUBBLE.GameGridEditor.prototype.initGrid=function(t,e){this.cellW=58,this.cellH=51,this.gridArray=new BUBBLE.GridArray},BUBBLE.GameGridEditor.prototype.getTargetY=function(){return Math.min(0,this.maxY-this.height)},BUBBLE.GameGridEditor.prototype.update=function(){this.cursors.down.isDown&&(this.y-=10),this.cursors.up.isDown&&(this.y+=10),this.y=Math.min(0,this.y),"Ghost"==this.mode&&(this.y=0),this.mode;var t=this.outsidePxToCell(game.input.activePointer.worldX,game.input.activePointer.worldY);if(this.isCellValid(t)){var e=this.cellToOutsidePx(t[0],t[1]);this.previewImage.visible=!0,this.previewImage.x=e[0],this.previewImage.y=e[1]}else this.previewImage.visible=!1;if(game.input.activePointer.isDown){var i=game.input.activePointer;if(this.lockInput)return;i.worldX>0&&i.worldX<640&&this.processClick(i.worldX,i.worldY)}},BUBBLE.GameGridEditor.prototype.makeBubble=function(t,e,i){var s=this.cellToInsidePx(t,e),o=new BUBBLE.Bubble(t,e,s[0],s[1],"0");return o.type=i[0],o.loadTexture(i[1],i[2]),this.gridArray.set(t,e,o),this.add(o),o},BUBBLE.GameGridEditor.prototype.processClick=function(t,e){if(this.element){var i=this.outsidePxToCell(t,e);if(this.isCellValid(i))if("ERASER"==this.element[0]){var s=this.getBubble(i[0],i[1]);s&&"SHIELD"==s.type.slice(0,6)?this.destroyShield(i[0],i[1]):s&&this.destroyBubbles([this.getBubble(i[0],i[1])])}else if("GHOST"==this.element[0]){var o=null;this.forEach((function(t){"GHOST"==t.type&&(o=t)})),null!==o&&this.destroyBubbles([o]),(a=this.getBubble(i[0],i[1]))&&this.destroyBubbles([this.getBubble(i[0],i[1])]),this.makeBubble(i[0],i[1],this.element)}else if("SHIELD"==this.element[0].slice(0,6))this.makeShield(i[0],i[1],this.element);else{var a;if(a=this.getBubble(i[0],i[1])){if("SHIELD"==a.type.slice(0,6))return;this.destroyBubbles([this.getBubble(i[0],i[1])])}this.makeBubble(i[0],i[1],this.element)}}},BUBBLE.GameGridEditor.prototype.makeShield=function(t,e,i){if(!(0==t||10==t&&e%2==0||9==t&&e%2==1||0==e)){var s=this.getNeighbours(t,e);s.push(this.getBubble(t,e));var o=!1;if(s.forEach((function(t){t&&"SHIELD"==t.type.slice(0,6)&&(o=!0)})),!o){this.destroyBubbles(s);var a=this.makeBubble(t,e,i);a.centerOfShield=a,this.makeBubble(t-1,e,["SHIELD",null,null]).centerOfShield=a,this.makeBubble(t+1,e,["SHIELD",null,null]).centerOfShield=a;var n=e%2==0?-1:0;this.makeBubble(t+n,e-1,["SHIELD",null,null]).centerOfShield=a,this.makeBubble(t+n+1,e-1,["SHIELD",null,null]).centerOfShield=a,this.makeBubble(t+n,e+1,["SHIELD",null,null]).centerOfShield=a,this.makeBubble(t+n+1,e+1,["SHIELD",null,null]).centerOfShield=a}}},BUBBLE.GameGridEditor.prototype.destroyShield=function(t,e){var i=this.getBubble(t,e).centerOfShield,s=this.getNeighbours(i.cellX,i.cellY);s.push(this.getBubble(i.cellX,i.cellY)),this.destroyBubbles(s)},BUBBLE.GameGridEditor.prototype.isCellValid=function(t){return!(t[1]<0)&&(t[1]%2==0?t[0]>=0&&t[0]<=10:t[0]>=0&&t[0]<=9)},BUBBLE.GameGridEditor.prototype.isSpaceFreePx=function(t,e){var i=this.outsidePxToCell(t,e);return this.isSpaceFree(i[0],i[1])},BUBBLE.GameGridEditor.prototype.isSpaceFree=function(t,e){return!this.getBubble(t,e)},BUBBLE.GameGridEditor.prototype.outsidePxToCell=function(t,e){return this.insidePxToCell(t-this.x,e-this.y)},BUBBLE.GameGridEditor.prototype.insidePxToCell=function(t,e){var i,s,o,a;return i=e<0?e%51>-34:e%51>17,s=Math.floor(e/51),i||((o=(o=s%2==0?t%58:(t-29)%58)<0?58+o:o)+(a=e>0?e%51:51-Math.abs(e%51))<23||o+a>52)&&s--,[s%2==0?Math.floor(t/58):Math.floor((t-29)/58),s]},BUBBLE.GameGridEditor.prototype.cellToInsidePx=function(t,e){return e%2==0?[t*this.cellW+.5*this.cellW-this.offsetX,e*this.cellH+.5*this.cellW-this.offsetY]:[t*this.cellW+this.cellW-this.offsetX,e*this.cellH+.5*this.cellW-this.offsetY]},BUBBLE.GameGridEditor.prototype.cellToOutsidePx=function(t,e){return e%2==0?[t*this.cellW+.5*this.cellW-this.offsetX,e*this.cellH+.5*this.cellW-this.offsetY+this.y]:[t*this.cellW+this.cellW-this.offsetX,e*this.cellH+.5*this.cellW-this.offsetY+this.y]},BUBBLE.GameGridEditor.prototype.outsidePxToInsidePx=function(t,e){return[t,e-this.y]},BUBBLE.GameGridEditor.prototype.getBubble=function(t,e){return this.gridArray.get(t,e)},BUBBLE.GameGridEditor.prototype.getNeighbours=function(t,e){return e%2==0?[this.getBubble(t-1,e-1),this.getBubble(t-1,e),this.getBubble(t-1,e+1),this.getBubble(t,e-1),this.getBubble(t,e+1),this.getBubble(t+1,e)]:[this.getBubble(t,e-1),this.getBubble(t-1,e),this.getBubble(t,e+1),this.getBubble(t+1,e-1),this.getBubble(t+1,e+1),this.getBubble(t+1,e)]},BUBBLE.GameGridEditor.prototype.destroyBubbles=function(t){t.forEach((function(t){t&&(this.gridArray.set(t.cellX,t.cellY,null),t.destroy(),BUBBLE.events.onBubbleDestroyed.dispatch(t))}),this)},BUBBLE.GameGridEditor.prototype.changeFromGhost=function(){this.shooterLine.visible=!1,this.y=0;var t=[];this.forEach((function(e){"GHOST"==e.type&&t.push(e)})),this.destroyBubbles(t)},BUBBLE.GameGridEditor.prototype.changeToGhost=function(){this.shooterLine.visible=!0,this.y=0;var t=[];this.forEach((function(e){e.cellY>12&&t.push(e)})),this.destroyBubbles(t)},BUBBLE.GameGridEditor.prototype.changeFromAnimals=function(){var t=[];this.forEach((function(e){"ANIMAL"==e.type&&t.push(e)})),this.destroyBubbles(t)},BUBBLE.GameGridEditor.prototype.changeFromBoss=function(){var t=[];this.forEach((function(e){"SHIELD"==e.type.slice(0,6)&&t.push(e)})),this.destroyBubbles(t)},BUBBLE.GameGridEditor.prototype.exportLevel=function(){if(!this.checkConditionsToExportLevel())return null;var t=[];return this.setGoalTarget(),this.forEach((function(e){"SHIELD"!==e.type&&t.push([e.cellX,e.cellY,e.type])})),t},BUBBLE.GameGridEditor.prototype.importLevel=function(t){var e={};Array.prototype.concat(BUBBLE.e_elements.common_elements,BUBBLE.e_elements.special_elements).forEach((function(t){e[t[0]]=t})),t.forEach((function(t){"SHIELD"==t[2].slice(0,6)?this.makeShield(t[0],t[1],e[t[2]]):this.makeBubble(t[0],t[1],e[t[2]])}),this)},BUBBLE.GameGridEditor.prototype.checkConditionsToExportLevel=function(){var t=!1;if("Classic"==this.mode){var e=0;this.forEach((function(t){0==t.cellY&&e++})),(t=e>=6)||alert("Level should have at least 6 bubbles in top row (to hold bubbles below)!")}else"Animals"==this.mode?(this.forEach((function(e){0==e.cellY&&(t=!0)})),t||alert("Level should have at least 1 bubbles in top row (to hold bubbles below)!")):"Ghost"==this.mode?(this.forEach((function(e){"GHOST"==e.type&&(t=!0)})),t||alert("Level should have GHOST!")):"Boss"==this.mode&&(this.forEach((function(e){"SHIELD"==e.type.slice(0,6)&&(t=!0)})),t||alert("Level should have at least one boss shield!"));return t},BUBBLE.GameGridEditor.prototype.setGoalTarget=function(){switch(this.lvl.mode){case"Classic":this.lvl.goalTarget=6;break;case"Ghost":this.lvl.goalTarget=1;break;case"Animals":var t=0;this.forEach((function(e){"ANIMAL"==e.type&&t++})),this.lvl.goalTarget=t;break;case"Boss":var e=0;this.forEach((function(t){"SHIELD_"==t.type.slice(0,7)&&e++})),this.lvl.goalTarget=e}},BUBBLE.GameGridGhost=function(t){this.topGrid=game.add.imageL(0,3,"grid_top"),this.topGrid.anchor.setTo(0,1),Phaser.Group.call(this,game),this.offsetX=BUBBLE.l(29),this.offsetY=BUBBLE.l(26),this.gridArray=new BUBBLE.GridArray,this.nonCacheGroup=game.add.group(),this.nonCacheGroup.grid=this,this.matchGroup=game.add.group(),this.popOutGroup=null,this.bubbleFactory=new BUBBLE.BubbleFactory(this),this.cellW=BUBBLE.l(58),this.cellH=BUBBLE.l(51),this.holds=[],this.cachingCelling=!1,this.lvl=t,this.angleSpd=0,this.maxY=BUBBLE.l(650),this.ghostMode=!0,this.bubblesCloseToEdge=[],this.closeToEdgeBorder=BUBBLE.l(50),this.parseLevel(t),this.caching=!0,this.orderCacheAfterUpdate=!1,this.recacheBitmap(),BUBBLE.events.onBubbleDestroyed.add((function(t){1==this.length&&0==this.nonCacheGroup.length&&(BUBBLE.events.onGhostFree.dispatch(this.getBubble(0,0)),this.destroyBubbles([this.getBubble(0,0)]));var e=this.bubblesCloseToEdge.indexOf(t);-1!==e&&this.bubblesCloseToEdge.splice(e,1)}),this),BUBBLE.events.onMoveDone.add((function(t){0==this.length&&1==this.nonCacheGroup.length&&BUBBLE.events.onGhostFree.dispatch(this.getBubble(0,0))}),this),BUBBLE.events.onBubbleStartBounce.add((function(t){t.animated||this.nonCacheGroup.add(t)}),this),BUBBLE.events.onBubbleFinishBounce.add((function(t){t.animated||this.add(t),this.orderCacheAfterUpdate=!0}),this)},BUBBLE.GameGridGhost.prototype=Object.create(BUBBLE.GameGrid.prototype),BUBBLE.GameGridGhost.constructor=BUBBLE.GameGridGhost,BUBBLE.GameGridGhost.prototype.makeBubble=function(){var t=BUBBLE.GameGrid.prototype.makeBubble;return function(e,i,s){var o=t.call(this,e,i,s);return o.collCircle.x+=this.x,o.collCircle.y+=this.y,game.math.distance(0,0,o.x,o.y)>Math.min(this.x,BUBBLE.l(960)-this.x,this.y,this.maxY-this.y)-this.closeToEdgeBorder&&this.bubblesCloseToEdge.push(o),o}}(),BUBBLE.GameGridGhost.prototype.update=function(){this.angle+=this.angleSpd,Math.abs(this.angleSpd)>.005?(this.angleSpd*=.99,this.checkBubblesCloseToEdge()):this.angleSpd=0,this.matchGroup.x=this.x,this.matchGroup.y=this.y,this.matchGroup.rotation=this.rotation,this.nonCacheGroup.x=this.x,this.nonCacheGroup.y=this.y,this.nonCacheGroup.rotation=this.rotation,this.orderCacheAfterUpdate&&(this.recacheBitmap(),this.orderCacheAfterUpdate=!1)},BUBBLE.GameGridGhost.prototype.checkBubblesCloseToEdge=function(){for(var t,e=0;e<this.bubblesCloseToEdge.length;e++)if((t=this.insidePxToOutsidePx(this.bubblesCloseToEdge[e].x,this.bubblesCloseToEdge[e].y))[0]<this.closeToEdgeBorder||t[0]>this.maxY-this.closeToEdgeBorder||t[1]<this.closeToEdgeBorder||t[1]>this.maxY-this.closeToEdgeBorder)return this.bubblesCloseToEdge[e].onPopOut(),this.bubblesCloseToEdge.splice(e,1),this.checkAndProcessHold(),void(this.orderCacheAfterUpdate=!0)},BUBBLE.GameGridGhost.prototype.outsidePxToCell=function(t,e){var i=this.outsidePxToInsidePx(t,e);return this.insidePxToCell(i[0],i[1])},BUBBLE.GameGridGhost.prototype.cellToOutsidePx=function(t,e){var i=this.cellToInsidePx(t,e);return this.insidePxToOutsidePx(i[0],i[1])},BUBBLE.GameGridGhost.prototype.prepareBubbleToBePut=function(t){t.x-=this.x,t.y-=this.y;var e=Math.sin(-this.rotation),i=Math.cos(-this.rotation),s=i*t.x-e*t.y,o=e*t.x+i*t.y;t.x=s,t.y=o;var a=game.math.angleBetween(0,0,t.velX,t.velY),n=game.math.distance(0,0,t.velX,t.velY);t.velX=BUBBLE.utils.lengthdir_x(a-this.rotation,n,!0),t.velY=BUBBLE.utils.lengthdir_y(a-this.rotation,n,!0)},BUBBLE.GameGridGhost.prototype.prepareBubbleCollCircleToCollCheck=function(t){var e=t.collCircle;e.x=t.x,e.y=t.y,e.x-=this.x,e.y-=this.y;var i=Math.sin(-this.rotation),s=Math.cos(-this.rotation),o=s*e.x-i*e.y,a=i*e.x+s*e.y;return e.x=o+this.x,e.y=a+this.y,e},BUBBLE.GameGrid.prototype.outsidePxToInsidePx=function(t,e){t-=this.x,e-=this.y;var i=Math.sin(-this.rotation),s=Math.cos(-this.rotation),o=i*t+s*e;return t=s*t-i*e+this.x,e=o+this.y,[t-this.x+this.offsetX,e-this.y+this.offsetY]},BUBBLE.GameGrid.prototype.popOutAll=function(){this.children.slice().forEach((function(t){t.onPopOut()})),this.nonCacheGroup.children.slice().forEach((function(t){t.onPopOut()})),this.orderCacheAfterUpdate=!0},BUBBLE.GameGridGhost.prototype.insidePxToOutsidePx=function(t,e){var i=Math.sin(this.rotation),s=Math.cos(this.rotation),o=i*t+s*e;return t=s*t-i*e,e=o,[t+=this.x,e+=this.y]},BUBBLE.GameGridGhost.prototype.bounceBubbles=function(){var t=BUBBLE.GameGrid.prototype.bounceBubbles;return function(e){var i=e.getWorldPosition(),s=game.math.distance(0,0,e.x,e.y),o=game.math.angleBetween(this.x,this.y,i[0],i[1]),a=Phaser.Point.rotate(new Phaser.Point(e.velX,e.velY),0,0,this.rotation);a.rotate(0,0,-o);var n=game.math.radToDeg(game.math.angleBetween(0,0,a.x,a.y)),h=3*(n>0?(90-Math.abs(90-n))/90:(90-Math.abs(90-Math.abs(n)))/90*-1)*(s/BUBBLE.l(200));this.angleSpd=game.math.clamp(this.angleSpd+h,-3,3),t.call(this,e)}}(),BUBBLE.GameGridGhost.prototype.moveToPopOutGroup=function(t){this.gridArray.set(t.cellX,t.cellY,null),t.rotation=this.rotation;var e=t.getWorldPosition();t.x=e[0],t.y=e[1],this.popOutGroup.add(t),BUBBLE.events.onBubbleOutOfGrid.dispatch(t)},BUBBLE.GameGridGhost.prototype.moveToMatchGroup=function(t){this.gridArray.set(t.cellX,t.cellY,null),this.matchGroup.add(t),BUBBLE.events.onBubbleOutOfGrid.dispatch(t)},BUBBLE.GridArray=function(t,e,i,s){this.minX=t||!1,this.maxX=e||!1,this.minY=i||!1,this.maxY=s||!1,this.limited=this.minX||this.maxX||this.minY||this.maxY,this.mainArray=[],this.maxIndexX=!1,this.minIndexX=!1,this.maxIndexY=!1,this.minIndexY=!1},BUBBLE.GridArray.prototype.set=function(t,e,i){if(t.constructor===Array&&(i=e,e=t[1],t=t[0]),this.limited&&!this.inLinit(t,e))throw"Out of limit!";return this.mainArray[t]||(this.mainArray[t]=[]),this.mainArray[t][e]=i,this.setHelperValues(t,e),i},BUBBLE.GridArray.prototype.get=function(t,e){if(t.constructor===Array&&(e=t[1],t=t[0]),this.limited&&!this.inLimit(t,e))throw"Out of limit!";return this.mainArray[t]&&this.mainArray[t][e]?this.mainArray[t][e]:null},BUBBLE.GridArray.prototype.inLimit=function(t,e){return!(!1!==this.minX&&t<this.minX)&&(!(!1!==this.maxX&&t>this.maxX)&&(!(!1!==this.minY&&e<this.minY)&&!(!1!==this.maxY&&e>this.maxY)))},BUBBLE.GridArray.prototype.setHelperValues=function(t,e){!1===this.maxIndexX?(this.maxIndexX=t,this.minIndexX=t,this.lengthX=1,this.maxIndexY=e,this.minIndexY=e,this.lengthY=1):(this.minIndexX=t<this.minIndexX?t:this.minIndexX,this.maxIndexX=t>this.maxIndexX?t:this.maxIndexX,this.minIndexY=e<this.minIndexY?e:this.minIndexY,this.maxIndexY=e>this.maxIndexY?e:this.maxIndexY)},BUBBLE.LevelButton=function(t,e,i){BUBBLE.Button.call(this,t[0],t[1],"map_lvl_point0"),this.over=!1,this.onInputOver.add((function(){this.over=!0}),this),this.onInputOut.add((function(){this.over=!1}),this),this.addTerm((function(){return this.over}),this),this.onClick.add((function(){BUBBLE.events.onChangeLevel.dispatch("Game",this.nr)}),this),this.nr=e,this.nrTxt=game.make.bitmapTextL(0,-10,"font",(e+1).toString(),40),this.nrTxt.anchor.setTo(.5),this.addChild(this.nrTxt),this.locked=!1,BUBBLE.saveState.isUnlocked(this.nr)?(this.stars=BUBBLE.saveState.getStars(this.nr),3==this.stars?this.loadTexture("ssheet","map_lvl_point2"):this.stars>0&&this.loadTexture("ssheet","map_lvl_point1"),this.stars>0&&(this.starImg=game.add.imageL(-2,10,"lvl_star_"+this.stars),this.starImg.anchor.setTo(.5,0),this.addChild(this.starImg))):(this.locked=!0,this.alpha=.35,this.inputEnabled=!1,this.active=!1)},BUBBLE.LevelButton.prototype=Object.create(BUBBLE.Button.prototype),BUBBLE.LevelButton.constructor=BUBBLE.LevelButton,BUBBLE.MainMenu=function(t){},BUBBLE.MainMenu.prototype={init:function(){game.renderer.clearBeforeRender=!1,BUBBLE.events.clear(),game.sfx.music.isPlaying||BUBBLE.saveState.data.mute||game.sfx.music.play("",0,game.ie10?1:.3,!0)},create:function(){sgSdk.trigger("start"),this.bg=BUBBLE.bg.addImgToWorld("main_menu_backgr",!0),this.mainGroup=game.add.group(),this.teddy=game.add.imageL(400,700,"teddy"),this.teddy.anchor.setTo(1),game.add.tween(this.teddy).to({y:BUBBLE.l(650)},2e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),this.logo=game.add.imageL(320,200,"logo"),this.logo.anchor.setTo(.5),this.logo.angle=-10,game.add.tween(this.logo).to({angle:10},3e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),game.add.tween(this.logo.scale).to({x:1.2},2800,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),game.add.tween(this.logo.scale).to({x:1.2},2600,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),this.mainMenuWin=new BUBBLE.Window("mainMenu"),this.mainMenuWin.x=BUBBLE.l(320),this.mainMenuWin.y=BUBBLE.l(700),this.mainGroup.addMultiple([this.teddy,this.logo,this.mainMenuWin]),this.mainGroup.y=.5*(game.height-BUBBLE.l(960)),BUBBLE.events.onScreenResize.add((function(){this.mainGroup.y=.5*(game.height-BUBBLE.l(960))}),this),this.makeEditorGate(),this.fadeLayer=new BUBBLE.FadeLayer},update:function(){},render:function(){},makeEditorGate:function(){this.keys=game.input.keyboard.addKeys({e:Phaser.Keyboard.E,d:Phaser.Keyboard.D}),this.keys.successfulPresses=0,this.keys.lastKeyPressed=null,this.keys.e.onDown.add((function(){"d"===this.keys.lastKeyPressed||null===this.keys.lastKeyPressed?(this.keys.successfulPresses++,this.keys.lastKeyPressed="e",10==this.keys.successfulPresses&&game.state.start("EditorWorld")):(this.keys.lastKeyPressed=null,this.keys.successfulPresses=0)}),this),this.keys.d.onDown.add((function(){"e"===this.keys.lastKeyPressed?(this.keys.successfulPresses++,this.keys.lastKeyPressed="d",10==this.keys.successfulPresses&&game.state.start("EditorWorld")):(this.keys.lastKeyPressed=null,this.keys.successfulPresses=0)}),this)}},BUBBLE.MenuWorld=function(t){},BUBBLE.MenuWorld.prototype={init:function(){BUBBLE.events.clear()},create:function(){this.worldMap=new BUBBLE.WorldMap,this.worldMap.editorMode=!0,wm=this.worldMap,this.windowLayer=new BUBBLE.WindowLayer,this.menuBtn=new BUBBLE.Button(0,0,"btn_menu",(function(){BUBBLE.events.onChangeLevel.dispatch("MainMenu")}),this),game.add.existing(this.menuBtn),this.menuBtn.fixedToCamera=!0,this.menuBtn.cameraOffset.x=BUBBLE.l(80),this.menuBtn.cameraOffset.y=BUBBLE.l(80),this.soundButton=new BUBBLE.Button(-160,140,BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on",(function(){BUBBLE.saveState.data.mute=!BUBBLE.saveState.data.mute,BUBBLE.saveState.save(),this.loadTexture("ssheet",BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on"),BUBBLE.saveState.data.mute?game.sound.stopAll():game.sfx.music.paused?game.sfx.music.resume():game.sfx.music.play("",0,game.ie10?1:.3,!0)})),this.soundButton.fixedToCamera=!0,this.soundButton.cameraOffset.x=game.width-BUBBLE.l(80),this.soundButton.cameraOffset.y=BUBBLE.l(80),game.add.existing(this.soundButton),BUBBLE.events.onScreenResize.add((function(){this.soundButton.cameraOffset.x=game.width-BUBBLE.l(80)}),this),this.fadeLayer=new BUBBLE.FadeLayer},update:function(){},render:function(){}},BUBBLE.MultiLineText=function(t,e,i,s,o,a,n,h){t=BUBBLE.l(t),e=BUBBLE.l(e),o=BUBBLE.l(o),a=BUBBLE.l(a),n=BUBBLE.l(n);Phaser.BitmapText.call(this,game,t,e,i,"",o);for(var r=s,l=[],B=0,d=0;r.length>0;)if(B=d,-1==(d=r.indexOf(" ",d+1))?this.setText(r):this.setText(r.substring(0,d)),this.updateText(),this.width>a){if(0==B&&-1==d){l.push(r),r="",d=0;continue}if(0==B){l.push(r.substring(0,d)),r=r.substring(d+1),d=0;continue}l.push(r.substring(0,B)),r=r.substring(B+1),d=0}else-1==d&&(l.push(r),r="");this.setText(l.join("\n")),this.updateText(),this.align=h||"center",this.insertCoin(o),this.height=Math.floor(Math.min(this.height,n||this.height)),this.cacheAsBitmap=!0,this.x-=Math.floor(.5*this.width)},BUBBLE.MultiLineText.prototype=Object.create(Phaser.BitmapText.prototype),BUBBLE.MultiLineText.prototype.insertCoin=function(t){-1!=this.text.indexOf("$$")&&this.children.forEach((function(e,i,s){if(e.name&&"$"==e.name&&e.visible&&i+1<=s.length-1&&"$"==s[i].name){var o=e,a=s[i+1];o.visible=!1,a.visible=!1,coin=game.add.image(o.x+.05*t,o.y-.05*t,"ssheet","coin"),coin.width=.9*t,coin.height=.9*t,o.parent.addChild(coin)}}))},BUBBLE.OneLineText=function(t,e,i,s,o,a){t=BUBBLE.l(t),e=BUBBLE.l(e),o=BUBBLE.l(o),a=BUBBLE.l(a);Phaser.BitmapText.call(this,game,t,e,i,s,o,a),this.insertCoin(o),this.cacheAsBitmap=!0,this.width=Math.min(this.width,a||this.width),this.width=Math.floor(this.width),this.x-=Math.floor(.5*this.width)},BUBBLE.OneLineText.prototype=Object.create(Phaser.BitmapText.prototype),BUBBLE.OneLineText.prototype.insertCoin=function(t){-1!=this.text.indexOf("$$")&&this.children.forEach((function(e,i,s){if(e.name&&"$"==e.name&&e.visible&&i+1<=s.length-1&&"$"==s[i].name){var o=e,a=s[i+1];o.visible=!1,a.visible=!1,coin=game.add.image(o.x+.05*t,o.y-.05*t,"ssheet","coin"),coin.width=t,coin.height=t,o.parent.addChild(coin)}}))},BUBBLE.OneLineText.prototype.popUpAnimation=function(){this.cacheAsBitmap=!1;for(var t=this.children.length,e=[],i=0;i<t;i++)e[i]=i;e=Phaser.ArrayUtils.shuffle(e),delay_index=0,this.children.forEach((function(t){0==t.anchor.x&&(t.x=t.x+.5*t.width,t.y=t.y+t.height,t.anchor.setTo(.5,1));var i=t.scale.x;t.scale.setTo(0,0),game.add.tween(t.scale).to({x:1.5*i,y:1.5*i},200,Phaser.Easing.Quadratic.In,!1,20*e[delay_index]).to({x:i,y:i},200,Phaser.Easing.Sinusoidal.In).start(),delay_index++}))},BUBBLE.PopOutBubble=function(){Phaser.Sprite.call(this,game,0,0,null),this.anchor.setTo(.5),this.velX=0,this.velY=0,this.gravity=BUBBLE.lnf(.25),this.initVelX=BUBBLE.lnf(4),this.initVelY=BUBBLE.lnf(-5),this.minX=BUBBLE.lnf(40),this.maxX=BUBBLE.lnf(600),this.kill()},BUBBLE.PopOutBubble.prototype=Object.create(Phaser.Sprite.prototype),BUBBLE.PopOutBubble.constructor=BUBBLE.PopOutBubble,BUBBLE.PopOutBubble.prototype.init=function(t){var e=t.getWorldPosition();this.x=e[0],this.y=e[1],this.angle=t.getWorldAngle(),this.loadTexture("ssheet",t.frameName),this.velX=-.5*this.initVelX+Math.random()*this.initVelX,this.velY=Math.random()*this.initVelY,this.revive()},BUBBLE.PopOutBubble.prototype.update=function(){if(this.alive){if(this.x+=this.velX,this.y+=this.velY,this.velY+=this.gravity,this.angle+=this.velX,this.x<this.minX||this.x>this.maxX){var t=this.x<this.minX?this.minX-this.x:this.maxX-this.x;this.x=game.math.clamp(this.x,this.minX,this.maxX)+t,this.velX*=-1}this.y>game.world.bounds.y+game.height+50&&(BUBBLE.events.onPopOutDestroyed.dispatch(this),this.kill())}},BUBBLE.PotsGroup=function(t){Phaser.Group.call(this,game),this.offsetY=BUBBLE.l(960),this.pots=game.add.imageL(320,0,"pots"),this.pots.additionalOffsetY=BUBBLE.l(10),this.pots.anchor.setTo(.5,1),this.pots.fixedToCamera=!0,this.bubbles=game.add.group(),this.initLightsGroup(),this.initParticlesEmitter(),this.initColliders(),this.potsFront=game.add.imageL(320,0,"pots_fronts"),this.potsFront.anchor.setTo(.5,1),this.potsFront.fixedToCamera=!0,BUBBLE.events.onScreenResize.add(this.resize,this),BUBBLE.events.onPopOutDestroyed.add(this.processPopOutDestroyed,this),this.resize()},BUBBLE.PotsGroup.prototype=Object.create(Phaser.Group.prototype),BUBBLE.PotsGroup.constructor=BUBBLE.PotsGroup,BUBBLE.PotsGroup.prototype.update=function(){this.colliders.forEach(this.updateCollider,this),this.bubbles.children.forEach(this.checkCollision,this),this.lightsGroup.forEach(this.updateLights)},BUBBLE.PotsGroup.prototype.resize=function(){this.pots.cameraOffset.x=Math.floor(Math.abs(game.world.bounds.x)+BUBBLE.l(320)),this.pots.cameraOffset.y=Math.floor(Math.abs(game.world.bounds.y)+BUBBLE.l(960)+BUBBLE.l(10)),this.potsFront.cameraOffset.x=this.pots.cameraOffset.x,this.potsFront.cameraOffset.y=this.pots.cameraOffset.y,this.lightsGroup.cameraOffset.x=this.pots.cameraOffset.x,this.lightsGroup.cameraOffset.y=Math.abs(game.world.bounds.y)+BUBBLE.l(960),this.particlesEmitter.cameraOffset.x=this.pots.cameraOffset.x,this.particlesEmitter.cameraOffset.y=this.lightsGroup.cameraOffset.y},BUBBLE.PotsGroup.prototype.updateCollider=function(t){t.y=this.pots.y-t.height},BUBBLE.PotsGroup.prototype.updateLights=function(t){t.alpha=Math.max(0,t.alpha-.05)},BUBBLE.PotsGroup.prototype.checkCollision=function(t){var e=null;if(this.colliders.forEach((function(i){Phaser.Circle.intersectsRectangle(t.collCircle,i)&&(e=i)})),e){game.sfx["hit_"+game.rnd.between(1,3)].play(),t.x+=-t.velX,t.y+=-t.velY,t.collCircle.x=t.x,t.collCircle.y=t.y,Phaser.Circle.intersectsRectangle(t.collCircle,e)&&(t.x<e.centerX?t.x=Math.min(t.x,e.left-t.collCircle.radius):t.x=Math.max(t.x,e.right+t.collCircle.radius));var i=Math.max(BUBBLE.lnf(2.5),.75*game.math.distance(0,0,t.velX,t.velY)),s=game.math.angleBetween(e.centerX,e.centerY,t.x,t.y);t.velX=BUBBLE.utils.lengthdir_x(s,i,!0),t.velY=BUBBLE.utils.lengthdir_y(s,i,!0)}},BUBBLE.PotsGroup.prototype.processPopOutDestroyed=function(t){var e=this.whichPot(t);this.lightsGroup.children[e].alpha=1,this.emitLightParticles(e)},BUBBLE.PotsGroup.prototype.whichPot=function(t){var e=null;return this.potsRanges.forEach((function(i,s){t.x>=i[0]&&t.x<=i[1]&&(e=s)})),e},BUBBLE.PotsGroup.prototype.initLightsGroup=function(){this.lightsGroup=game.add.group(),this.lightsGroup.add(game.make.imageL(-242,90,"pot_light")),this.lightsGroup.add(game.make.imageL(-115,10,"pot_light")),this.lightsGroup.add(game.make.imageL(1,-10,"pot_light")),this.lightsGroup.add(game.make.imageL(115,10,"pot_light")),this.lightsGroup.add(game.make.imageL(241,90,"pot_light")),this.lightsGroup.fixedToCamera=!0,this.lightsGroup.forEach((function(t){t.anchor.setTo(.5,1),t.alpha=0}))},BUBBLE.PotsGroup.prototype.initColliders=function(){this.colliders=[],this.colliders.push(Phaser.RectangleL(0,0,18,56)),this.colliders.push(Phaser.RectangleL(148,0,6,56)),this.colliders.push(Phaser.RectangleL(264,0,9,43)),this.colliders.push(Phaser.RectangleL(375,0,9,43)),this.colliders.push(Phaser.RectangleL(494,0,6,56)),this.colliders.push(Phaser.RectangleL(627,0,18,56)),this.potsRanges=[],this.colliders.forEach((function(t,e,i){var s,o=t.centerX;0!=e&&(s=i[e-1].centerX,this.potsRanges.push([s,o]))}),this)},BUBBLE.PotsGroup.prototype.initParticlesEmitter=function(){this.particlesEmitter=game.add.emitter(0,0,30),this.particlesEmitter.makeParticles("ssheet","pot_light_particle"),this.particlesEmitter.setSize(0,0),this.particlesEmitter.setXSpeed(BUBBLE.l(-300),BUBBLE.l(300)),this.particlesEmitter.setYSpeed(BUBBLE.l(-1e3),BUBBLE.l(-300)),this.particlesEmitter.gravity=BUBBLE.l(1e3),this.particlesEmitter.setRotation(-30,30),this.particlesEmitter.setScale(1,1,1,1,0),this.particlesEmitter.setAlpha(1,0,800),this.particlesEmitter.fixedToCamera=!0},BUBBLE.PotsGroup.prototype.emitLightParticles=function(t){var e=.5*(this.potsRanges[t][0]+this.potsRanges[t][1]);this.particlesEmitter.emitX=e,this.particlesEmitter.explode(800,7)},BUBBLE.Preloader=function(t){},BUBBLE.Preloader.prototype={preload:function(){var t=BUBBLE.config.current;game.load.atlasJSONHash("ssheet","assets/"+t+"/spritesheets/spritesheet.png","assets/"+t+"/spritesheets/spritesheet.json"),game.load.atlasJSONHash("tutsheet","assets/"+t+"/spritesheets/tutsheet.png","assets/"+t+"/spritesheets/tutsheet.json"),game.load.atlasJSONHash("tutsheet2","assets/"+t+"/spritesheets/tutsheet2.png","assets/"+t+"/spritesheets/tutsheet2.json"),game.load.atlasJSONHash("bubblesheet","assets/"+t+"/spritesheets/bubblesheet.png","assets/"+t+"/spritesheets/bubblesheet.json"),game.load.atlasJSONHash("explosionsheet","assets/"+t+"/spritesheets/explosionsheet.png","assets/"+t+"/spritesheets/explosionsheet.json"),game.load.atlasJSONHash("shieldsheet","assets/"+t+"/spritesheets/shieldsheet.png","assets/"+t+"/spritesheets/shieldsheet.json"),game.load.bitmapFont("font","assets/"+t+"/fonts/font.png","assets/"+t+"/fonts/font.fnt"),game.load.bitmapFont("font-shadow","assets/"+t+"/fonts/font-shadow.png","assets/"+t+"/fonts/font-shadow.fnt"),game.load.bitmapFont("font-outline","assets/"+t+"/fonts/font-outline.png","assets/"+t+"/fonts/font-outline.fnt"),game.load.image("map_background","assets/"+t+"/images/map_background.jpg"),game.load.image("main_menu_backgr","assets/"+t+"/images/main_menu_backgr.jpg"),game.load.image("bg_middle","assets/"+t+"/images/bg_middle.png"),game.load.image("tuthand","assets/"+t+"/images/tuthand.png"),BUBBLE.assets.backgrounds.forEach((function(e){game.load.image(e,"assets/"+t+"/images/backgrounds/"+e+".jpg")})),BUBBLE.assets.maptiles.forEach((function(e){game.load.image(e,"assets/"+t+"/images/maptiles/"+e+".png")})),game.load.audio("cash_register","assets/sfx/cash_register.mp3"),game.load.audio("explosion_2","assets/sfx/explosion_2.mp3"),game.load.audio("hit_1","assets/sfx/hit_1.mp3"),game.load.audio("hit_2","assets/sfx/hit_2.mp3"),game.load.audio("hit_3","assets/sfx/hit_3.mp3"),game.load.audio("l_pop","assets/sfx/l_pop.mp3"),game.load.audio("launch_ball","assets/sfx/launch_ball.mp3"),game.load.audio("lose","assets/sfx/lose.mp3"),game.load.audio("music","assets/sfx/music.mp3"),game.load.audio("pop","assets/sfx/pop.mp3"),game.load.audio("booster","assets/sfx/booster.mp3"),game.load.audio("pot","assets/sfx/pot.mp3"),game.load.audio("whoosh","assets/sfx/whoosh.mp3"),game.load.audio("transition","assets/sfx/transition.mp3"),game.load.audio("win","assets/sfx/win.mp3"),game.load.audio("charge_up","assets/sfx/charge_up.mp3"),game.load.audio("charge_up2","assets/sfx/charge_up2.mp3"),game.load.audio("charge_up3","assets/sfx/charge_up3.mp3"),game.load.audio("charge_up4","assets/sfx/charge_up4.mp3"),game.load.audio("monster_ugh","assets/sfx/monster_ugh.mp3"),this.load.onFileComplete.add((function(t){sgSdk.trigger("loading.update",{progressPercentage:t})}))},create:function(){for(var t in BUBBLE.bg=new BUBBLE.Background,game.sfx={},game.sfx.cash_register=game.add.audio("cash_register"),game.sfx.explosion_2=game.add.audio("explosion_2"),game.sfx.hit_1=game.add.audio("hit_1"),game.sfx.hit_2=game.add.audio("hit_2"),game.sfx.hit_3=game.add.audio("hit_3"),game.sfx.pot=game.add.audio("pot"),game.sfx.pot.volume=.15,game.sfx.music=game.add.audio("music"),game.sfx.pop=game.add.audio("pop"),game.sfx.booster=game.add.audio("booster"),game.sfx.whoosh=game.add.audio("whoosh"),game.sfx.transition=game.add.audio("transition"),game.sfx.win=game.add.audio("win"),game.sfx.lose=game.add.audio("lose"),game.sfx.l_pop=game.add.audio("l_pop"),game.sfx.charge_up=game.add.audio("charge_up"),game.sfx.charge_up.volume=.2,game.sfx.charge_up2=game.add.audio("charge_up2"),game.sfx.charge_up2.volume=.2,game.sfx.charge_up3=game.add.audio("charge_up3"),game.sfx.charge_up3.volume=.2,game.sfx.charge_up4=game.add.audio("charge_up4"),game.sfx.charge_up4.volume=.2,game.sfx.monster_ugh=game.add.audio("monster_ugh"),game.sfx.launch_ball=game.add.audio("launch_ball"),game.sfx)if(game.sfx.hasOwnProperty(t)){var e=game.sfx[t];e.playNorm=e.play,e.play=function(){BUBBLE.saveState.data.mute||this.playNorm.apply(this,arguments)}}sgSdk.trigger("loading.completed",{callback:function(){BUBBLE.saveState.data.mute||game.sfx.music.play("",0,game.ie10?1:.3,!0),this.state.start("MainMenu")}},this)}},BUBBLE.Shooter=function(t){Phaser.Group.call(this,game),this.grid=t,this.lvl=t.lvl,this.random="random"==this.lvl.shooter.mode,this.pattern=this.lvl.shooter.pattern,this.patternIndex=0,this.possibleColors=this.grid.getAllColorsOnBoard(),this.moves=this.lvl.shooter.bubblesNumber,this.active=!0,this.lockInput=!1,this.gridOffset=BUBBLE.l(350),this.cameraOffset=BUBBLE.l(885),this.x=BUBBLE.l(320),this.ghostMode="Ghost"==this.lvl.mode,this.ghostMode?this.targetY=Math.max(this.cameraOffset,this.gridOffset):this.targetY=Math.max(this.cameraOffset,this.grid.getLowestBubble()*BUBBLE.l(51)+this.gridOffset),this.cameraY=this.targetY-this.cameraOffset,this.y=this.targetY,this.minX=BUBBLE.l(40),this.maxX=BUBBLE.l(600),this.minY=BUBBLE.l(30),this.flyingBubbleRadius=BUBBLE.l(10),this.showPointer=!1,this.aimAngle=0,this.pointerGroup=game.add.group();for(var e=0;e<30;e++){var i=game.add.image(320,50*e,"ssheet","aim_dot");i.anchor.setTo(.5,.5),this.pointerGroup.add(i)}this.baseBack=game.add.imageL(0,-40,"cannon_back"),this.baseBack.anchor.setTo(.5),this.cannon=game.add.image(0,0,"ssheet","cannon_idle"),this.cannon.anchor.setTo(.5,1),this.cannon.animating=!1,this.cannon.animIndex=0,this.cannon.animTimer=1,this.cannon.rotationTarget=0,this.windowBack=game.add.imageL(-30,-30,"cannon_windowBack"),this.duringAnimation=!1,this.chargeUpSfx={sfx:[game.sfx.charge_up,game.sfx.charge_up2,game.sfx.charge_up3,game.sfx.charge_up4],isPlaying:!1,play:function(){var t=this.sfx[game.rnd.between(0,3)];t.play(),this.isPlaying=t},stop:function(){this.isPlaying&&(this.isPlaying.stop(),this.isPlaying=!1)}},this.bubble0=game.add.imageL(0,0,"bubble_0"),this.bubble0.color="0",this.bubble0.anchor.setTo(.5),this.bubble1=game.add.imageL(75,0,"bubble_1"),this.bubble1.color="1",this.bubble1.anchor.setTo(.5),this.changeColorOfBubble(this.bubble0,this.getNextColor()),this.changeColorOfBubble(this.bubble1,this.getNextColor()),this.bubble0fade=game.add.imageL(0,0,"cannon_bubble_fade"),this.bubble0fade.anchor.setTo(.5),this.bubble1fade=game.add.imageL(75,0,"cannon_bubble_fade"),this.bubble1fade.anchor.setTo(.5),this.bubbleLight=game.add.imageL(0,0,null),this.bubbleLight.anchor.setTo(.5),this.baseFront=game.add.imageL(0,0,"cannon_front"),this.baseFront.anchor.setTo(.5),this.movesTxt=game.add.bitmapTextL(-70,-40,"font",this.moves.toString(),35),this.movesTxt.cacheAsBitmap=!0,this.movesTxt.anchor.setTo(.5),game.time.events.add(1,this.movesTxt.updateCache,this.movesTxt),this.lightsGroup=this.makeLightsGroup(),this.lightsGroup.bubbleLight=this.bubbleLight,this.swapButton=game.make.button(0,0,null,this.swapBubbles,this),this.swapButton.hitArea=new Phaser.Circle(0,0,BUBBLE.l(180)),this.add(this.swapButton),this.aimIcon=game.make.imageL(-250,0,"booster_aim"),this.aimIcon.anchor.setTo(.5,1),this.aimIcon.alpha=0,this.aimIcon.aPulse=.75,this.aimIcon.aPrime=0,game.add.tween(this.aimIcon).to({aPulse:1},300,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),this.addMultiple([this.baseBack,this.cannon,this.windowBack,this.bubble0,this.bubble1,this.bubble0fade,this.bubble1fade,this.bubbleLight,this.baseFront,this.lightsGroup,this.movesTxt,this.aimIcon]),this.touchYDeadZone=BUBBLE.l(140),this.inputRect={left:BUBBLE.l(-15),right:BUBBLE.l(655),topMargin:-game.world.bounds.y,bottom:this.y-this.touchYDeadZone},game.input.onUp.add((function(t){if(!this.lockInput&&this.checkIfInInputRect(t)){var e=game.math.angleBetween(this.x,this.y,t.worldX,t.worldY);this.shoot(e)}}),this),BUBBLE.events.onOpenBoosterStrip.add((function(){BUBBLE.horizontal||(this.inputRect.right=BUBBLE.l(460))}),this),BUBBLE.events.onCloseBoosterStrip.add((function(){this.inputRect.right=BUBBLE.l(640)}),this),BUBBLE.events.onScreenResize.add((function(){this.inputRect.topMargin=Math.min(BUBBLE.l(100),-game.world.bounds.y)}),this),BUBBLE.events.onMoveDone.add((function(t){this.possibleColors=t,this.checkCurrentColors()}),this),BUBBLE.events.onGoalAchieved.add((function(){this.active=!1}),this),BUBBLE.events.onWindowOpened.add((function(){this.lockInput=!0,this.swapButton.input.enabled=!1}),this),BUBBLE.events.onWindowClosed.add((function(){this.lockInput=!1,this.swapButton.input.enabled=!0}),this),this.movingPhase=1,this.aims=0,this.bomb=!1,this.multicolor=!1,BUBBLE.events.useOfbomb.add((function(){this.active&&"bomb"!=this.bubble0.color&&(game.sfx.booster.play(),BUBBLE.saveState.decreaseBooster("bomb"),this.bubble0.color="bomb",this.bubble0fade.alpha=1,this.bubble0.loadTexture("bubblesheet","bubble_"+this.bubble0.color))}),this),BUBBLE.events.useOfmulticolor.add((function(){this.active&&"multicolor"!=this.bubble0.color&&(game.sfx.booster.play(),BUBBLE.saveState.decreaseBooster("multicolor"),this.bubble0.color="multicolor",this.bubble0fade.alpha=1,this.bubble0.loadTexture("bubblesheet","bubble_"+this.bubble0.color))}),this),BUBBLE.events.useOfaim.add((function(){this.active&&(game.sfx.booster.play(),BUBBLE.saveState.decreaseBooster("aim"),this.aims+=BUBBLE.settings.numberOfAims)}),this),BUBBLE.events.useOfextraMoves.add((function(t){this.active&&(t||BUBBLE.saveState.decreaseBooster("extraMoves"),game.sfx.booster.play(),this.moves+=5,this.movesTxt.setText(this.moves.toString()),this.movesTxt.updateCache(),this.refill(),this.movesTxt.scale.setTo(1),game.add.tween(this.movesTxt.scale).to({x:1.3,y:1.3},250,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0))}),this)},BUBBLE.Shooter.prototype=Object.create(Phaser.Group.prototype),BUBBLE.Shooter.constructor=BUBBLE.Shooter,BUBBLE.Shooter.prototype.winUpdate=function(){BUBBLE.pause||(this.aimIcon.aPrime=game.math.clamp(this.aimIcon.aPrime+(this.aims>0?.03:-.03),0,1),this.aimIcon.alpha=this.aimIcon.aPrime*this.aimIcon.aPulse,this.bubble0fade.alpha=Math.max(0,this.bubble0fade.alpha-.05),this.bubble1fade.alpha=Math.max(0,this.bubble1fade.alpha-.05),this.moves>0&&(this.cannon.angle+=this.movingPhase,-1==this.movingPhase&&this.cannon.angle<-50?this.movingPhase=1:1==this.movingPhase&&this.cannon.angle>50&&(this.movingPhase=-1)),this.cannon.animating&&(this.cannon.animTimer--,0==this.cannon.animTimer&&(7==this.cannon.animIndex?(this.cannon.loadTexture("ssheet","cannon_idle"),this.cannon.animTimer=1,this.cannon.animIndex=0,this.cannon.animating=!1):(this.cannon.loadTexture("ssheet","cannon_shoot_"+this.cannon.animIndex),this.cannon.animIndex++,this.cannon.animTimer=2))),!this.cannon.animating&&this.moves>0&&this.shoot(10,!0))},BUBBLE.Shooter.prototype.update=function(){if(!BUBBLE.pause){if(this.cannon.animating&&(this.cannon.animTimer--,0==this.cannon.animTimer&&(7==this.cannon.animIndex?(this.cannon.loadTexture("ssheet","cannon_idle"),this.cannon.animTimer=1,this.cannon.animIndex=0,this.cannon.animating=!1):(this.cannon.loadTexture("ssheet","cannon_shoot_"+this.cannon.animIndex),this.cannon.animIndex++,this.cannon.animTimer=2))),this.updateTargetY(),this.yy=BUBBLE.utils.lerp(this.y,this.targetY,.02),this.y=Math.floor(this.yy),game.camera.y=this.y-this.cameraOffset+game.world.bounds.y,this.inputRect.bottom=this.y-this.touchYDeadZone,this.aimIcon.aPrime=game.math.clamp(this.aimIcon.aPrime+(this.aims>0?.03:-.03),0,1),this.aimIcon.alpha=this.aimIcon.aPrime*this.aimIcon.aPulse,this.bubble0fade.alpha=Math.max(0,this.bubble0fade.alpha-.05),this.bubble1fade.alpha=Math.max(0,this.bubble1fade.alpha-.05),!this.lockInput&&this.active&&!this.duringAnimation&&this.moves>0&&this.checkIfInInputRect(game.input.activePointer)){var t=game.math.angleBetween(this.x,this.y,game.input.activePointer.worldX,game.input.activePointer.worldY);this.cannon.rotationTarget=t+1.5708,this.cannon.rotation=BUBBLE.utils.lerp(this.cannon.rotation,this.cannon.rotationTarget,.2),game.input.activePointer.isDown&&this.lightsGroup.update(this.bubble0.color),(game.input.activePointer.isDown||game.device.desktop)&&this.aims>0&&(this.showPointer=!0,this.aimPointers(this.cannon.rotation-1.5708))}else this.chargeUpSfx.isPlaying&&this.chargeUpSfx.stop(),this.showPointer=!1,this.cannon.rotation=BUBBLE.utils.lerp(this.cannon.rotation,this.cannon.rotationTarget,.1),this.lightsGroup.turnOff();this.pointerGroup.visible=this.showPointer}},BUBBLE.Shooter.prototype.updateTargetY=function(){var t=1;return function(){0==--t&&(this.ghostMode?this.targetY=Math.max(this.cameraOffset,this.gridOffset):this.targetY=Math.max(this.cameraOffset,this.grid.getLowestBubble()*BUBBLE.l(51)+this.gridOffset),t=30)}}(),BUBBLE.Shooter.prototype.swapBubbles=function(){this.active&&null!==this.bubble0.color&&null!==this.bubble1.color&&!this.duringAnimation&&(this.duringAnimation=!0,game.sfx.whoosh.play(),game.add.tween(this.bubble0).to({x:this.bubble1.x,y:this.bubble1.y},500,Phaser.Easing.Sinusoidal.InOut,!0),game.add.tween(this.bubble1).to({x:this.bubble0.x,y:this.bubble0.y},500,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){var t;t=this.bubble0,this.bubble0=this.bubble1,this.bubble1=t,this.duringAnimation=!1}),this),this.bubble0.z<this.bubble1.z&&this.swap(this.bubble0,this.bubble1))},BUBBLE.Shooter.prototype.shoot=function(t,e){(e||this.active&&null!=this.bubble0.color&&!this.duringAnimation)&&(game.sfx.launch_ball.play(),this.chargeUpSfx.stop(),this.aims=Math.max(0,this.aims-1),BUBBLE.events.onBubbleShoot.dispatch(this.x,this.y,t,this.bubble0.color,e),this.cannon.animating=!0,"bomb"!=this.bubble0.color&&"multicolor"!=this.bubble0.color&&(this.moves--,this.movesTxt.setText(this.moves.toString()),this.movesTxt.updateCache()),this.bomb=!1,this.multicolor=!1,this.changeColorOfBubble(this.bubble0,this.bubble1.color),this.changeColorOfBubble(this.bubble1,this.getNextColor()),null!==this.bubble0.color&&(this.duringAnimation=!0,this.bubble0.x=BUBBLE.l(75),this.bubble0.y=BUBBLE.l(0),this.bubble1.x=BUBBLE.l(60),this.bubble1.y=BUBBLE.l(75),game.add.tween(this.bubble0).to({x:0,y:0},500,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.duringAnimation=!1}),this),game.add.tween(this.bubble1).to({x:BUBBLE.l(75),y:BUBBLE.l(0)},500,Phaser.Easing.Sinusoidal.InOut,!0).onComplete.add((function(){this.duringAnimation=!1}),this)))},BUBBLE.Shooter.prototype.getNextColor=function(){return this.active?this.moves<=1?null:!this.random&&this.pattern[this.patternIndex]?this.changeIfNotAvailable(this.pattern[this.patternIndex]):this.changeIfNotAvailable(game.rnd.between(0,5).toString()):game.rnd.between(0,4)},BUBBLE.Shooter.prototype.changeIfNotAvailable=function(t){t=t.toString();if(-1==this.possibleColors.indexOf(t)){var e=Math.floor(Math.random()*this.possibleColors.length);return this.possibleColors[e]}return t},BUBBLE.Shooter.prototype.changeColorOfBubble=function(t,e){this.active||(e="0"),t.color=e,null!==e?t.loadTexture("bubblesheet","bubble_"+e):t.loadTexture(null)},BUBBLE.Shooter.prototype.checkCurrentColors=function(){var t;0!=this.possibleColors.length&&("bomb"!=this.bubble0.color&&"multicolor"!=this.bubble0.color&&-1==this.possibleColors.indexOf(this.bubble0.color)&&null!==this.bubble0.color&&(t=Math.floor(Math.random()*this.possibleColors.length),this.changeColorOfBubble(this.bubble0,this.possibleColors[t]),this.bubble0fade.alpha=1),"bomb"!=this.bubble1.color&&"multicolor"!=this.bubble1.color&&-1==this.possibleColors.indexOf(this.bubble1.color)&&null!==this.bubble1.color&&(t=Math.floor(Math.random()*this.possibleColors.length),this.changeColorOfBubble(this.bubble1,this.possibleColors[t]),this.bubble1fade.alpha=1))},BUBBLE.Shooter.prototype.checkIfInInputRect=function(t){return t.worldX>this.inputRect.left&&t.worldX<this.inputRect.right&&t.worldY>game.camera.y+this.inputRect.topMargin&&t.worldY<this.inputRect.bottom},BUBBLE.Shooter.prototype.makeLightsGroup=function(){var t=game.add.group();return t.add(this.makeLight(15.5,-33.5,1)),t.add(this.makeLight(34,-15,43)),t.add(this.makeLight(34,14,90)),t.add(this.makeLight(16,32,132)),t.add(this.makeLight(-12,32,-179)),t.add(this.makeLight(-31,13.5,-137)),t.add(this.makeLight(-31,-15,-89)),t.add(this.makeLight(-12.5,-33.5,-46)),t.timer=7,t.lightsTurnOn=0,t.allActive=!1,t.update=function(t){var e;(this.timer++,this.timer%4==0&&this.lightsTurnOn<8)&&(1==this.lightsTurnOn&&this.parent.chargeUpSfx.play(),e="bomb"==t?"red":"multicolor"==t?"green":"yellow",this.bubbleLight.loadTexture("ssheet","cannon_innerlight_"+e),this.children[this.lightsTurnOn].visible=!0,this.children[this.lightsTurnOn].loadTexture("ssheet","cannon_booster_"+e),this.lightsTurnOn++,8==this.lightsTurnOn&&(this.allActive=!0));this.bubbleLight.alpha=Math.max(0,(this.timer-4)/24)},t.turnOff=function(){this.timer=0,this.lightsTurnOn=0,this.bubbleLight.alpha=0,this.allActive=!1,this.children[0].visible=!1,this.children[1].visible=!1,this.children[2].visible=!1,this.children[3].visible=!1,this.children[4].visible=!1,this.children[5].visible=!1,this.children[6].visible=!1,this.children[7].visible=!1},t},BUBBLE.Shooter.prototype.makeLight=function(t,e,i){var s=game.make.imageL(t,e,null);return s.angle=i,s.anchor.setTo(.5),s},BUBBLE.Shooter.prototype.refill=function(){null===this.bubble0.color&&this.changeColorOfBubble(this.bubble0,this.getNextColor()),null===this.bubble1.color&&this.changeColorOfBubble(this.bubble1,this.getNextColor())},BUBBLE.Shooter.prototype.shootAllRestInit=function(){this.update=this.winUpdate},BUBBLE.Shooter.prototype.aimPointers=function(t){for(var e=BUBBLE.utils.lengthdir_x(t,BUBBLE.l(10),!0),i=BUBBLE.utils.lengthdir_y(t,BUBBLE.l(10),!0),s=!0,o=null,a=this.x+BUBBLE.utils.lengthdir_x(this.cannon.rotation-1.5708,BUBBLE.l(160),!0),n=this.y+BUBBLE.utils.lengthdir_y(this.cannon.rotation-1.5708,BUBBLE.l(160),!0),h=0,r=0,l=0;l<150;l++){if(n+=i,(a+=e)<this.minX||a>this.maxX){var B=a<this.minX?this.minX-a:this.maxX-a;a=game.math.clamp(a,this.minX,this.maxX)+B,e*=-1}if(!(s&&this.grid.isSpaceFreePx(a,n)&&this.grid.isSpaceFreePx(a-this.flyingBubbleRadius,n)&&this.grid.isSpaceFreePx(a+this.flyingBubbleRadius,n)&&this.grid.isSpaceFreePx(a,n+this.flyingBubbleRadius)&&this.grid.isSpaceFreePx(a+this.flyingBubbleRadius,n-this.flyingBubbleRadius)&&n>0)){s=!1,o.visible=!1;break}if(r%4==0&&((o=this.pointerGroup.getChildAt(h)).x=a,o.y=n,o.visible=!0,30==++h))break;r++}for(var d=0;d<30;d++)(o=this.pointerGroup.getChildAt(d)).alpha=Math.max(0,(h-d)/h)},BUBBLE.TopFxLayer=function(t){Phaser.Group.call(this,game),this.grid=t,this.init(this.grid),BUBBLE.events.fxMatchParticle.add(this.initMatchParticle,this),BUBBLE.events.fxCloudParticle.add(this.initCloudParticle,this),BUBBLE.events.fxChameleonColorChange.add(this.initChameleonColorChange,this)},BUBBLE.TopFxLayer.prototype=Object.create(Phaser.Group.prototype),BUBBLE.TopFxLayer.constructor=BUBBLE.BottomFxLayer,BUBBLE.TopFxLayer.prototype.initCloudParticle=function(t){var e=this.getFirstDead();null!=e&&e.initCloudParticle(t)},BUBBLE.TopFxLayer.prototype.initMatchParticle=function(t){var e=this.getFirstDead();null!=e&&e.initMatchParticle(t)},BUBBLE.TopFxLayer.prototype.initChameleonColorChange=function(t){var e=this.getFirstDead();null!=e&&e.initChameleonColorChange(t)},BUBBLE.TopFxLayer.prototype.init=function(t){for(var e=0;e<30;e++)this.add(new BUBBLE.BubbleFx);t.ghostMode&&(this.childUpdate=function(t){t.update()},this.x=t.x,this.y=t.y,this.update=function(){this.rotation=this.grid.rotation,this.forEachAlive(this.childUpdate)})},BUBBLE.UI_BoosterStrip=function(t){Phaser.Group.call(this,game),this.fixedToCamera=!0,this.bg=game.make.imageL(0,0,"booster_pop_back"),this.bg.anchor.setTo(.5,0),this.add(this.bg),this.buttonsGroup=game.add.group(),this.add(this.buttonsGroup),this.pcsGroup=game.add.group(),this.add(this.pcsGroup),this.hidden=!0,this.horizontal=!1,this.makeBooster(85,"bomb"),this.makeBooster(200,"multicolor"),this.makeBooster(315,"aim"),this.makeBooster(430,"extraMoves"),BUBBLE.events.onWindowOpened.add(this.lockInput,this),BUBBLE.events.onWindowClosed.add(this.unlockInput,this),BUBBLE.events.onScreenResize.add(this.onResize,this),this.onResize()},BUBBLE.UI_BoosterStrip.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_BoosterStrip.constructor=BUBBLE.UI_BoosterStrip,BUBBLE.UI_BoosterStrip.prototype.lockInput=function(){this.buttonsGroup.forEach((function(t){t.input.enabled=!1}))},BUBBLE.UI_BoosterStrip.prototype.unlockInput=function(){this.buttonsGroup.forEach((function(t){t.input.enabled=!0}))},BUBBLE.UI_BoosterStrip.prototype.boosterSpriteLookUp={bomb:"booster_bomb",multicolor:"booster_multicolor",aim:"booster_aim",extraMoves:"booster_+five"},BUBBLE.UI_BoosterStrip.prototype.show=function(){this.cameraOffset.y=game.height-BUBBLE.l(690),this.hidden=!1,this.visible=!0,BUBBLE.events.onOpenBoosterStrip.dispatch()},BUBBLE.UI_BoosterStrip.prototype.hide=function(){this.cameraOffset.y=3e3,this.visible=!1,this.hidden=!0,BUBBLE.events.onCloseBoosterStrip.dispatch()},BUBBLE.UI_BoosterStrip.prototype.onResize=function(){this.horizontal=BUBBLE.horizontal,this.sliding=!this.horizontal,this.horizontal?(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(740),this.cameraOffset.y=BUBBLE.l(410),this.hidden=!1,this.visible=!0,BUBBLE.events.onOpenBoosterStrip.dispatch()):(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(560),this.cameraOffset.y=3e3,this.visible=!1,this.hidden=!0,BUBBLE.events.onCloseBoosterStrip.dispatch())},BUBBLE.UI_BoosterStrip.prototype.makeBooster=function(t,e){var i=new BUBBLE.Button(0,t,this.boosterSpriteLookUp[e],(function(){BUBBLE.saveState.getBooster(this.booster)>0?(BUBBLE.events["useOf"+this.booster].dispatch(),this.boosterPcs.refresh()):new BUBBLE.Window("shop")}));i.booster=e;var s=game.make.imageL(-60,t-35,"booster_pcs");s.anchor.setTo(.5),s.txt=game.make.bitmapTextL(0,-5,"font",BUBBLE.saveState.getBooster(e).toString(),35),s.booster=e,s.txt.anchor.setTo(.5),s.addChild(s.txt),s.refresh=function(){this.scale.setTo(1),game.add.tween(this.scale).to({x:1.3,y:1.3},200,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0),this.txt.setText(BUBBLE.saveState.getBooster(this.booster).toString())},i.boosterPcs=s,BUBBLE.events.onBoosterBought.add((function(t){this.booster==t&&this.refresh()}),s),this.buttonsGroup.add(i),this.pcsGroup.add(s)},BUBBLE.UI_GoalController=function(t){Phaser.Group.call(this,game),this.fixedToCamera=!0,this.goalState=0,this.goalTarget=t.goalTarget,this.bg=game.add.imageL(0,-20,"ui_goal"),this.bg.anchor.setTo(.5),this.goalLabelTxt=game.add.bitmapTextL(0,-75,"font-shadow",BUBBLE.txt("Goal")+":",50),this.goalLabelTxt.anchor.setTo(.5),this.goalLabelTxt.width=Math.min(this.goalLabelTxt.width,BUBBLE.l(270)),this.ico=game.make.imageL(0,10,"goalControllerIco_"+t.mode),this.ico.anchor.setTo(.5),this.goalTxt=game.add.bitmapTextL(0,5,"font-shadow",this.goalTarget+"/"+this.goalTarget,50),this.goalTxt.anchor.setTo(.5),this.goalLeftTxt=game.add.bitmapTextL(0,5,"font-shadow",this.goalTarget.toString(),40),this.goalLeftTxt.anchor.setTo(.5),this.goalTxt.setText("0/"+this.goalTarget),this.addMultiple([this.bg,this.goalLabelTxt,this.ico,this.goalTxt,this.goalLeftTxt]),BUBBLE.events.onScreenResize.add(this.resize,this),BUBBLE.events.onCellingChange.add(this.updateGoalState,this),BUBBLE.events.onGhostFree.add(this.updateGoalState,this),BUBBLE.events.onAnimalFree.add(this.updateGoalState,this),BUBBLE.events.onShieldDefeated.add(this.updateGoalState,this),BUBBLE.events.onGoalAchieved.add((function(){this.active=!1}),this),this.active=!0,this.resize(game.width,game.height)},BUBBLE.UI_GoalController.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_GoalController.constructor=BUBBLE.UI_GoalController,BUBBLE.UI_GoalController.prototype.updateGoalState=function(t){if(this.active){t="number"==typeof t?t:1;this.goalState=Math.min(this.goalTarget,this.goalState+t),this.goalTxt.setText(this.goalState+"/"+this.goalTarget),this.goalLeftTxt.setText((this.goalTarget-this.goalState).toString()),game.add.tween(this.goalTxt.scale).to({x:1.2,y:1.2},500,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0),game.add.tween(this.goalLeftTxt.scale).to({x:1.2,y:1.2},500,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0),this.goalState==this.goalTarget&&BUBBLE.events.onGoalAchieved.dispatch()}},BUBBLE.UI_GoalController.prototype.resize=function(t,e){if(BUBBLE.horizontal){this.bg.visible=!0,this.goalLabelTxt.visible=!0,this.cameraOffset.x=-game.world.bounds.x-BUBBLE.l(155),this.cameraOffset.y=BUBBLE.l(670),this.goalLeftTxt.visible=!1,this.goalTxt.visible=!0;var i=-.5*(this.ico.width+this.goalTxt.width+BUBBLE.l(30))+.5*this.ico.width;this.ico.x=i,this.goalTxt.x=this.ico.x+.5*this.ico.width+BUBBLE.l(30)+.5*this.goalTxt.width}else this.bg.visible=!1,this.goalLabelTxt.visible=!1,this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(450),this.cameraOffset.y=BUBBLE.l(35),this.goalTxt.visible=!1,this.goalLeftTxt.visible=!0,this.ico.x=0,this.goalLeftTxt.x=this.ico.x+.5*this.ico.width+BUBBLE.l(10)+.5*this.goalLeftTxt.width},BUBBLE.UI_LevelLabel=function(t){Phaser.Image.call(this,game,0,0,"ssheet","iu_lvl"),this.fixedToCamera=!0,this.anchor.setTo(.5),this.lvlNr=BUBBLE.levels.indexOf(t)+1,this.txt=game.add.bitmapTextL(0,-18,"font-shadow",BUBBLE.txt("Level")+" "+this.lvlNr,55),this.txt.x-=.5*this.txt.width,this.txt.y-=.5*this.txt.height,this.addChild(this.txt),this.txt.cacheAsBitmap=!0,this.updateAfterResize(game.width,game.height),BUBBLE.events.onScreenResize.add(this.updateAfterResize,this),game.add.existing(this)},BUBBLE.UI_LevelLabel.prototype=Object.create(Phaser.Image.prototype),BUBBLE.UI_LevelLabel.constructor=BUBBLE.UI_LevelLabel,BUBBLE.UI_LevelLabel.prototype.updateAfterResize=function(t,e){BUBBLE.horizontal?(this.revive(),this.cameraOffset.x=-game.world.bounds.x-BUBBLE.l(155),this.cameraOffset.y=BUBBLE.l(80)):this.kill()},BUBBLE.UI_LifeCoinBar=function(){Phaser.Group.call(this,game),this.bg=game.make.imageL(0,0,"window_lifecoinbar"),this.bg.anchor.setTo(.5,0),this.lifeIco=game.make.imageL(-180,34,"life_ico"),this.lifeIco.anchor.setTo(.5),this.lifeTxt=game.make.bitmapTextL(-50,12,"font",BUBBLE.saveState.getLives().toString(),40),this.lifeTxt.anchor.setTo(1,0),this.lifeTxtFade=game.make.bitmapTextL(-50,12,"font","","40"),this.lifeTxtFade.alpha=0,this.lifeTxtFade.anchor.setTo(.5),this.lifeAddButton=new BUBBLE.Button(-10,34,"button_plus",this.addLives,this),this.lifeAddButton.addTerm((function(){return BUBBLE.saveState.getLives()<BUBBLE.settings.maxLives})),this.coinIco=game.make.imageL(44,34,"coin_ico"),this.coinIco.anchor.setTo(.5),this.coinTxt=game.make.bitmapTextL(170,12,"font",BUBBLE.saveState.getCoins().toString(),40),this.coinTxt.anchor.setTo(1,0),this.coinTxtFade=game.make.bitmapTextL(170,12,"font","","40"),this.coinTxtFade.alpha=0,this.coinTxtFade.anchor.setTo(.5),this.coinAddButton=new BUBBLE.Button(190,34,"button_plus",this.addCoins,this),this.addMultiple([this.bg,this.lifeIco,this.lifeTxt,this.coinIco,this.coinTxt,this.lifeAddButton,this.coinAddButton,this.lifeTxtFade,this.coinTxtFade]),this.onResize(),BUBBLE.events.onScreenResize.add(this.onResize,this),BUBBLE.events.onCoinsChange.add(this.onMoneyChange,this),BUBBLE.events.onLivesChange.add(this.onLivesChange,this),BUBBLE.events.onWindowOpened.add((function(){this.coinAddButton.input.enabled=!1,this.lifeAddButton.input.enabled=!1}),this),BUBBLE.events.onWindowClosed.add((function(){this.coinAddButton.input.enabled=!0,this.lifeAddButton.input.enabled=!0}),this),this.coinsDisplayed=BUBBLE.saveState.getCoins(),this.coins=BUBBLE.saveState.getCoins(),this.maxLives=BUBBLE.saveState.getLives()==BUBBLE.settings.maxLives,this.maxLives&&(this.lifeAddButton.alpha=.5)},BUBBLE.UI_LifeCoinBar.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_LifeCoinBar.constructor=BUBBLE.UI_LifeCoinBar,BUBBLE.UI_LifeCoinBar.prototype.update=function(){this.coinsDisplayed!=this.coins&&(this.coinsDisplayed+=game.math.clamp(this.coins-this.coinsDisplayed,-1,1),this.coinTxt.setText(this.coinsDisplayed.toString())),this.lifeAddButton&&(this.lifeAddButton.alpha=this.maxLives?Math.max(.5,this.lifeAddButton.alpha-.03):Math.min(1,this.lifeAddButton.alpha+.03))},BUBBLE.UI_LifeCoinBar.prototype.addCoins=function(){new BUBBLE.Window("watchAdForCoins")},BUBBLE.UI_LifeCoinBar.prototype.addLives=function(){new BUBBLE.Window("watchAdForLives")},BUBBLE.UI_LifeCoinBar.prototype.onResize=function(){this.x=Math.floor(game.world.bounds.x+.5*game.width),this.y=game.world.bounds.y},BUBBLE.UI_LifeCoinBar.prototype.onLivesChange=function(t){this.startFade(this.lifeTxt,this.lifeTxtFade,t,(function(){this.lifeTxt.setText(BUBBLE.saveState.getLives().toString()),this.maxLives=BUBBLE.saveState.getLives()==BUBBLE.setting.maxLives}),this),game.add.tween(this.lifeIco.scale).to({x:1.3,y:1.3},300,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0)},BUBBLE.UI_LifeCoinBar.prototype.onMoneyChange=function(t){this.startFade(this.coinTxt,this.coinTxtFade,t,(function(){this.coins=BUBBLE.saveState.getCoins()}),this),game.add.tween(this.coinIco.scale).to({x:1.3,y:1.3},600,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0)},BUBBLE.UI_LifeCoinBar.prototype.startFade=function(t,e,i,s,o){var a;e.alpha=0,e.scale.setTo(1);var n=game.add.tween(e).to({alpha:1},500,Phaser.Easing.Sinusoidal.Out,!0,0,0,!0);game.add.tween(e.scale).to({x:1.3,y:1.3},500,Phaser.Easing.Sinusoidal.Out,!0,0,0,!0),i>0?(e.setText("+"+i),e.tint=65280,e.updateText(),e.y=t.y+80,a=t.y+.5*e.height,n.onComplete.add(s,o)):(e.setText(i.toString()),e.tint=16711680,e.updateText(),e.y=t.y+.5*e.height,a=t.y+80,s.call(o)),e.x=t.x-.5*e.width,game.add.tween(e).to({y:a},1e3,Phaser.Easing.Sinusoidal.Out,!0)},BUBBLE.UI_Money=function(t){Phaser.Group.call(this,game,0,0,"ssheet","iu_lvl"),this.fixedToCamera=!0,this.lvlNr=BUBBLE.levels.indexOf(t)+1,this.amountTxt=game.add.bitmapTextL(60,-8,"font-shadow",BUBBLE.saveState.getCoins().toString(),55),this.amountTxt.cacheAsBitmap=!0,this.amountTxt.anchor.setTo(1,.5),game.time.events.add(1,this.amountTxt.updateCache,this.amountTxt),this.amount=BUBBLE.saveState.getCoins(),this.amountTarget=this.amount,this.coinIco=game.add.image(this.amountTxt.x-this.amountTxt.width,0,"ssheet","coin"),this.coinIco.scale.setTo(.75),this.coinIco.anchor.setTo(1,.5),this.addCoin=new BUBBLE.Button(100,0,"btn_add",(function(){new BUBBLE.Window("needMoreMoney")})),this.addCoin.addTerm((function(){return 1==this.alpha}),this),this.add(this.coinIco),this.add(this.amountTxt),this.add(this.addCoin),this.updateAfterResize(game.width,game.height),BUBBLE.events.onScreenResize.add(this.updateAfterResize,this),BUBBLE.events.onWindowOpened.add((function(){this.input.enabled=!1}),this.addCoin),BUBBLE.events.onWindowClosed.add((function(){this.input.enabled=!0}),this.addCoin),BUBBLE.events.onCoinsChange.add((function(t){this.amountTarget=t}),this),game.incentivise||this.addCoin.destroy(),game.add.existing(this)},BUBBLE.UI_Money.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_Money.constructor=BUBBLE.UI_Money,BUBBLE.UI_Money.prototype.update=function(){this.amount!=this.amountTarget&&(this.amount+=game.math.clamp(this.amountTarget-this.amount,-1,1),this.amountTxt.setText(this.amount.toString()),this.amountTxt.updateCache(),this.coinIco.x=this.amountTxt.x-this.amountTxt.width)},BUBBLE.UI_Money.prototype.updateAfterResize=function(t,e){BUBBLE.horizontal?(this.visible=!0,this.amountTxt.updateCache(),this.cameraOffset.x=-game.world.bounds.x-BUBBLE.l(150),this.cameraOffset.y=BUBBLE.l(410)):(this.y=-999,this.visible=!1)},BUBBLE.UI_MoneyWindow=function(t){Phaser.Group.call(this,game,0,0),this.y=-BUBBLE.l(432),this.amountTxt=game.add.bitmapTextL(60,-8,"font-shadow",BUBBLE.saveState.getCoins().toString(),55),this.amountTxt.anchor.setTo(1,.5),this.amount=BUBBLE.saveState.getCoins(),this.amountTarget=this.amount,this.coinIco=game.add.imageL(this.amountTxt.x-this.amountTxt.width,0,"coin"),this.coinIco.scale.setTo(.75),this.coinIco.anchor.setTo(1,.5),BUBBLE.events.onScreenResize.add((function(){this.y=-BUBBLE.l(432)}),this),BUBBLE.events.onCoinsChange.add((function(t){this.amountTarget=t}),this)},BUBBLE.UI_MoneyWindow.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_MoneyWindow.constructor=BUBBLE.UI_MoneyWindow,BUBBLE.UI_MoneyWindow.prototype.update=function(){this.amount!=this.amountTarget&&(this.amount+=game.math.clamp(this.amountTarget-this.amount,-1,1),this.amountTxt.setText(this.amount.toString()))},BUBBLE.UI_PauseButtons=function(t){Phaser.Group.call(this,game),this.fixedToCamera=!0,this.pauseButton=new BUBBLE.Button(0,0,"btn_pause",(function(){new BUBBLE.Window("pause")}),this),this.boosterButton=new BUBBLE.Button(-30,880,"btn_booster",(function(){this.boosterStrip.hidden?(this.boosterStrip.show(),this.boosterButton.loadTexture("ssheet","btn_booster_back")):(this.boosterStrip.hide(),this.boosterButton.loadTexture("ssheet","btn_booster"))}),this),this.boosterStrip=new BUBBLE.UI_BoosterStrip,this.add(this.pauseButton),this.add(this.boosterButton),BUBBLE.events.onWindowOpened.add(this.lockInput,this),BUBBLE.events.onWindowClosed.add(this.unlockInput,this),BUBBLE.events.onScreenResize.add(this.onResize,this),this.onResize(game.width,game.height)},BUBBLE.UI_PauseButtons.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_PauseButtons.constructor=BUBBLE.UI_PauseButtons,BUBBLE.UI_PauseButtons.prototype.onResize=function(t,e){BUBBLE.horizontal?(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(700),this.cameraOffset.y=BUBBLE.l(50),this.boosterButton.exists=!1):(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(590),this.cameraOffset.y=BUBBLE.l(45),this.boosterButton.y=game.height-BUBBLE.l(170),this.boosterButton.exists=!0,this.boosterButton.loadTexture("ssheet","btn_booster"))},BUBBLE.UI_PauseButtons.prototype.lockInput=function(){this.forEach((function(t){t.input.enabled=!1}))},BUBBLE.UI_PauseButtons.prototype.unlockInput=function(){this.forEach((function(t){t.input.enabled=!0}))},BUBBLE.UI_PointsController=function(t){Phaser.Group.call(this,game),this.fixedToCamera=!0,this.points=0,this.pointsTarget=0,this.pointsTxt=game.add.bitmapTextL(0,0,"font-shadow","0",50),this.pointsTxt.cacheAsBitmap=!0,this.pointsTxt.anchor.setTo(.5),game.time.events.add(1,this.pointsTxt.updateCache,this.pointsTxt),this.combo=0,this.comboCondition=!1,this.initPointsGroup(),this.add(this.pointsTxt),this.potsRanges=t.potsRanges,this.whichPot=t.whichPot,this.potsPoints=[20,50,100,50,20],this.displayChangeMaxMin=5,this.pointsLights=[this.makePointsLight(0),this.makePointsLight(1),this.makePointsLight(2),this.makePointsLight(3),this.makePointsLight(4)],BUBBLE.events.onBubblesMatch.add(this.processMatch,this),BUBBLE.events.onPopOutDestroyed.add(this.processPopOut,this),BUBBLE.events.onScreenResize.add(this.updateAfterResize,this),BUBBLE.events.onMoveDone.add((function(){this.comboCondition?this.combo++:this.combo=0,this.comboCondition=!1}),this),BUBBLE.events.onGoalAchieved.add((function(){this.displayChangeMaxMin=20})),BUBBLE.events.onShooterMovesCountUp.add((function(t){t<=0||this.initPoints(BUBBLE.l(320),game.height-BUBBLE.l(200),100*t)}),this),BUBBLE.events.onBubblesMatch.add((function(){this.comboCondition=!0}),this),BUBBLE.events.onBubblesPopOut.add((function(){this.comboCondition=!0}),this),BUBBLE.events.onShieldDefeated.add((function(){this.comboCondition=!0}),this),this.updateAfterResize(game.width,game.height)},BUBBLE.UI_PointsController.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_PointsController.constructor=BUBBLE.UI_PointsController,BUBBLE.UI_PointsController.prototype.update=function(){this.points!=this.pointsTarget&&(this.points+=Math.min(this.pointsTarget-this.points,this.displayChangeMaxMin),this.pointsTxt.setText(this.points.toString()),this.pointsTxt.updateCache())},BUBBLE.UI_PointsController.prototype.processMatch=function(t){this.combo;var e=[];t.forEach((function(t,i){if(t){var s=t.getWorldPosition();e.push(new Phaser.Point(s[0],s[1]))}}),this);var i=Phaser.Point.centroid(e);this.initPoints(i.x,i.y,(10+5*this.combo)*t.length,0)},BUBBLE.UI_PointsController.prototype.processPopOut=function(t){var e=this.whichPot(t);this.initPointsLights(e)},BUBBLE.UI_PointsController.prototype.updateAfterResize=function(t,e){BUBBLE.horizontal?(this.cameraOffset.x=-game.world.bounds.x-BUBBLE.l(155),this.cameraOffset.y=BUBBLE.l(270),this.pointsTxt.fontSize=BUBBLE.l(50)):(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(310),this.cameraOffset.y=BUBBLE.l(40),this.pointsTxt.fontSize=BUBBLE.l(40)),this.pointsLights.forEach((function(t){t.updateAfterResize()}))},BUBBLE.UI_PointsController.prototype.initPointsGroup=function(){this.pointsGroup=game.add.group();for(var t=0;t<5;t++){var e=game.add.bitmapTextL(0,0,"font-outline","",60);e.anchor.setTo(.5),e.kill(),this.pointsGroup.add(e)}},BUBBLE.UI_PointsController.prototype.initPoints=function(t,e,i,s,o){this.pointsTarget+=i;var a=this.pointsGroup.getFirstDead();null!==a&&(a.scale.setTo(0),a.alpha=1,a.setText(i.toString()),a.x=t,a.y=e,a.revive(),game.add.tween(a.scale).to({x:1.5,y:1.5},800,Phaser.Easing.Quadratic.Out,!0,s),game.add.tween(a).to({alpha:0},800,Phaser.Easing.Sinusoidal.Out,!0,s).onComplete.add((function(){a.kill()})))},BUBBLE.UI_PointsController.prototype.initPointsLights=function(t){game.sfx.pot.play(),this.pointsTarget+=this.potsPoints[t],this.pointsLights[t].start()},BUBBLE.UI_PointsController.prototype.makePointsLight=function(t){var e=.5*(this.potsRanges[t][0]+this.potsRanges[t][1]),i=game.add.bitmapTextL(0,0,"font-outline",this.potsPoints[t].toString(),60);return i.anchor.setTo(.5),i.xx=e,i.fixedToCamera=!0,i.cameraOffset.x=-game.world.bounds.x+e,i.cameraOffset.y=game.height-BUBBLE.l(100),i.update=function(){this.alive&&(this.scale.setTo(this.scale.x+.05),this.alpha-=.03,this.alpha<=0&&this.kill())},i.start=function(){this.revive(),this.scale.setTo(0),this.alpha=1},i.updateAfterResize=function(){i.cameraOffset.x=-game.world.bounds.x+e,i.cameraOffset.y=game.height-BUBBLE.l(100)},i.kill(),i},BUBBLE.UI_StarController=function(t,e){Phaser.Group.call(this,game),this.fixedToCamera=!0,this.stars=0,this.starsReq=t.starsRequirements,this.barEmptyImg=game.make.imageL(0,0,"score_bar_back"),this.barFillImg=game.make.imageL(15,11,"score_bar"),this.cropRect=new Phaser.Rectangle(0,0,0,32),this.barFillImg.crop(this.cropRect),this.cropMaxWidth=BUBBLE.l(166),this.points=0,this.prevPoints=0;var i=BUBBLE.l(150)/this.starsReq[2],s=this.starsReq[2]/BUBBLE.l(150);this.pointsMax=Math.floor(BUBBLE.l(166)*s),this.starsGroup=game.make.group(),this.starMarkers=[null,null,null],this.starMarkers.forEach((function(t,e,s){s[e]=game.make.image(BUBBLE.l(15)+this.starsReq[e]*i,BUBBLE.l(48),"ssheet","score_star"),s[e].anchor.setTo(.5,1)}),this),this.addMultiple([this.barEmptyImg,this.barFillImg]),this.starsGroup.addMultiple(this.starMarkers),this.add(this.starsGroup),this.starsGroup.cacheAsBitmap=!0,this.updateAfterResize(),this.pointsController=e,BUBBLE.events.onScreenResize.add(this.updateAfterResize,this)},BUBBLE.UI_StarController.prototype=Object.create(Phaser.Group.prototype),BUBBLE.UI_StarController.constructor=BUBBLE.UI_StarController,BUBBLE.UI_StarController.prototype.update=function(){this.pointsController.points!=this.prevPoints&&(this.prevPoints=this.pointsController.points,this.cropRect.width=this.pointsController.points/this.pointsMax*this.cropMaxWidth,this.barFillImg.updateCrop())},BUBBLE.UI_StarController.prototype.updatePointsBar=function(t){this.pointsTarget=t},BUBBLE.UI_StarController.prototype.updateAfterResize=function(t,e){BUBBLE.horizontal?(this.cameraOffset.x=-game.world.bounds.x-BUBBLE.l(155)-.5*this.width,this.cameraOffset.y=BUBBLE.l(180)):(this.cameraOffset.x=-game.world.bounds.x+BUBBLE.l(10),this.cameraOffset.y=BUBBLE.l(15))},BUBBLE.Window=function(t){Phaser.Group.call(this,game),this.buttonsList=[],this.state=game.state.getCurrentState(),t.constructor===Array?this[t[0]].apply(this,t.slice(1)):this[t].apply(this,Array.prototype.slice.call(arguments,1)),game.add.tween(this.scale).from({x:2},300,Phaser.Easing.Sinusoidal.In,!0),game.add.tween(this).from({alpha:0},300,Phaser.Easing.Sinusoidal.In,!0),BUBBLE.events.onWindowOpened.dispatch(this),BUBBLE.events.onChangeLevel.add(this.lockInput,this),BUBBLE.pause=!0,this.ptype=t,"pause"===this.ptype&&game.sfx.music.pause()},BUBBLE.Window.prototype=Object.create(Phaser.Group.prototype),BUBBLE.Window.constructor=BUBBLE.Window,BUBBLE.Window.prototype.closeWindow=function(t,e){BUBBLE.pause=!1,this.lockInput(),game.add.tween(this.scale).to({x:2},300,Phaser.Easing.Quadratic.Out,!0),game.add.tween(this).to({alpha:0},300,Phaser.Easing.Sinusoidal.Out,!0).onComplete.add((function(){"pause"!==this.ptype||BUBBLE.saveState.data.mute||game.sfx.music.resume(),BUBBLE.events.onWindowClosed.dispatch(),this.destroy(),t&&t.call(e||!1)}),this)},BUBBLE.Window.prototype.addBackground=function(t){t=t||"window_bg";this.bg=game.make.imageL(-10,0,t),this.bg.anchor.setTo(.5),this.add(this.bg)},BUBBLE.Window.prototype.addCloseButton=function(t,e,i,s){i=i||!1,s=s||this;this.closeButton=new BUBBLE.Button(t||240,e||-200,"btn_exit",(function(){this.closeWindow(i,s)}),this),this.registerButtons(this.closeButton)},BUBBLE.Window.prototype.makeHomeButton=function(t,e){var i=new BUBBLE.Button(t,e,"btn_menu",(function(){game.sound.pauseAll(),sgSdk.trigger("beforePlayButtonDisplay",{callback:function(){BUBBLE.events.onChangeLevel.dispatch("MenuWorld"),game.sound.resumeAll()}},this)}));this.registerButtons(i)},BUBBLE.Window.prototype.makeReplayButton=function(t,e){var i=new BUBBLE.Button(t,e,"btn_replay",(function(){game.sound.pauseAll(),sgSdk.trigger("playButtonPressed",{callback:function(){BUBBLE.events.onChangeLevel.dispatch("Game",BUBBLE.currentLvlNr),game.sound.resumeAll()}},this)}));this.registerButtons(i)},BUBBLE.Window.prototype.makeOneLineText=function(t,e,i,s,o){var a=game.make.bitmapTextL(t,e,i,s.toString(),o);return a.width=Math.min(418*this.bg.scale.x,a.width),a.anchor.setTo(.5),this.add(a),a},BUBBLE.Window.prototype.registerButtons=function(t){for(var e=0;e<arguments.length;e++)this.buttonsList.push(arguments[e]),this.add(arguments[e])},BUBBLE.Window.prototype.lockInput=function(){this.buttonsList.forEach((function(t){t.input.enabled=!1}))},BUBBLE.Window.prototype.unlockInput=function(){this.buttonsList.forEach((function(t){t.input.enabled=!0}))},BUBBLE.Window.prototype.empty=function(){this.addBackground()},BUBBLE.Window.prototype.mainMenu=function(){this.playButton=new BUBBLE.Button(0,-80,"btn_play_big",(function(){BUBBLE.events.onChangeLevel.dispatch("MenuWorld")})),this.moreGamesButtton=new BUBBLE.Button(160,140,"btn_moregames",(function(){sgSdk.trigger("redirectToPortal")})),this.moreGamesButtton.visible=!1,this.soundButton=new BUBBLE.Button(0,140,BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on",(function(){BUBBLE.saveState.data.mute=!BUBBLE.saveState.data.mute,BUBBLE.saveState.save(),this.loadTexture("ssheet",BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on"),BUBBLE.saveState.data.mute?game.sound.stopAll():game.sfx.music.paused?game.sfx.music.resume():game.sfx.music.play("",0,game.ie10?1:.3,!0)})),this.registerButtons(this.playButton,this.moreGamesButtton,this.soundButton)},BUBBLE.Window.prototype.thanksForWatching=function(t){this.addBackground(),this.txt=new BUBBLE.MultiLineText(0,-110,"font",BUBBLE.txt("Thanks for watching!"),60,430,!1,"center"),this.add(this.txt),this.okButton=new BUBBLE.Button(0,200,"btn_yes",(function(){this.closeWindow()}),this),this.registerButtons(this.okButton)},BUBBLE.Window.prototype.gainedLives=function(){this.addBackground(),this.addCloseButton(200,-350,(function(){new BUBBLE.Window("addCoins",41)}))},BUBBLE.Window.prototype.pause=function(){this.addBackground(),this.soundButton=new BUBBLE.Button(-80,-100,BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on",(function(){BUBBLE.saveState.data.mute=!BUBBLE.saveState.data.mute,this.loadTexture("ssheet",BUBBLE.saveState.data.mute?"btn_sound_off":"btn_sound_on"),BUBBLE.saveState.save(),BUBBLE.saveState.data.mute?game.sound.stopAll():game.sfx.music.paused?game.sfx.music.resume():game.sfx.music.play("",0,game.ie10?1:.3,!0)}),this.soundButton),this.shopButton=new BUBBLE.Button(80,-100,"btn_shop",(function(){this.closeWindow((function(){new BUBBLE.Window("shop")}))}),this),this.makeReplayButton(160,100),this.makeHomeButton(-160,100),this.playButton=new BUBBLE.Button(0,100,"btn_play",(function(){sgSdk.trigger("interstitialAd",{callback:function(){this.closeWindow()}},this)}),this),this.registerButtons(this.playButton,this.soundButton,this.shopButton)},BUBBLE.Window.prototype.continueFor=function(){var t=!1;this.addBackground(),this.addMoneyUI(),this.forMoney=new BUBBLE.Button(0,-90,"btn_big_yellow",(function(){BUBBLE.saveState.getCoins()<BUBBLE.settings.priceOfContinue||(BUBBLE.saveState.changeCoins(-BUBBLE.settings.priceOfContinue),BUBBLE.events.useOfextraMoves.dispatch(!0),this.state.timer&&(this.state.timer.time+=30),this.closeWindow(),this.timerActive=!1)}),this),this.forMoney.greenTop=game.make.image(0,0,"ssheet","btn_big_green"),this.forMoney.greenTop.x=-.5*this.forMoney.greenTop.width,this.forMoney.greenTop.y=-.5*this.forMoney.greenTop.height,this.forMoney.greenTop.crop(new Phaser.Rectangle(0,0,this.forMoney.greenTop.width,this.forMoney.greenTop.height)),this.forMoney.addChild(this.forMoney.greenTop),this.forMoney.label=new BUBBLE.OneLineText(0,-30,"font",BUBBLE.txt("Continue for")+" "+BUBBLE.settings.priceOfContinue+"$$",40,390),this.forMoney.label.anchor.setTo(.5),this.forMoney.addChild(this.forMoney.label),BUBBLE.saveState.isEnoughToBuy(BUBBLE.settings.priceOfContinue)||(this.forMoney.input.enabled=!1,this.forMoney.greenTop.visible=!1),this.forWatching=new BUBBLE.Button(0,90,"btn_big_yellow",(function(){t=!0,0==BUBBLE.saveState.data.mute?(BUBBLE.saveState.data.mute=!0,musicFlag=1):musicFlag=0,sgSdk.trigger("rewardedAd",{callback:function(t){1==t?(BUBBLE.events.useOfextraMoves.dispatch(!0),this.state.timer&&(this.state.timer.time+=30),this.closeWindow((function(){new BUBBLE.Window("thanksForWatching")})),this.timerActive=!1):(this.closeWindow((function(){new BUBBLE.Window("gameOver")})),this.closeWindow((function(){new BUBBLE.Window("noMoreVideos")}))),musicFlag&&(BUBBLE.saveState.data.mute=!1)}},this)}),this),this.forWatching.greenTop=game.make.image(0,0,"ssheet","btn_big_green"),this.forWatching.greenTop.x=-.5*this.forMoney.greenTop.width,this.forWatching.greenTop.y=-.5*this.forMoney.greenTop.height,this.forWatching.greenTop.crop(new Phaser.Rectangle(0,0,this.forWatching.greenTop.width,this.forWatching.greenTop.height)),this.forWatching.addChild(this.forWatching.greenTop),this.forWatching.watchAdIco=game.add.image(0,0,"ssheet","movie_noarrow_icon"),this.forWatching.watchAdIco.anchor.setTo(.5),this.forWatching.addChild(this.forWatching.watchAdIco),this.forWatching.label=new BUBBLE.OneLineText(0,-30,"font",BUBBLE.txt("Continue for free"),40,390),this.forWatching.label.anchor.setTo(.5),this.forWatching.addChild(this.forWatching.label),this.registerButtons(this.forMoney,this.forWatching),game.incentivise||(this.forWatching.y=9999,this.forMoney.y+=BUBBLE.l(90)),this.timer=300,this.timerActive=!0,this.greenWidth=this.forMoney.greenTop.width,this.update=function(){this.amount!=this.amountTarget&&(this.amount+=game.math.clamp(this.amountTarget-this.amount,-1,1),this.amountTxt.setText(this.amount.toString()),this.coinIco.x=this.amountTxt.x-this.amountTxt.width),this.timerActive&&(this.timer--,this.forWatching.greenTop.cropRect.width=this.timer/300*this.greenWidth,this.forWatching.greenTop.updateCrop(),this.forMoney.greenTop.cropRect.width=this.timer/300*this.greenWidth,this.forMoney.greenTop.updateCrop(),0==this.timer&&0==t&&this.closeWindow((function(){new BUBBLE.Window("gameOver")})))}},BUBBLE.Window.prototype.gameOver=function(){this.addBackground(),game.sfx.lose.play(),this.makeOneLineText(0,-100,"font-outline",BUBBLE.txt("Game Over"),75),this.makeOneLineText(0,0,"font",BUBBLE.txt("score:")+" "+this.state.getScore(),55),this.makeReplayButton(-100,200),this.makeHomeButton(100,200)},BUBBLE.Window.prototype.tutorial=function(t,e){switch(this.addBackground(),this.bg.scale.setTo(1.1),this.tutImg=game.make.image(0,BUBBLE.l(-230),t>9?"tutsheet2":"tutsheet","tut_"+t),this.tutImg.anchor.setTo(.5,0),this.add(this.tutImg),this.txt=new BUBBLE.MultiLineText(0,40,"font",BUBBLE.txt(["Match 3 or more bubbles!","Clear top bubbles to reveal ceiling lights!","Clear bubbles around animals to free them!","Clear bubbles around the ghost to free him!","Match color of monster to defeat him!","Hit cloud bubble to reveal their true color!","Clear bubbles around rocks to remove them!","Ring bubbles change color after your every move!","Little monster creates new bubbles every 3 moves!","Black holes can devour 3 bubbles!","Need more moves? Use extra moves booster!","Aim booster helps you plan your moves!","Multicolor booster makes match with any color!","Bomb booster removes obstacles in your way!"][t]),"30",450,250),this.add(this.txt),this.okButton=new BUBBLE.Button(0,270,"btn_yes",(function(){e?this.closeWindow((function(){new BUBBLE.Window("tutorial",e)})):this.closeWindow()}),this),t){case"10":this.tutImg.scale.setTo(1.1),this.tutImg.y=BUBBLE.l(-300),this.tutImg.x=BUBBLE.l(-12);break;case"11":this.bg.scale.setTo(1.1,1.4),this.tutImg.scale.setTo(1.1),this.txt.y=BUBBLE.l(100),this.tutImg.y=BUBBLE.l(-380),this.okButton.y=BUBBLE.l(320);break;case"12":this.bg.scale.setTo(1.1,1.4),this.tutImg.y=BUBBLE.l(-330),this.txt.y=BUBBLE.l(90),this.okButton.y=BUBBLE.l(320),this.tutImg.x=BUBBLE.l(-14);break;case"13":this.bg.scale.setTo(1.1,1.4),this.tutImg.x=BUBBLE.l(-30),this.tutImg.y=BUBBLE.l(-370),this.tutImg.scale.setTo(1.2),this.txt.y=BUBBLE.l(90),this.okButton.y=BUBBLE.l(320)}this.registerButtons(this.okButton)},BUBBLE.Window.prototype.shop=function(){this.addBackground(),this.addMoneyUI(),this.makeOneLineText(0,-300,"font-outline",BUBBLE.txt("SHOP"),120),this.bg.scale.setTo(1.15),this.bg.cacheAsBitmap=!0,this.pcsGroup=game.add.group(),this.add(this.pcsGroup),this.makePowerUpButton(-190,-90,"bomb"),this.makePowerUpButton(-50,-90,"multicolor"),this.makePowerUpButton(90,-90,"aim"),this.makePowerUpButton(230,-90,"extraMoves"),this.okButton=new BUBBLE.Button(-100,130,"btn_yes",(function(){sgSdk.trigger("interstitialAd",{callback:function(){this.closeWindow()}},this)}),this),this.watchForMoreButton=new BUBBLE.Button(100,130,"btn_morecoins",(function(){this.closeWindow((function(){new BUBBLE.Window("needMoreMoney","shop")}))}),this),this.registerButtons(this.okButton,this.watchForMoreButton),game.incentivise||(this.watchForMoreButton.destroy(),this.okButton.x=0)},BUBBLE.Window.prototype.boosterSpriteLookUp={bomb:"booster_bomb",multicolor:"booster_multicolor",aim:"booster_aim",extraMoves:"booster_+five"},BUBBLE.Window.prototype.needMoreMoney=function(t){this.addBackground(),this.needMore=new BUBBLE.OneLineText(0,-120,"font",BUBBLE.txt("Need more $$?"),55,418),this.add(this.needMore),t?(this.addCloseButton(240,-200,(function(){new BUBBLE.Window(t)})),this.watchAdButton=new BUBBLE.Button(0,120,"btn_big_green",(function(){var e=t;0==BUBBLE.saveState.data.mute?(BUBBLE.saveState.data.mute=!0,musicFlag=1):musicFlag=0,sgSdk.trigger("rewardedAd",{callback:function(t){var i=e;1==t?this.closeWindow((function(){new BUBBLE.Window("youGained",i)})):this.closeWindow((function(){new BUBBLE.Window("noMoreVideos")})),musicFlag&&(BUBBLE.saveState.data.mute=!1)}},this)}),this)):(this.addCloseButton(),this.watchAdButton=new BUBBLE.Button(0,120,"btn_big_green",(function(){0==BUBBLE.saveState.data.mute?(BUBBLE.saveState.data.mute=!0,musicFlag=1):musicFlag=0,sgSdk.trigger("rewardedAd",{callback:function(t){1==t?this.closeWindow((function(){new BUBBLE.Window("youGained")})):this.closeWindow((function(){new BUBBLE.Window("noMoreVideos")})),musicFlag&&(BUBBLE.saveState.data.mute=!1)}},this)}),this));var e=game.make.imageL(-100,0,"movie_icon");e.scale.setTo(1.5),e.anchor.setTo(.5),this.watchAdButton.addChild(e);var i=new BUBBLE.OneLineText(70,0,"font",BUBBLE.settings.coinsForWatchingAd.toString()+"$$",60);i.y-=.7*i.height,this.watchAdButton.addChild(i),this.registerButtons(this.watchAdButton)},BUBBLE.Window.prototype.youGained=function(t){this.addBackground(),this.makeOneLineText(0,-110,"font",BUBBLE.txt("You gained"),60),this.amountTxt=new BUBBLE.OneLineText(0,-70,"font",BUBBLE.settings.coinsForWatchingAd+"$$",70,418),this.add(this.amountTxt),this.okButton=new BUBBLE.Button(0,120,"btn_yes",(function(){var e=t;BUBBLE.saveState.changeCoins(BUBBLE.settings.coinsForWatchingAd),e?this.closeWindow((function(){new BUBBLE.Window(e)})):this.closeWindow()}),this),this.registerButtons(this.okButton)},BUBBLE.Window.prototype.youGained=function(t){this.addBackground(),this.makeOneLineText(0,-110,"font",BUBBLE.txt("You gained"),60),this.amountTxt=new BUBBLE.OneLineText(0,-70,"font",BUBBLE.settings.coinsForWatchingAd+"$$",70,418),this.add(this.amountTxt),this.okButton=new BUBBLE.Button(0,120,"btn_yes",(function(){var e=t;BUBBLE.saveState.changeCoins(BUBBLE.settings.coinsForWatchingAd),e?this.closeWindow((function(){new BUBBLE.Window(e)})):this.closeWindow()}),this),this.registerButtons(this.okButton)},BUBBLE.Window.prototype.noMoreVideos=function(t){this.addBackground(),this.txt=new BUBBLE.MultiLineText(0,-110,"font",BUBBLE.txt("No more videos"),30,430,!1,"center"),this.add(this.txt),this.okButton=new BUBBLE.Button(0,120,"btn_yes",(function(){var e=t;e?this.closeWindow((function(){new BUBBLE.Window(e)})):this.closeWindow()}),this),this.registerButtons(this.okButton)},BUBBLE.Window.prototype.level=function(t){this.addBackground(),this.addCloseButton(),lvl=BUBBLE.levels[t];var e={Ghost:BUBBLE.txt("Free the ghost!"),Classic:BUBBLE.txt("Clear the top!"),Animals:BUBBLE.txt("Free all animals!"),Boss:BUBBLE.txt("Defeat the monster!")};this.lvlTxt=game.make.bitmapTextL(0,-180,"font-outline",BUBBLE.txt("Level")+" "+(t+1),70),this.lvlTxt.anchor.setTo(.5),this.modeTxt=game.make.bitmapTextL(0,-115,"font-outline",e[lvl.mode],30),this.modeTxt.anchor.setTo(.5),lvl=this.lvlTxt,m=this.modeTxt;for(var i=BUBBLE.saveState.getStars(t),s=[],o=0;o<3;o++){var a=game.make.imageL(130*o-130,1==o?-0:50,"win_star");a.anchor.setTo(.5),i-1>=o||(a.alpha=.3),s.push(a)}s.reverse(),this.addMultiple(s),this.playButton=new BUBBLE.Button(0,210,"btn_play",(function(){this.lockInput(),BUBBLE.events.onChangeLevel.dispatch("Game",t)}),this),this.addMultiple([this.lvlTxt,this.modeTxt]),this.registerButtons(this.playButton)},BUBBLE.Window.prototype.levelEnd=function(t){game.sfx.win.play(),this.particlesEmitter=game.add.emitter(0,0,45),this.particlesEmitter.makeParticles("ssheet","star_part"),this.particlesEmitter.setSize(0,0),this.particlesEmitter.setXSpeed(BUBBLE.l(-400),BUBBLE.l(400)),this.particlesEmitter.setYSpeed(BUBBLE.l(-500),0),this.particlesEmitter.gravity=BUBBLE.l(1e3),this.particlesEmitter.setRotation(-50,50),this.particlesEmitter.setScale(1,1,1,1,0),this.particlesEmitter.setAlpha(1,0,2e3),this.particlesEmitter.fixedToCamera=!0,this.light=game.make.imageL(0,0,"pot_light"),this.light.anchor.setTo(.5,1),this.light.scale.setTo(4),this.light.cacheAsBitmap=!0,this.light.alpha=0,this.add(this.light),this.teddy=game.make.image(0,.6*game.height,"teddy"),this.teddy.anchor.setTo(.5,0),this.add(this.teddy),this.addBackground();var e=BUBBLE.levels[BUBBLE.currentLvlNr],i=BUBBLE.currentLvlNr;this.bg.y+=BUBBLE.l(180),this.bg.scale.setTo(.9),this.bg.cahceAsBitmap=!0;var s=0,o=500;this.star=[];var a=this.state.getScore();sgSdk.trigger("levelFinished",{level:i+1,points:a}),e.starsRequirements.forEach((function(t,e){this.star[e]=game.add.imageL(110*e-110,1==e?-40:-10,"win_star"),this.star[e].anchor.setTo(.5),this.star[e].scale.setTo(0),game.add.tween(this.star[e].scale).to({x:1,y:1},500,Phaser.Easing.Elastic.Out,!0,o),o+=180,a>t||0==e?(s=e+1,game.time.events.add(o,(function(){this.particlesEmitter.emitX=BUBBLE.l(320)-BUBBLE.l(110)+e*BUBBLE.l(110),this.particlesEmitter.emitY=.5*game.height+(1==e?BUBBLE.l(-40):BUBBLE.l(-10)),this.particlesEmitter.explode(2e3,15),game.sfx.launch_ball.play()}),this)):this.star[e].alpha=.5}),this),this.addMultiple([this.star[2],this.star[1],this.star[0]]),this.youWinTxt=new BUBBLE.OneLineText(0,65,"font-outline",BUBBLE.txt("YOU WIN!"),90,376),this.add(this.youWinTxt),this.scoreTxt=this.makeOneLineText(0,230,"font",BUBBLE.txt("score:")+" "+a,60),this.scoreTxt.alpha=0;var n=t+BUBBLE.saveState.passLevel(i,s);n>0&&(this.youWinTxt.y-=BUBBLE.l(20),this.scoreTxt.y-=BUBBLE.l(30),this.coins=new BUBBLE.OneLineText(0,240,"font","+ "+n+" $$",50),this.add(this.coins),this.coins.alpha=0,game.add.tween(this.coins).to({alpha:1},500,Phaser.Easing.Sinusoidal.Out,!0,500)),i+1!=BUBBLE.levels.length?(this.makeHomeButton(-160,390),this.makeReplayButton(0,390),this.nextLevelButton=new BUBBLE.Button(160,390,"btn_play",(function(){game.sound.volume=0,sgSdk.trigger("playButtonPressed",{callback:function(){game.sound.volume=1,this.lockInput(),BUBBLE.events.onChangeLevel.dispatch("Game",i+1)}},this)}),this),this.nextLevelButton.visible=!1,sgSdk.trigger("beforePlayButtonDisplay",{callback:function(){this.nextLevelButton.visible=!0}},this),this.registerButtons(this.nextLevelButton)):(this.makeHomeButton(-100,390),this.makeReplayButton(100,390)),game.add.tween(this.light).to({alpha:.5},500,Phaser.Easing.Sinusoidal.Out,!0,500),game.add.tween(this.teddy).to({y:BUBBLE.l(-700)},1500,Phaser.Easing.Cubic.Out,!0,500).onComplete.add((function(){game.add.tween(this.teddy).to({y:this.teddy.y+50},2e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0)}),this),game.add.tween(this.scoreTxt).to({alpha:1},500,Phaser.Easing.Sinusoidal.Out,!0,500)},BUBBLE.Window.prototype.makePowerUpButton=function(t,e,i){var s=new BUBBLE.Button(t,e,this.boosterSpriteLookUp[i],(function(){BUBBLE.saveState.isEnoughToBuyBooster(this.booster)?(BUBBLE.saveState.buyBooster(this.booster),game.sfx.cash_register.play(),BUBBLE.events.onBoosterBought.dispatch(this.booster),9==BUBBLE.saveState.getBooster(this.booster)&&(this.input.enabled=!1,this.alpha=.5,this.price.alpha=.5,this.coin.alpha=.5),this.boosterPcs.refresh()):game.incentivise&&this.parent.closeWindow((function(){new BUBBLE.Window("needMoreMoney","shop")}))}));s.booster=i;var o=game.make.imageL(t-60,e-35,"booster_pcs");o.anchor.setTo(.5),o.txt=game.make.bitmapTextL(0,-5,"font",BUBBLE.saveState.getBooster(i).toString(),35),o.booster=i,o.txt.anchor.setTo(.5),o.addChild(o.txt),o.refresh=function(){this.scale.setTo(1),game.add.tween(this.scale).to({x:1.3,y:1.3},200,Phaser.Easing.Sinusoidal.InOut,!0,0,0,!0),this.txt.setText(BUBBLE.saveState.getBooster(this.booster).toString())},s.boosterPcs=o;var a=game.make.bitmapTextL(t,e+40,"font",BUBBLE.settings["costOf"+i].toString(),40),n=game.make.imageL(t,e+50,"coin");n.scale.setTo(.5);var h=BUBBLE.l(t)+-.5*(a.width+n.width);a.x=h,n.x=a.x+a.width,s.price=a,s.coin=n,this.registerButtons(s),this.add(a),this.add(n),this.pcsGroup.add(o),9==BUBBLE.saveState.getBooster(i)&&(s.input.enabled=!1,s.alpha=.5,a.alpha=.5,n.alpha=.5)},BUBBLE.Window.prototype.addMoneyUI=function(){this.amountTxt=game.add.bitmapTextL(310,-440,"font-shadow",BUBBLE.saveState.getCoins().toString(),55),this.amountTxt.anchor.setTo(1,.5),this.amount=BUBBLE.saveState.getCoins(),this.amountTarget=this.amount,this.coinIco=game.add.imageL(310,-432,"coin"),this.coinIco.x-=this.amountTxt.width,this.coinIco.scale.setTo(.75),this.coinIco.anchor.setTo(1,.5),BUBBLE.events.onCoinsChange.add((function(t){this.amountTarget=t}),this),this.add(this.amountTxt),this.add(this.coinIco),this.update=function(){this.amount!=this.amountTarget&&(this.amount+=game.math.clamp(this.amountTarget-this.amount,-1,1),this.amountTxt.setText(this.amount.toString()),this.coinIco.x=this.amountTxt.x-this.amountTxt.width)}},BUBBLE.WindowLayer=function(){this.fadeImg=game.add.image(0,0,"ssheet","window_shader"),this.fadeImg.fixedToCamera=!0,this.fadeImg.width=game.width,this.fadeImg.height=game.height,this.fadeImg.alpha=0,Phaser.Group.call(this,game),this.fixedToCamera=!0,this.resize(),this.prevLength=0,this.dispatch=!1,BUBBLE.events.onScreenResize.add(this.resize,this),BUBBLE.events.onWindowOpened.add(this.cacheWindow,this)},BUBBLE.WindowLayer.prototype=Object.create(Phaser.Group.prototype),BUBBLE.WindowLayer.constructor=BUBBLE.WindowLayer,BUBBLE.WindowLayer.prototype.resize=function(){this.cameraOffset.x=Math.floor(.5*game.width),this.cameraOffset.y=Math.floor(.5*game.height),this.fadeImg.cacheAsBitmap=!1,this.fadeImg.width=game.width,this.fadeImg.height=game.height,this.fadeImg.cacheAsBitmap=!0},BUBBLE.WindowLayer.prototype.update=function(){this.prevLength>0&&0==this.length&&(this.dispatch=!0),0==this.length?(this.fadeImg.alpha=Math.max(0,this.fadeImg.alpha-.05),this.dispatch&&0==this.fadeImg.alpha&&(BUBBLE.events.onWindowClosed.dispatch(this),this.dispatch=!1)):this.fadeImg.alpha=Math.min(1,this.fadeImg.alpha+.05),this.length>0&&this.children[0].update()},BUBBLE.WindowLayer.prototype.cacheWindow=function(t){this.add(t)},BUBBLE.WorldMap=function(t){this.bg=game.add.image(0,0,"map_background"),this.bg.anchor.setTo(.5,1),this.bg.scale.setTo(2),this.bg.cameraOffset.x=.5*game.width,this.bg.fixedToCamera=!0,Phaser.Group.call(this,game),this.x=.5*game.width,this.y=game.height,this.maptilesGroup=game.add.group(),BUBBLE.assets.maptiles.forEach((function(t,e){var i,s;BUBBLE.worlds[e]?(i=BUBBLE.l(BUBBLE.worlds[e][0]),s=BUBBLE.l(BUBBLE.worlds[e][1])):(i=0,s=-500);var o=game.make.image(i,s,t);o.anchor.setTo(.5,.5),this.maptilesGroup.add(o)}),this),this.add(this.maptilesGroup),this.mapPointHl=game.make.imageL(0,0,"mapPoint_hl"),this.add(this.mapPointHl),this.lvlButtonGroup=game.add.group(),this.add(this.lvlButtonGroup),this.initLvlButtons(),this.makeTeddy(BUBBLE.saveState.getLastLevel()),this.prevX=null,this.prevY=null,this.targetY=game.height,this.inputLocked=!1,this.resize(),this.centerOn(this.teddy),this.checkTimer=5,this.checkVisiblity(),BUBBLE.events.onScreenResize.add(this.resize,this),BUBBLE.events.onWindowOpened.add(this.disableInput,this),BUBBLE.events.onWindowClosed.add(this.enableInput,this)},BUBBLE.WorldMap.prototype=Object.create(Phaser.Group.prototype),BUBBLE.WorldMap.constructor=BUBBLE.WorldMap,BUBBLE.WorldMap.prototype.update=function(){!this.inputLocked&&game.input.activePointer.isDown?null===this.prevY?(this.prevY=game.input.activePointer.y,this.prevX=game.input.activePointer.x):(this.targetX-=3*(this.prevX-game.input.activePointer.x),this.targetY-=3*(this.prevY-game.input.activePointer.y),this.prevY=game.input.activePointer.y,this.prevX=game.input.activePointer.x):this.prevY=null,0==--this.checkTimer&&(this.checkTimer=5,this.checkVisiblity()),this.targetX=game.math.clamp(Math.floor(this.targetX),this.positionBounds.xMin,this.positionBounds.xMax),this.targetY=game.math.clamp(Math.floor(this.targetY),this.positionBounds.yMin,this.positionBounds.yMax+game.world.bounds.y),this.x=Math.floor(BUBBLE.utils.lerp(this.x,this.targetX,.05)),this.y=Math.floor(BUBBLE.utils.lerp(this.y,this.targetY,.05)),this.bg.cameraOffset.y=game.height-(game.height-this.bg.height)*((this.y-this.positionBounds.yMin)/(this.positionBounds.yMax-this.positionBounds.yMin))},BUBBLE.WorldMap.prototype.initLvlButtons=function(){BUBBLE.levels.forEach((function(t,e){var i=new BUBBLE.LevelButton(t.worldMapPosition,e,!!this.editorMode);this.lvlButtonGroup.add(i)}),this)},BUBBLE.WorldMap.prototype.getPositionForLevel=function(t,e){return[t-this.x,e-this.y]},BUBBLE.WorldMap.prototype.resize=function(){this.x=game.world.bounds.x+.5*game.width,this.bg.cameraOffset.x=.5*game.width;var t=game.world.bounds.x+.5*game.width;t=Math.floor(t);var e=Math.max(0,.5*(1.2*this.maptilesGroup.width-game.width));e=Math.floor(e),this.positionBounds={center:t,width:e,xMin:t-e,xMax:t+e,yMin:game.height,yMax:this.maptilesGroup.height+.8*Math.floor(this.maptilesGroup.height/this.maptilesGroup.length)},this.targetX=t,this.centerOn(this.teddy),this.checkVisiblity()},BUBBLE.WorldMap.prototype.disableInput=function(){this.lvlButtonGroup.forEach((function(t){t.input.enabled=!1})),this.inputLocked=!0},BUBBLE.WorldMap.prototype.enableInput=function(){this.lvlButtonGroup.forEach((function(t){t.locked||(t.input.enabled=!0)})),this.inputLocked=!1},BUBBLE.WorldMap.prototype.makeTeddy=function(t){this.teddy=game.make.imageL(0,0,"teddy"),this.teddy.scale.setTo(.3),this.teddy.anchor.setTo(.5,1),this.teddy.cacheAsBitmap=!0;var e=this.lvlButtonGroup.children[t];this.teddy.x=e.x,this.teddy.y=e.y-BUBBLE.l(50),this.mapPointHl.anchor.setTo(.5,.5),this.mapPointHl.x=e.x,this.mapPointHl.y=e.y,this.mapPointHl.alpha=.5,game.add.tween(this.mapPointHl).to({alpha:1},500,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),game.add.tween(this.teddy).to({y:e.y-BUBBLE.l(20)},2e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),this.add(this.teddy)},BUBBLE.WorldMap.prototype.centerOn=function(t){var e=game.world.bounds.x+.5*game.width;this.x=e-t.x,this.targetX=this.x,this.y=game.height-t.y-.5*game.height,this.targetY=this.y,this.x=game.math.clamp(Math.floor(this.x),this.positionBounds.xMin,this.positionBounds.xMax),this.y=game.math.clamp(Math.floor(this.y),this.positionBounds.yMin,this.positionBounds.yMax),this.targetX=game.math.clamp(Math.floor(this.targetX),this.positionBounds.xMin,this.positionBounds.xMax),this.targetY=game.math.clamp(Math.floor(this.targetY),this.positionBounds.yMin,this.positionBounds.yMax)},BUBBLE.WorldMap.prototype.checkVisiblity=function(){var t,e,i=-1*(this.y-1.3*game.height),s=i-1.3*game.height,o=this.maptilesGroup.length;for(t=0;t<o;t++)(e=this.maptilesGroup.children[t]).y-.5*e.height>i||e.y+.5*e.height<s?e.visible=!1:e.visible=!0;for(o=this.lvlButtonGroup.length,t=0;t<o;t++)(e=this.lvlButtonGroup.children[t]).y-.5*e.height>i||e.y+.5*e.height<s?e.visible=!1:e.visible=!0};